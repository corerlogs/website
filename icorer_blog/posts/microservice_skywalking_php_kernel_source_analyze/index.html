<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:image" content="https://res.cloudinary.com/malloc/image/upload/v1669271757/icorer.com/34047788_pepere.jpg"><title>微服务治理：APM-SkyWalking-PHP内核扩展源码分析 | 笔迹-工匠之芯</title><meta name=author content="LB"><meta name=description content="SkyWalking APM作为服务遥测的关键技术点，为了能够更好地运用这项技术，我们需要拥有把握这项技术的底层能力。目前公司在PHP领域存活不少业务系统，针对PHP领域的APM技术，我们首先从分析这款PHP内核扩展程序下手。
一. 总体架构PHP内核在php-fpm运行模式下是短生命周期，短生命周期的脚本运行如果直接连接SkyWalking的oap-server会造成大量的性能损耗，而且php也不擅长grpc通信，因此借助mesh架构思想为PHP-FPM进程池增加一个数据SideCar，主要的结构如下图所示： 从上图可以看出，PHP内核扩展程序拦截内核运行数据（主要是关键的外部IO调用）、数据被发送给SideCar，SideCar流转数据到SkyWalking-Server，数据流还可以被SkyWalking进行分析、从而通过WebHook流转报警时间到相关后续平台里。
二. PHP内核扩展源码分析针对目前开源社区的SkyWalking-PHP内核源码进行分析，源码的分析主要包括以下几部分：
工程结构分析 关键生命周期分析 关键运行函数Hook分析 2.1 工程结构分析SkyWalking PHP内核组件工程结构比较简单，主要是站在PHP内核基础上进行扩展设计与实现，主要包含的扩展文件有：
b64.h：base64编码函数的头文件、主要包含内存分配、base64字符表、b64_encode及b64_decode、b64_decode_ex的函数声明。 decode.c：base64序列化的函数具体实现。 encode.c：base64反序列化的函数具体实现。 components.h：针对skywalking协议中的component部分进行宏定义、这部分是apm协议的一部分，例如：tomcat、httpclient、dubbo、okhttp、grpc、jedis、更多查看附录1。 php_skywalking.h：关键的内核扩展声明部分，主要包括：APM协议宏定义、Redis指令类别、memcache指令类别、ContextCarrier上下文结构体、apm拦截所需的关键函数定义（具体见附录二），apm关键函数hook定义（具体见附录三），全局变量定义（具体见附录四）。 skywalking.c：具体内核扩展实现文件，里面包含了MI-MS、RI-RS、关键函数Hook等处理逻辑。 2.2 关键生命周期分析这块将针对内核扩展关键生命周期进行分析。
2.2.1 关键生命期函数Hook定义1static void (*ori_execute_ex)(zend_execute_data *execute_data); //PHP内核原始PHP层执行流程函数指针 2static void (*ori_execute_internal)(zend_execute_data *execute_data, zval *return_value);//PHP原始内核执行函数指针 3ZEND_API void sky_execute_ex(zend_execute_data *execute_data);//skywalking针对PHP层执行函数的替换指针 4ZEND_API void sky_execute_internal(zend_execute_data *execute_data, zval *return_value);//skywalking针对原始内核执行函数的替换指针 2.2.2 php.ini配置解析周期 1PHP_INI_BEGIN() 2#if SKY_DEBUG 3	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;1&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 4#else 5	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;0&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 6#endif 7	STD_PHP_INI_ENTRY(&#34;skywalking."><meta name=keywords content="blog,博客,工匠之芯,笔迹-工匠之芯"><meta name=twitter:card content="summary"><meta name=twitter:title content="微服务治理：APM-SkyWalking-PHP内核扩展源码分析"><meta name=twitter:description content="SkyWalking APM作为服务遥测的关键技术点，为了能够更好地运用这项技术，我们需要拥有把握这项技术的底层能力。目前公司在PHP领域存活不少业务系统，针对PHP领域的APM技术，我们首先从分析这款PHP内核扩展程序下手。
一. 总体架构PHP内核在php-fpm运行模式下是短生命周期，短生命周期的脚本运行如果直接连接SkyWalking的oap-server会造成大量的性能损耗，而且php也不擅长grpc通信，因此借助mesh架构思想为PHP-FPM进程池增加一个数据SideCar，主要的结构如下图所示： 从上图可以看出，PHP内核扩展程序拦截内核运行数据（主要是关键的外部IO调用）、数据被发送给SideCar，SideCar流转数据到SkyWalking-Server，数据流还可以被SkyWalking进行分析、从而通过WebHook流转报警时间到相关后续平台里。
二. PHP内核扩展源码分析针对目前开源社区的SkyWalking-PHP内核源码进行分析，源码的分析主要包括以下几部分：
工程结构分析 关键生命周期分析 关键运行函数Hook分析 2.1 工程结构分析SkyWalking PHP内核组件工程结构比较简单，主要是站在PHP内核基础上进行扩展设计与实现，主要包含的扩展文件有：
b64.h：base64编码函数的头文件、主要包含内存分配、base64字符表、b64_encode及b64_decode、b64_decode_ex的函数声明。 decode.c：base64序列化的函数具体实现。 encode.c：base64反序列化的函数具体实现。 components.h：针对skywalking协议中的component部分进行宏定义、这部分是apm协议的一部分，例如：tomcat、httpclient、dubbo、okhttp、grpc、jedis、更多查看附录1。 php_skywalking.h：关键的内核扩展声明部分，主要包括：APM协议宏定义、Redis指令类别、memcache指令类别、ContextCarrier上下文结构体、apm拦截所需的关键函数定义（具体见附录二），apm关键函数hook定义（具体见附录三），全局变量定义（具体见附录四）。 skywalking.c：具体内核扩展实现文件，里面包含了MI-MS、RI-RS、关键函数Hook等处理逻辑。 2.2 关键生命周期分析这块将针对内核扩展关键生命周期进行分析。
2.2.1 关键生命期函数Hook定义1static void (*ori_execute_ex)(zend_execute_data *execute_data); //PHP内核原始PHP层执行流程函数指针 2static void (*ori_execute_internal)(zend_execute_data *execute_data, zval *return_value);//PHP原始内核执行函数指针 3ZEND_API void sky_execute_ex(zend_execute_data *execute_data);//skywalking针对PHP层执行函数的替换指针 4ZEND_API void sky_execute_internal(zend_execute_data *execute_data, zval *return_value);//skywalking针对原始内核执行函数的替换指针 2.2.2 php.ini配置解析周期 1PHP_INI_BEGIN() 2#if SKY_DEBUG 3	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;1&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 4#else 5	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;0&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 6#endif 7	STD_PHP_INI_ENTRY(&#34;skywalking."><meta property="og:title" content="微服务治理：APM-SkyWalking-PHP内核扩展源码分析"><meta property="og:description" content="SkyWalking APM作为服务遥测的关键技术点，为了能够更好地运用这项技术，我们需要拥有把握这项技术的底层能力。目前公司在PHP领域存活不少业务系统，针对PHP领域的APM技术，我们首先从分析这款PHP内核扩展程序下手。
一. 总体架构PHP内核在php-fpm运行模式下是短生命周期，短生命周期的脚本运行如果直接连接SkyWalking的oap-server会造成大量的性能损耗，而且php也不擅长grpc通信，因此借助mesh架构思想为PHP-FPM进程池增加一个数据SideCar，主要的结构如下图所示： 从上图可以看出，PHP内核扩展程序拦截内核运行数据（主要是关键的外部IO调用）、数据被发送给SideCar，SideCar流转数据到SkyWalking-Server，数据流还可以被SkyWalking进行分析、从而通过WebHook流转报警时间到相关后续平台里。
二. PHP内核扩展源码分析针对目前开源社区的SkyWalking-PHP内核源码进行分析，源码的分析主要包括以下几部分：
工程结构分析 关键生命周期分析 关键运行函数Hook分析 2.1 工程结构分析SkyWalking PHP内核组件工程结构比较简单，主要是站在PHP内核基础上进行扩展设计与实现，主要包含的扩展文件有：
b64.h：base64编码函数的头文件、主要包含内存分配、base64字符表、b64_encode及b64_decode、b64_decode_ex的函数声明。 decode.c：base64序列化的函数具体实现。 encode.c：base64反序列化的函数具体实现。 components.h：针对skywalking协议中的component部分进行宏定义、这部分是apm协议的一部分，例如：tomcat、httpclient、dubbo、okhttp、grpc、jedis、更多查看附录1。 php_skywalking.h：关键的内核扩展声明部分，主要包括：APM协议宏定义、Redis指令类别、memcache指令类别、ContextCarrier上下文结构体、apm拦截所需的关键函数定义（具体见附录二），apm关键函数hook定义（具体见附录三），全局变量定义（具体见附录四）。 skywalking.c：具体内核扩展实现文件，里面包含了MI-MS、RI-RS、关键函数Hook等处理逻辑。 2.2 关键生命周期分析这块将针对内核扩展关键生命周期进行分析。
2.2.1 关键生命期函数Hook定义1static void (*ori_execute_ex)(zend_execute_data *execute_data); //PHP内核原始PHP层执行流程函数指针 2static void (*ori_execute_internal)(zend_execute_data *execute_data, zval *return_value);//PHP原始内核执行函数指针 3ZEND_API void sky_execute_ex(zend_execute_data *execute_data);//skywalking针对PHP层执行函数的替换指针 4ZEND_API void sky_execute_internal(zend_execute_data *execute_data, zval *return_value);//skywalking针对原始内核执行函数的替换指针 2.2.2 php.ini配置解析周期 1PHP_INI_BEGIN() 2#if SKY_DEBUG 3	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;1&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 4#else 5	STD_PHP_INI_BOOLEAN(&#34;skywalking.enable&#34;, &#34;0&#34;, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) //读取skywalking.enable配置项 6#endif 7	STD_PHP_INI_ENTRY(&#34;skywalking."><meta property="og:type" content="article"><meta property="og:url" content="https://icorer.com/icorer_blog/posts/microservice_skywalking_php_kernel_source_analyze/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-07T14:42:13+08:00"><meta property="article:modified_time" content="2020-09-07T14:42:13+08:00"><link rel=stylesheet href=/icorer_blog/css/bootstrap.min.css crossorigin=anonymous><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/icorer_blog/sass/main.css><link rel=stylesheet href=/icorer_blog/zoomjs/zoom.min.css><script src=/icorer_blog/js/lazysizes.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/icorer_blog/apple-touch-icon.png><link rel=icon type=image/ico sizes=16x16 href=/icorer_blog/img/favicon.ico><link rel=manifest href=/icorer_blog/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://icorer.com/icorer_blog/>笔迹-工匠之芯</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=https://icorer.com title=工匠之芯>工匠之芯</a></li><li><a href=https://icorer.com/icorer_about title=关于我>关于我</a></li><li><a href=https://github.com/gitsrc title=开源仓库>开源仓库</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/icorer_blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ title=微服务>微服务</a>
<a class=tag href=/icorer_blog/tags/php-kernel/ title="php kernel">php kernel</a>
<a class=tag href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E9%81%A5%E6%B5%8B/ title=服务遥测>服务遥测</a>
<a class=tag href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/ title=服务治理>服务治理</a>
<a class=tag href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E5%BC%80%E5%8F%91/ title=底层开发>底层开发</a></div><h1>微服务治理：APM-SkyWalking-PHP内核扩展源码分析</h1><h2 class=subheading></h2><span class=meta>Posted by LB
on Mon, Sep 7, 2020</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><figure><a class=paragraph-image><img data-src=https://icorer.com/icorer_blog/img/usr/uploads/2020/09/3654053617.png data-action=zoom alt class=lazyload></a></figure>SkyWalking APM作为服务遥测的关键技术点，为了能够更好地运用这项技术，我们需要拥有把握这项技术的底层能力。目前公司在PHP领域存活不少业务系统，针对PHP领域的APM技术，我们首先从分析这款PHP内核扩展程序下手。</p><h2 id=一-总体架构>一. 总体架构<a class=anchorjs-link href=#%e4%b8%80-%e6%80%bb%e4%bd%93%e6%9e%b6%e6%9e%84></a></h2><p>PHP内核在php-fpm运行模式下是短生命周期，短生命周期的脚本运行如果直接连接SkyWalking的oap-server会造成大量的性能损耗，而且php也不擅长grpc通信，因此借助mesh架构思想为PHP-FPM进程池增加一个数据SideCar，主要的结构如下图所示：<figure><a class=paragraph-image><img data-src=https://icorer.com/icorer_blog/img/usr/uploads/2020/09/3452179684.png data-action=zoom alt class=lazyload></a></figure>从上图可以看出，PHP内核扩展程序拦截内核运行数据（主要是关键的外部IO调用）、数据被发送给SideCar，SideCar流转数据到SkyWalking-Server，数据流还可以被SkyWalking进行分析、从而通过WebHook流转报警时间到相关后续平台里。</p><h2 id=二-php内核扩展源码分析>二. PHP内核扩展源码分析<a class=anchorjs-link href=#%e4%ba%8c-php%e5%86%85%e6%a0%b8%e6%89%a9%e5%b1%95%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90></a></h2><p>针对目前开源社区的SkyWalking-PHP内核源码进行分析，源码的分析主要包括以下几部分：</p><ol><li>工程结构分析</li><li>关键生命周期分析</li><li>关键运行函数Hook分析</li></ol><h3 id=21-工程结构分析>2.1 工程结构分析<a class=anchorjs-link href=#21-%e5%b7%a5%e7%a8%8b%e7%bb%93%e6%9e%84%e5%88%86%e6%9e%90></a></h3><p>SkyWalking PHP内核组件工程结构比较简单，主要是站在PHP内核基础上进行扩展设计与实现，主要包含的扩展文件有：</p><ol><li>b64.h：base64编码函数的头文件、主要包含内存分配、base64字符表、b64_encode及b64_decode、b64_decode_ex的函数声明。</li><li>decode.c：base64序列化的函数具体实现。</li><li>encode.c：base64反序列化的函数具体实现。</li><li>components.h：针对skywalking协议中的component部分进行宏定义、这部分是apm协议的一部分，例如：tomcat、httpclient、dubbo、okhttp、grpc、jedis、更多查看附录1。</li><li>php_skywalking.h：关键的内核扩展声明部分，主要包括：APM协议宏定义、Redis指令类别、memcache指令类别、ContextCarrier上下文结构体、apm拦截所需的关键函数定义（具体见附录二），apm关键函数hook定义（具体见附录三），全局变量定义（具体见附录四）。</li><li>skywalking.c：具体内核扩展实现文件，里面包含了MI-MS、RI-RS、关键函数Hook等处理逻辑。</li></ol><h3 id=22-关键生命周期分析>2.2 关键生命周期分析<a class=anchorjs-link href=#22-%e5%85%b3%e9%94%ae%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e5%88%86%e6%9e%90></a></h3><p>这块将针对内核扩展关键生命周期进行分析。</p><h4 id=221-关键生命期函数hook定义>2.2.1 关键生命期函数Hook定义<a class=anchorjs-link href=#221-%e5%85%b3%e9%94%ae%e7%94%9f%e5%91%bd%e6%9c%9f%e5%87%bd%e6%95%b0hook%e5%ae%9a%e4%b9%89></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>ori_execute_ex)(zend_execute_data <span style=color:#ff79c6>*</span>execute_data); <span style=color:#6272a4>//PHP内核原始PHP层执行流程函数指针
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>ori_execute_internal)(zend_execute_data <span style=color:#ff79c6>*</span>execute_data, zval <span style=color:#ff79c6>*</span>return_value);<span style=color:#6272a4>//PHP原始内核执行函数指针
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4></span>ZEND_API <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_execute_ex</span>(zend_execute_data <span style=color:#ff79c6>*</span>execute_data);<span style=color:#6272a4>//skywalking针对PHP层执行函数的替换指针
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span>ZEND_API <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_execute_internal</span>(zend_execute_data <span style=color:#ff79c6>*</span>execute_data, zval <span style=color:#ff79c6>*</span>return_value);<span style=color:#6272a4>//skywalking针对原始内核执行函数的替换指针
</span></span></span></code></pre></div><h4 id=222-phpini配置解析周期>2.2.2 php.ini配置解析周期<a class=anchorjs-link href=#222-phpini%e9%85%8d%e7%bd%ae%e8%a7%a3%e6%9e%90%e5%91%a8%e6%9c%9f></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>PHP_INI_BEGIN()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#if SKY_DEBUG
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6></span>	STD_PHP_INI_BOOLEAN(<span style=color:#f1fa8c>&#34;skywalking.enable&#34;</span>,   	<span style=color:#f1fa8c>&#34;1&#34;</span>, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals)  <span style=color:#6272a4>//读取skywalking.enable配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6></span>	STD_PHP_INI_BOOLEAN(<span style=color:#f1fa8c>&#34;skywalking.enable&#34;</span>,   	<span style=color:#f1fa8c>&#34;0&#34;</span>, PHP_INI_ALL, OnUpdateBool, enable, zend_skywalking_globals, skywalking_globals) <span style=color:#6272a4>//读取skywalking.enable配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>	STD_PHP_INI_ENTRY(<span style=color:#f1fa8c>&#34;skywalking.version&#34;</span>,   	<span style=color:#f1fa8c>&#34;8&#34;</span>, PHP_INI_ALL, OnUpdateLong, version, zend_skywalking_globals, skywalking_globals) <span style=color:#6272a4>//读取skywalking 版本配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    STD_PHP_INI_ENTRY(<span style=color:#f1fa8c>&#34;skywalking.app_code&#34;</span>, UNKNOW_SERVICE_NAME, PHP_INI_ALL, OnUpdateString, app_code, zend_skywalking_globals, skywalking_globals) <span style=color:#6272a4>//读取微服务-服务名配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    STD_PHP_INI_ENTRY(<span style=color:#f1fa8c>&#34;skywalking.app_code_env_key&#34;</span>, <span style=color:#f1fa8c>&#34;APM_APP_CODE&#34;</span>, PHP_INI_ALL, OnUpdateString, app_code_env_key, zend_skywalking_globals, skywalking_globals) <span style=color:#6272a4>//读取微服务-服务名环境变量 配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    STD_PHP_INI_ENTRY(<span style=color:#f1fa8c>&#34;skywalking.sock_path&#34;</span>, <span style=color:#f1fa8c>&#34;/tmp/sky-agent.sock&#34;</span>, PHP_INI_ALL, OnUpdateString, sock_path, zend_skywalking_globals, skywalking_globals) <span style=color:#6272a4>//读取微服务-agent通信unix路径配置项
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>PHP_INI_END()
</span></span></code></pre></div><h4 id=223-php内核模块初始化周期---mi周期>2.2.3 PHP内核模块初始化周期 - MI周期<a class=anchorjs-link href=#223-php%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97%e5%88%9d%e5%a7%8b%e5%8c%96%e5%91%a8%e6%9c%9f---mi%e5%91%a8%e6%9c%9f></a></h4><p>MI周期是PHP进程的模块加载周期，这个周期内部会逐个加载内核扩展，并调用内核扩展MI周期的函数Hook，APM内核扩展对于这块的处理逻辑如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>/* {{{ PHP_MINIT_FUNCTION
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>PHP_MINIT_FUNCTION (skywalking) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	ZEND_INIT_MODULE_GLOBALS(skywalking, php_skywalking_init_globals, <span style=color:#8be9fd;font-style:italic>NULL</span>); <span style=color:#6272a4>//初始化模块变量
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>	<span style=color:#6272a4>//data_register_hashtable();
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>	REGISTER_INI_ENTRIES();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>/* If you have INI entries, uncomment these lines
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>	*/</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (SKYWALKING_G(enable)) { <span style=color:#6272a4>//如果内核扩展功能开启了，则进行关键内核函数指针替换。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>//屏蔽php的cli运行模式的APM监控
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (strcasecmp(<span style=color:#f1fa8c>&#34;cli&#34;</span>, sapi_module.name) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> cli_debug <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#6272a4>// 用户自定义函数执行器(php脚本定义的类、函数)
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>        ori_execute_ex <span style=color:#ff79c6>=</span> zend_execute_ex; 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        zend_execute_ex <span style=color:#ff79c6>=</span> sky_execute_ex;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#6272a4>// 内部函数执行器(c语言定义的类、函数)
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span>        ori_execute_internal <span style=color:#ff79c6>=</span> zend_execute_internal;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        zend_execute_internal <span style=color:#ff79c6>=</span> sky_execute_internal;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>		<span style=color:#6272a4>// 托管curl内核函数：从zend函数表寻找内核函数、并使用内部的函数钩子进行拦截：自定函数钩子-&gt;exec、setopt、setopt_array、close
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>		zend_function <span style=color:#ff79c6>*</span>old_function;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>		<span style=color:#ff79c6>if</span> ((old_function <span style=color:#ff79c6>=</span> zend_hash_str_find_ptr(CG(function_table), <span style=color:#f1fa8c>&#34;curl_exec&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;curl_exec&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)) <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//替换curl_exec函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span>			orig_curl_exec <span style=color:#ff79c6>=</span> old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>			old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler <span style=color:#ff79c6>=</span> sky_curl_exec_handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>if</span> ((old_function <span style=color:#ff79c6>=</span> zend_hash_str_find_ptr(CG(function_table), <span style=color:#f1fa8c>&#34;curl_setopt&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;curl_setopt&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)) <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//替换curl_setopt函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4></span>            orig_curl_setopt <span style=color:#ff79c6>=</span> old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler <span style=color:#ff79c6>=</span> sky_curl_setopt_handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#ff79c6>if</span> ((old_function <span style=color:#ff79c6>=</span> zend_hash_str_find_ptr(CG(function_table), <span style=color:#f1fa8c>&#34;curl_setopt_array&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;curl_setopt_array&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)) <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//替换curl_setopt_array函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4></span>            orig_curl_setopt_array <span style=color:#ff79c6>=</span> old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler <span style=color:#ff79c6>=</span> sky_curl_setopt_array_handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>if</span> ((old_function <span style=color:#ff79c6>=</span> zend_hash_str_find_ptr(CG(function_table), <span style=color:#f1fa8c>&#34;curl_close&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;curl_close&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)) <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//替换curl_close函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4></span>            orig_curl_close <span style=color:#ff79c6>=</span> old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            old_function<span style=color:#ff79c6>-&gt;</span>internal_function.handler <span style=color:#ff79c6>=</span> sky_curl_close_handler;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#6272a4>/* }}} */</span>
</span></span></code></pre></div><h4 id=224-php内核请求初始化阶段---ri周期>2.2.4 PHP内核请求初始化阶段 - RI周期<a class=anchorjs-link href=#224-php%e5%86%85%e6%a0%b8%e8%af%b7%e6%b1%82%e5%88%9d%e5%a7%8b%e5%8c%96%e9%98%b6%e6%ae%b5---ri%e5%91%a8%e6%9c%9f></a></h4><p>这个周期是PHP进程针对每次PHP请求入口进行的周期设计，RI周期会针对每次PHP请求均会执行，也是PHP-FPM模式的短生命周期的根源，针对这块源码的解读如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>/* Remove if there&#39;s nothing to do at request start */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>/* {{{ PHP_RINIT_FUNCTION7
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>PHP_RINIT_FUNCTION(skywalking)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>#if defined(COMPILE_DL_SKYWALKING) &amp;&amp; defined(ZTS)
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>	ZEND_TSRMLS_CACHE_UPDATE();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>if</span> (SKYWALKING_G(enable)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>if</span> (strcasecmp(<span style=color:#f1fa8c>&#34;cli&#34;</span>, sapi_module.name) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> cli_debug <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        sky_register(); <span style=color:#6272a4>//向APM-Agent进行服务注册逻辑，这个逻辑仅仅当application_instance == 0条件下执行，
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        sky_increment_id<span style=color:#ff79c6>++</span>; <span style=color:#6272a4>//因为PHP-FPM进程是线程安全的，所以此处可以单调的递加，变量主要用于构建Trace-Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (sky_increment_id <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>9999</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            sky_increment_id <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        request_init(); <span style=color:#6272a4>//初始化当前请求的APM数据，里面进行初始上下文、创建Trace、Span信息，及必要的父子Trace关系
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>/* }}} */</span>
</span></span></code></pre></div><h4 id=225-php内核请求结束阶段---rs周期>2.2.5 PHP内核请求结束阶段 - RS周期<a class=anchorjs-link href=#225-php%e5%86%85%e6%a0%b8%e8%af%b7%e6%b1%82%e7%bb%93%e6%9d%9f%e9%98%b6%e6%ae%b5---rs%e5%91%a8%e6%9c%9f></a></h4><p>这个周期是PHP进程针对每次PHP请求结束进行的周期设计，RS周期会针对每次PHP请求的结束进行拦截，这个阶段一般进行内核资源回收操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>/* Remove if there&#39;s nothing to do at request end */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>/* {{{ PHP_RSHUTDOWN_FUNCTION
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>PHP_RSHUTDOWN_FUNCTION(skywalking)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#ff79c6>if</span>(SKYWALKING_G(enable)){
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (strcasecmp(<span style=color:#f1fa8c>&#34;cli&#34;</span>, sapi_module.name) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> cli_debug <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		    sky_flush_all();<span style=color:#6272a4>//发送APM数据给Agent程序
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)); <span style=color:#6272a4>//析构context hashtable、释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header));<span style=color:#6272a4>//析构curl_header hashtable、释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header_send));<span style=color:#6272a4>//析构curl_header_send hashtable、释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment));<span style=color:#6272a4>//析构UpstreamSegment hashtable、释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4>/* }}} */</span>
</span></span></code></pre></div><h2 id=三-关键运行函数hook分析>三. 关键运行函数Hook分析<a class=anchorjs-link href=#%e4%b8%89-%e5%85%b3%e9%94%ae%e8%bf%90%e8%a1%8c%e5%87%bd%e6%95%b0hook%e5%88%86%e6%9e%90></a></h2><p>除了PHP生命期的关键环节，APM主要就是针对关键IO进行监控，因为这些IO是外部调用依赖的关键，接下来会分析不同的函数Hook的具体实现：</p><h3 id=31-php用户态函数拦截>3.1 PHP用户态函数拦截<a class=anchorjs-link href=#31-php%e7%94%a8%e6%88%b7%e6%80%81%e5%87%bd%e6%95%b0%e6%8b%a6%e6%88%aa></a></h3><p>APM内核组件会对用户态函数进行执行拦截，通过拦截执行过程并构建APM需要的数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#6272a4>/* PHP 内核函数执行相关的核心内核数据结构
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4>    struct _zend_execute_data {
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#6272a4>    const zend_op       *opline;           executed opline                
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#6272a4>    zend_execute_data *call;  current call                   
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#6272a4>    zval *return_value;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#6272a4>    zend_function *func;  executed function             
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#6272a4>    zval This;           this + call_info + num_args    
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#6272a4>    zend_execute_data *prev_execute_data;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#6272a4>    zend_array *symbol_table;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#6272a4>    #if ZEND_EX_USE_RUN_TIME_CACHE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#6272a4>    void **run_time_cache;  cache op_array-&gt;run_time_cache 
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span><span style=color:#6272a4>    #endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4>    #if ZEND_EX_USE_LITERALS
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#6272a4>    zval *literals;  cache op_array-&gt;literals       
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#6272a4>    #endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#6272a4>    }
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#6272a4>// sky-apm 内核扩展注入的函数执行钩子 : 用户态函数拦截
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#6272a4></span>ZEND_API <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_execute_ex</span>(zend_execute_data <span style=color:#ff79c6>*</span>execute_data) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//如果当前请求周期不需要APM采集，则直接走原内核函数钩子
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#6272a4></span>        ori_execute_ex(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>    zend_function <span style=color:#ff79c6>*</span>zf <span style=color:#ff79c6>=</span> execute_data<span style=color:#ff79c6>-&gt;</span>func; <span style=color:#6272a4>//拦截执行的函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>class_name <span style=color:#ff79c6>=</span> (zf<span style=color:#ff79c6>-&gt;</span>common.scope <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> zf<span style=color:#ff79c6>-&gt;</span>common.scope<span style=color:#ff79c6>-&gt;</span>name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> ZSTR_VAL(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>            zf<span style=color:#ff79c6>-&gt;</span>common.scope<span style=color:#ff79c6>-&gt;</span>name) <span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>NULL</span>; <span style=color:#6272a4>//获取class名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>function_name <span style=color:#ff79c6>=</span> zf<span style=color:#ff79c6>-&gt;</span>common.function_name <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>:</span> ZSTR_VAL(zf<span style=color:#ff79c6>-&gt;</span>common.function_name); <span style=color:#6272a4>//获取function name
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>operationName <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>; <span style=color:#6272a4>//定义操作名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#8be9fd>int</span> componentId <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>//组件Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (class_name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>        <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Predis</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>Client&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;executeCommand&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>            <span style=color:#6272a4>// 检测predis组件的executeCommand函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#6272a4></span>            <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>            <span style=color:#ff79c6>if</span> (arg_count) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>                zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>                zval <span style=color:#ff79c6>*</span>id <span style=color:#ff79c6>=</span> (zval <span style=color:#ff79c6>*</span>) emalloc(<span style=color:#ff79c6>sizeof</span>(zval));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>                zend_call_method(p, Z_OBJCE_P(p), <span style=color:#8be9fd;font-style:italic>NULL</span>, ZEND_STRL(<span style=color:#f1fa8c>&#34;getid&#34;</span>), id, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>                <span style=color:#ff79c6>if</span> (Z_TYPE_P(id) <span style=color:#ff79c6>==</span> IS_STRING) { <span style=color:#6272a4>//构建predis函数类-&gt;函数方法的 操作名。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span><span style=color:#6272a4></span>                    operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(Z_STRVAL_P(id)) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>                    componentId <span style=color:#ff79c6>=</span> COMPONENT_JEDIS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>                    strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>                    strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>                    strcat(operationName, Z_STRVAL_P(id));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>                efree(id);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Grpc</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>BaseStub&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//拦截Grpc组件的关键方法。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;_simpleRequest&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;_clientStreamRequest&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;_serverStreamRequest&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;_bidiRequest&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>            ) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>                <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>                    componentId <span style=color:#ff79c6>=</span> COMPONENT_GRPC;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>                    componentId <span style=color:#ff79c6>=</span> COMPONENT_RPC;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>    <span style=color:#ff79c6>if</span> (operationName <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//如果操作名称不为空，证明成功拦截到函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#6272a4></span>        zval tags;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>      	<span style=color:#6272a4>//构建APM的tags属性，增加数据库类型、客户端组件类型
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Predis</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>Client&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;executeCommand&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, <span style=color:#f1fa8c>&#34;redis&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;predis&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>            zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>            zval <span style=color:#ff79c6>*</span>id <span style=color:#ff79c6>=</span> (zval <span style=color:#ff79c6>*</span>) emalloc(<span style=color:#ff79c6>sizeof</span>(zval));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>            zval <span style=color:#ff79c6>*</span>arguments <span style=color:#ff79c6>=</span> (zval <span style=color:#ff79c6>*</span>) emalloc(<span style=color:#ff79c6>sizeof</span>(zval));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>            zend_call_method(p, Z_OBJCE_P(p), <span style=color:#8be9fd;font-style:italic>NULL</span>, ZEND_STRL(<span style=color:#f1fa8c>&#34;getid&#34;</span>), id, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>            zend_call_method(p, Z_OBJCE_P(p), <span style=color:#8be9fd;font-style:italic>NULL</span>, ZEND_STRL(<span style=color:#f1fa8c>&#34;getarguments&#34;</span>), arguments, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>            <span style=color:#6272a4>// 丰富APM的predis的连接peer信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span><span style=color:#6272a4></span>            zval <span style=color:#ff79c6>*</span>connection <span style=color:#ff79c6>=</span> sky_read_property(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This),<span style=color:#f1fa8c>&#34;connection&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>            <span style=color:#ff79c6>if</span> (connection <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(connection) <span style=color:#ff79c6>==</span> IS_OBJECT <span style=color:#ff79c6>&amp;&amp;</span> strcmp(sky_get_class_name(connection), <span style=color:#f1fa8c>&#34;Predis</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>Connection</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>StreamConnection&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>                zval <span style=color:#ff79c6>*</span>parameters <span style=color:#ff79c6>=</span> sky_read_property(connection, <span style=color:#f1fa8c>&#34;parameters&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>                <span style=color:#ff79c6>if</span> (parameters <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(parameters) <span style=color:#ff79c6>==</span> IS_OBJECT <span style=color:#ff79c6>&amp;&amp;</span> strcmp(sky_get_class_name(parameters), <span style=color:#f1fa8c>&#34;Predis</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>Connection</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>Parameters&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>                    zval <span style=color:#ff79c6>*</span>parameters_arr <span style=color:#ff79c6>=</span> sky_read_property(parameters, <span style=color:#f1fa8c>&#34;parameters&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>                    <span style=color:#ff79c6>if</span> (Z_TYPE_P(parameters_arr) <span style=color:#ff79c6>==</span> IS_ARRAY) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>                        zval <span style=color:#ff79c6>*</span>predis_host <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(parameters_arr), <span style=color:#f1fa8c>&#34;host&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;host&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>                        zval <span style=color:#ff79c6>*</span>predis_port <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(parameters_arr), <span style=color:#f1fa8c>&#34;port&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;port&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>                        zval <span style=color:#ff79c6>*</span>port;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>                        ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>port, predis_port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>                        <span style=color:#ff79c6>if</span> (Z_TYPE_P(port) <span style=color:#ff79c6>!=</span> IS_LONG) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>                            convert_to_long(port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>                        <span style=color:#ff79c6>if</span> (Z_TYPE_P(predis_host) <span style=color:#ff79c6>==</span> IS_STRING <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(port) <span style=color:#ff79c6>==</span> IS_LONG) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>                            <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> ZSTR_VAL(Z_STR_P(predis_host));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>                            peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>                            bzero(peer, strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>                            sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%&#34;</span> PRId3264, host, Z_LVAL_P(port));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>            <span style=color:#6272a4>// peer end
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>            <span style=color:#ff79c6>if</span> (Z_TYPE_P(arguments) <span style=color:#ff79c6>==</span> IS_ARRAY) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>                zend_ulong num_key;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                zval <span style=color:#ff79c6>*</span>entry, str_entry;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                smart_str command <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, Z_STRVAL_P(id));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>                ZEND_HASH_FOREACH_NUM_KEY_VAL(Z_ARRVAL_P(arguments), num_key, entry)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>                        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>                            <span style=color:#ff79c6>switch</span> (Z_TYPE_P(entry)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>                                <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>IS_STRING</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>                                    smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, Z_STRVAL_P(entry));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>                                    smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>                                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>                                <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>IS_ARRAY</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>                                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>                                <span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>                                    ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>str_entry, entry);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>                                    convert_to_string(<span style=color:#ff79c6>&amp;</span>str_entry);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>                                    smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, Z_STRVAL_P(<span style=color:#ff79c6>&amp;</span>str_entry));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>                                    smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>                                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>                            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>                ZEND_HASH_FOREACH_END();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>                <span style=color:#6272a4>// store command to tags
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>if</span> (command.s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>                    smart_str_0(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;redis.command&#34;</span>, ZSTR_VAL(command.s));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                    smart_str_free(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>            zval_ptr_dtor(id);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>            zval_ptr_dtor(arguments);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>            efree(id);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>            efree(arguments);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Grpc</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>BaseStub&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;rpc.type&#34;</span>, <span style=color:#f1fa8c>&#34;grpc&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;php-grpc&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>            zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>            <span style=color:#ff79c6>if</span> (Z_TYPE_P(p) <span style=color:#ff79c6>==</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;rpc.method&#34;</span>, Z_STRVAL_P(p));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>            zval <span style=color:#ff79c6>*</span>hostname <span style=color:#ff79c6>=</span> sky_read_property(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This), <span style=color:#f1fa8c>&#34;hostname&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>            zval <span style=color:#ff79c6>*</span>hostname_override <span style=color:#ff79c6>=</span> sky_read_property(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This), <span style=color:#f1fa8c>&#34;hostname_override&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>            <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>            <span style=color:#ff79c6>if</span> (hostname_override <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(hostname_override) <span style=color:#ff79c6>==</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>                host <span style=color:#ff79c6>=</span> ZSTR_VAL(Z_STR_P(hostname_override));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>            } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (hostname <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(hostname) <span style=color:#ff79c6>==</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                host <span style=color:#ff79c6>=</span> ZSTR_VAL(Z_STR_P(hostname));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>            <span style=color:#ff79c6>if</span> (host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>                peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>                bzero(peer, strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>                sprintf(peer, <span style=color:#f1fa8c>&#34;%s&#34;</span>, host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>        zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>        zval <span style=color:#ff79c6>*</span>spans <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>        zval <span style=color:#ff79c6>*</span>span_id <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>        zval <span style=color:#ff79c6>*</span>last_span <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>l_millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>        <span style=color:#8be9fd>long</span> millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span>        spans <span style=color:#ff79c6>=</span> get_spans();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span>        last_span <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL_P(spans), zend_hash_num_elements(Z_ARRVAL_P(spans)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span>        span_id <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(last_span), <span style=color:#f1fa8c>&#34;spanId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;spanId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanId&#34;</span>, Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;startTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanType&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanLayer&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;componentId&#34;</span>, componentId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;operationName&#34;</span>, operationName);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;peer&#34;</span>, peer <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194</span><span>        efree(operationName);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195</span><span>        <span style=color:#ff79c6>if</span> (peer <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196</span><span>            efree(peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199</span><span>        ori_execute_ex(execute_data); <span style=color:#6272a4>//前面已经注入了APM原始数据、正式执行原函数钩子
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201</span><span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205</span><span>        add_assoc_zval(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;tags&#34;</span>, <span style=color:#ff79c6>&amp;</span>tags); <span style=color:#6272a4>//执行完后，注入请求监控的APM-tags
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206</span><span><span style=color:#6272a4></span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;endTime&#34;</span>, millisecond); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209</span><span>        zend_hash_next_index_insert(Z_ARRVAL_P(spans), <span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211</span><span>        ori_execute_ex(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213</span><span>}
</span></span></code></pre></div><h3 id=32-php内核态函数拦截>3.2 PHP内核态函数拦截<a class=anchorjs-link href=#32-php%e5%86%85%e6%a0%b8%e6%80%81%e5%87%bd%e6%95%b0%e6%8b%a6%e6%88%aa></a></h3><p>APM内核组件会对PHP内核态函数进行执行拦截，通过拦截执行过程并构建APM需要的数据，相关源码解释如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#6272a4>//PHP非用户态函数拦截：例如PHP内核、PHP其他内核扩展
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4></span>ZEND_API <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_execute_internal</span>(zend_execute_data <span style=color:#ff79c6>*</span>execute_data, zval <span style=color:#ff79c6>*</span>return_value) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>    <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>        <span style=color:#ff79c6>if</span> (ori_execute_internal) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>            ori_execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>            execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>    zend_function <span style=color:#ff79c6>*</span>zf <span style=color:#ff79c6>=</span> execute_data<span style=color:#ff79c6>-&gt;</span>func;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>class_name <span style=color:#ff79c6>=</span> (zf<span style=color:#ff79c6>-&gt;</span>common.scope <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> zf<span style=color:#ff79c6>-&gt;</span>common.scope<span style=color:#ff79c6>-&gt;</span>name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> ZSTR_VAL(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>            zf<span style=color:#ff79c6>-&gt;</span>common.scope<span style=color:#ff79c6>-&gt;</span>name) <span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>NULL</span>; <span style=color:#6272a4>//获取函数所属的class名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>function_name <span style=color:#ff79c6>=</span> zf<span style=color:#ff79c6>-&gt;</span>common.function_name <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>:</span> ZSTR_VAL(zf<span style=color:#ff79c6>-&gt;</span>common.function_name);<span style=color:#6272a4>//获取函数名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span> is_procedural_mysqli <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>// &#34;Procedural style&#34; or &#34;Object oriented style&#34; ?
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>operationName <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>component <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>    <span style=color:#8be9fd>int</span> componentId <span style=color:#ff79c6>=</span> COMPONENT_MYSQL_JDBC_DRIVER;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>    <span style=color:#ff79c6>if</span> (class_name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>        <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;PDO&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//拦截PDO类
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;exec&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;query&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;prepare&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>                <span style=color:#ff79c6>||</span> strcmp(function_name, <span style=color:#f1fa8c>&#34;commit&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;PDO&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;PDO&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>); <span style=color:#6272a4>//构建PDO操作名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span><span style=color:#6272a4></span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;PDOStatement&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//拦截PDOStatement类操作
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;execute&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;PDOStatement&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;PDOStatement&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>); <span style=color:#6272a4>//构建PDOStatement操作名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span><span style=color:#6272a4></span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;mysqli&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {<span style=color:#6272a4>//拦截mysqli类操作
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;query&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;mysqli&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;mysqli&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Yar_Client&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//拦截Yar_Client类操作
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;__call&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>                <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>                    componentId <span style=color:#ff79c6>=</span> COMPONENT_GRPC;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>                    componentId <span style=color:#ff79c6>=</span> COMPONENT_RPC;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;Yar_Client&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;Yar_Client&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>                <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>                <span style=color:#ff79c6>if</span> (arg_count) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>                    zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>                    <span style=color:#ff79c6>if</span> (Z_TYPE_P(p) <span style=color:#ff79c6>==</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>                        operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(Z_STRVAL_P(p)) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>                        strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>                        strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>                        strcat(operationName, Z_STRVAL_P(p));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Redis&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> strcmp(class_name, <span style=color:#f1fa8c>&#34;RedisCluster&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//拦截phpredis内核组件
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span><span style=color:#6272a4></span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fnamewall <span style=color:#ff79c6>=</span> sky_redis_fnamewall(function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>            <span style=color:#ff79c6>if</span> (sky_redis_opt_for_string_key(fnamewall) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>                componentId <span style=color:#ff79c6>=</span> COMPONENT_JEDIS;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;Redis&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;Redis&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>            efree(fnamewall);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Memcached&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {<span style=color:#6272a4>//拦截Memcached内核组件
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span><span style=color:#6272a4></span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fnamewall <span style=color:#ff79c6>=</span> sky_memcached_fnamewall(function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>            <span style=color:#ff79c6>if</span> (sky_memcached_opt_for_string_key(fnamewall) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>                componentId <span style=color:#ff79c6>=</span> COMPONENT_XMEMCACHED;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>                component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(<span style=color:#f1fa8c>&#34;memcached&#34;</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>                strcpy(component, <span style=color:#f1fa8c>&#34;memcached&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>                operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>                strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>                strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>                strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>            efree(fnamewall);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (function_name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;mysqli_query&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {<span style=color:#6272a4>//拦截mysqli_query函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span><span style=color:#6272a4></span>            class_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;mysqli&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>            function_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;query&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>            component <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>            strcpy(component, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>            operationName <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(class_name) <span style=color:#ff79c6>+</span> strlen(function_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>            strcpy(operationName, class_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>            strcat(operationName, <span style=color:#f1fa8c>&#34;-&gt;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>            strcat(operationName, function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>            is_procedural_mysqli <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>    <span style=color:#6272a4>//如果在控制范围内的函数行为
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (operationName <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>        zval tags;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;PDO&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {<span style=color:#6272a4>//丰富PDO span tags
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span><span style=color:#6272a4></span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-PDO&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>            <span style=color:#6272a4>// params
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span><span style=color:#6272a4></span>            <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>            <span style=color:#ff79c6>if</span> (arg_count) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>                zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>                <span style=color:#6272a4>//db.statement
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>switch</span> (Z_TYPE_P(p)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>                    <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>IS_STRING</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>                        add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.statement&#34;</span>, Z_STRVAL_P(p));<span style=color:#6272a4>//丰富PDO 查询语句
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span><span style=color:#6272a4></span>                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>            <span style=color:#8be9fd>char</span> db_type[<span style=color:#bd93f9>64</span>] <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>            pdo_dbh_t <span style=color:#ff79c6>*</span>dbh <span style=color:#ff79c6>=</span> Z_PDO_DBH_P(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>            <span style=color:#ff79c6>if</span> (dbh <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                <span style=color:#ff79c6>if</span> (dbh<span style=color:#ff79c6>-&gt;</span>driver <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                    memcpy(db_type, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name, dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name_len);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, db_type);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>                <span style=color:#ff79c6>if</span> (dbh<span style=color:#ff79c6>-&gt;</span>data_source <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> db_type[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.data_source&#34;</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>                    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> pcre_match(<span style=color:#f1fa8c>&#34;(host=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;(host=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>                    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>port <span style=color:#ff79c6>=</span> pcre_match(<span style=color:#f1fa8c>&#34;(port=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;(port=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>                    <span style=color:#ff79c6>if</span> (host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> port <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>                        peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>                        bzero(peer, strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>                        sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%s&#34;</span>, host, port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>                    <span style=color:#ff79c6>if</span> (host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) efree(host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>                    <span style=color:#ff79c6>if</span> (port <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) efree(port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;PDOStatement&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>            <span style=color:#8be9fd>char</span> db_type[<span style=color:#bd93f9>64</span>] <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>            pdo_stmt_t <span style=color:#ff79c6>*</span>stmt <span style=color:#ff79c6>=</span> (pdo_stmt_t <span style=color:#ff79c6>*</span>) Z_PDO_STMT_P(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>            <span style=color:#ff79c6>if</span> (stmt <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.statement&#34;</span>, stmt<span style=color:#ff79c6>-&gt;</span>query_string);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-PDO&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>                <span style=color:#ff79c6>if</span> (stmt<span style=color:#ff79c6>-&gt;</span>dbh <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>                    memcpy(db_type, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name, stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>driver<span style=color:#ff79c6>-&gt;</span>driver_name_len);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, db_type);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>                <span style=color:#ff79c6>if</span> (db_type[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> stmt<span style=color:#ff79c6>-&gt;</span>dbh <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>data_source <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.data_source&#34;</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>                    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> pcre_match(<span style=color:#f1fa8c>&#34;(host=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;(host=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>                    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>port <span style=color:#ff79c6>=</span> pcre_match(<span style=color:#f1fa8c>&#34;(port=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;(port=([^;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>s]+))&#34;</span>)<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) stmt<span style=color:#ff79c6>-&gt;</span>dbh<span style=color:#ff79c6>-&gt;</span>data_source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>                    <span style=color:#ff79c6>if</span> (host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> port <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>                        peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>                        bzero(peer, strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>                        sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%s&#34;</span>, host, port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span>                    <span style=color:#ff79c6>if</span> (host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) efree(host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span>                    <span style=color:#ff79c6>if</span> (port <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) efree(port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;mysqli&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;query&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span><span style=color:#ff79c6>#ifdef MYSQLI_USE_MYSQLND
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span><span style=color:#ff79c6></span>                mysqli_object <span style=color:#ff79c6>*</span>mysqli <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>                <span style=color:#ff79c6>if</span>(is_procedural_mysqli) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>                    mysqli <span style=color:#ff79c6>=</span> (mysqli_object <span style=color:#ff79c6>*</span>) Z_MYSQLI_P(ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span>                    mysqli <span style=color:#ff79c6>=</span> (mysqli_object <span style=color:#ff79c6>*</span>) Z_MYSQLI_P(<span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192</span><span>                MYSQLI_RESOURCE <span style=color:#ff79c6>*</span>my_res <span style=color:#ff79c6>=</span> (MYSQLI_RESOURCE <span style=color:#ff79c6>*</span>) mysqli<span style=color:#ff79c6>-&gt;</span>ptr;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193</span><span>                <span style=color:#ff79c6>if</span> (my_res <span style=color:#ff79c6>&amp;&amp;</span> my_res<span style=color:#ff79c6>-&gt;</span>ptr) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194</span><span>                    MY_MYSQL <span style=color:#ff79c6>*</span>mysql <span style=color:#ff79c6>=</span> (MY_MYSQL <span style=color:#ff79c6>*</span>) my_res<span style=color:#ff79c6>-&gt;</span>ptr;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195</span><span>                    <span style=color:#ff79c6>if</span> (mysql<span style=color:#ff79c6>-&gt;</span>mysql) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196</span><span><span style=color:#ff79c6>#if PHP_VERSION_ID &gt;= 70100
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197</span><span><span style=color:#ff79c6></span>                        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> mysql<span style=color:#ff79c6>-&gt;</span>mysql<span style=color:#ff79c6>-&gt;</span>data<span style=color:#ff79c6>-&gt;</span>hostname.s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199</span><span><span style=color:#ff79c6></span>                        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>host <span style=color:#ff79c6>=</span> mysql<span style=color:#ff79c6>-&gt;</span>mysql<span style=color:#ff79c6>-&gt;</span>data<span style=color:#ff79c6>-&gt;</span>host;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201</span><span><span style=color:#ff79c6></span>                        <span style=color:#8be9fd>char</span> port[<span style=color:#bd93f9>6</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202</span><span>                        <span style=color:#8be9fd>char</span> nullHost[<span style=color:#bd93f9>10</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;nullhost</span><span style=color:#f1fa8c>\0</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204</span><span>                        sprintf(port, <span style=color:#f1fa8c>&#34;%d&#34;</span>, mysql<span style=color:#ff79c6>-&gt;</span>mysql<span style=color:#ff79c6>-&gt;</span>data<span style=color:#ff79c6>-&gt;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205</span><span>                        add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.port&#34;</span>, port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206</span><span>                        <span style=color:#ff79c6>if</span>(host <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>){
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207</span><span>                            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.host&#34;</span>, host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208</span><span>                            peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)emalloc(strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209</span><span>                            bzero(peer, strlen(host) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210</span><span>                            sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%d&#34;</span>, host, mysql<span style=color:#ff79c6>-&gt;</span>mysql<span style=color:#ff79c6>-&gt;</span>data<span style=color:#ff79c6>-&gt;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211</span><span>                        }<span style=color:#ff79c6>else</span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212</span><span>                            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.host&#34;</span>, nullHost);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213</span><span>                            peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)emalloc(strlen(nullHost) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214</span><span>                            bzero(peer, strlen(nullHost) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215</span><span>                            sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%d&#34;</span>, nullHost, mysql<span style=color:#ff79c6>-&gt;</span>mysql<span style=color:#ff79c6>-&gt;</span>data<span style=color:#ff79c6>-&gt;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220</span><span><span style=color:#ff79c6></span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, <span style=color:#f1fa8c>&#34;mysql&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-mysqli&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222</span><span>                <span style=color:#6272a4>// params
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223</span><span><span style=color:#6272a4></span>                <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224</span><span>                <span style=color:#ff79c6>if</span> (arg_count) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225</span><span>                    zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> is_procedural_mysqli <span style=color:#ff79c6>?</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>:</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226</span><span>                    <span style=color:#6272a4>//db.statement
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227</span><span><span style=color:#6272a4></span>                    <span style=color:#ff79c6>switch</span> (Z_TYPE_P(p)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228</span><span>                        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>IS_STRING</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229</span><span>                            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.statement&#34;</span>, Z_STRVAL_P(p));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230</span><span>                            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Yar_Client&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236</span><span>            <span style=color:#ff79c6>if</span> (strcmp(function_name, <span style=color:#f1fa8c>&#34;__call&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237</span><span>                zval rv, _uri;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238</span><span>                ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>_uri, <span style=color:#f1fa8c>&#34;_uri&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239</span><span>                zval <span style=color:#ff79c6>*</span>yar_uri <span style=color:#ff79c6>=</span> Z_OBJ_HT(EX(This))<span style=color:#ff79c6>-&gt;</span>read_property(<span style=color:#ff79c6>&amp;</span>EX(This), <span style=color:#ff79c6>&amp;</span>_uri, BP_VAR_R, <span style=color:#bd93f9>0</span>, <span style=color:#ff79c6>&amp;</span>rv);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-Yar&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;yar.uri&#34;</span>, Z_STRVAL_P(yar_uri));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242</span><span>                <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243</span><span>                <span style=color:#ff79c6>if</span> (arg_count) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244</span><span>                    zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245</span><span>                    <span style=color:#ff79c6>if</span> (Z_TYPE_P(p) <span style=color:#ff79c6>==</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246</span><span>                        add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;yar.method&#34;</span>, Z_STRVAL_P(p));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Redis&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> strcmp(class_name, <span style=color:#f1fa8c>&#34;RedisCluster&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//丰富phpredis 操作span数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251</span><span><span style=color:#6272a4></span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, <span style=color:#f1fa8c>&#34;redis&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;phpredis&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">253</span><span>            <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">254</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">255</span><span>            <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Redis&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">256</span><span>                <span style=color:#6272a4>// find peer
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">257</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>(execute_data<span style=color:#ff79c6>-&gt;</span>This);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">258</span><span>                zval host;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">259</span><span>                zval port;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">260</span><span>                zend_call_method(<span style=color:#ff79c6>this</span>, Z_OBJCE_P(<span style=color:#ff79c6>this</span>), <span style=color:#8be9fd;font-style:italic>NULL</span>, ZEND_STRL(<span style=color:#f1fa8c>&#34;gethost&#34;</span>), <span style=color:#ff79c6>&amp;</span>host, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">261</span><span>                zend_call_method(<span style=color:#ff79c6>this</span>, Z_OBJCE_P(<span style=color:#ff79c6>this</span>), <span style=color:#8be9fd;font-style:italic>NULL</span>, ZEND_STRL(<span style=color:#f1fa8c>&#34;getport&#34;</span>), <span style=color:#ff79c6>&amp;</span>port, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">262</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">263</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">264</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>Z_ISUNDEF(host) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>Z_ISUNDEF(port) <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE(host) <span style=color:#ff79c6>==</span> IS_STRING <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE(port) <span style=color:#ff79c6>==</span> IS_LONG) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">265</span><span>                    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>h <span style=color:#ff79c6>=</span> ZSTR_VAL(Z_STR(host));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">266</span><span>                    peer <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(strlen(h) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">267</span><span>                    bzero(peer, strlen(h) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">268</span><span>                    sprintf(peer, <span style=color:#f1fa8c>&#34;%s:%&#34;</span> PRId3264, h, Z_LVAL(port));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">269</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">270</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">271</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>Z_ISUNDEF(host)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">272</span><span>                    zval_ptr_dtor(<span style=color:#ff79c6>&amp;</span>host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">273</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">274</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">275</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>Z_ISUNDEF(port)) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">276</span><span>                    zval_ptr_dtor(<span style=color:#ff79c6>&amp;</span>port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">277</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">278</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">279</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">280</span><span>            smart_str command <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">281</span><span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fname <span style=color:#ff79c6>=</span> zend_str_tolower_dup((<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) function_name, strlen((<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) function_name));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">282</span><span>            smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, fname);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">283</span><span>            smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">284</span><span>            efree(fname);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">285</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">286</span><span>            <span style=color:#8be9fd>int</span> is_string_command <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">287</span><span>            <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">288</span><span>            <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;</span> arg_count <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">289</span><span>                zval str_p;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">290</span><span>                zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, i);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">291</span><span>                <span style=color:#ff79c6>if</span> (Z_TYPE_P(p) <span style=color:#ff79c6>==</span> IS_ARRAY) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">292</span><span>                    is_string_command <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">293</span><span>                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">294</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">295</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">296</span><span>                ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>str_p, p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">297</span><span>                <span style=color:#ff79c6>if</span> (Z_TYPE_P(<span style=color:#ff79c6>&amp;</span>str_p) <span style=color:#ff79c6>!=</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">298</span><span>                    convert_to_string(<span style=color:#ff79c6>&amp;</span>str_p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">299</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">300</span><span>                <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">301</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;redis.key&#34;</span>, Z_STRVAL_P(<span style=color:#ff79c6>&amp;</span>str_p));<span style=color:#6272a4>//丰富phpredis key数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">302</span><span><span style=color:#6272a4></span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">303</span><span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>tmp <span style=color:#ff79c6>=</span> zend_str_tolower_dup(Z_STRVAL_P(<span style=color:#ff79c6>&amp;</span>str_p), Z_STRLEN_P(<span style=color:#ff79c6>&amp;</span>str_p));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">304</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, tmp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">305</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">306</span><span>                efree(tmp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">307</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">308</span><span>            <span style=color:#6272a4>// store command to tags
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">309</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (command.s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">310</span><span>                smart_str_0(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">311</span><span>                <span style=color:#ff79c6>if</span> (is_string_command) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">312</span><span>                    zend_string <span style=color:#ff79c6>*</span>trim_s <span style=color:#ff79c6>=</span> php_trim(command.s, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">313</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;redis.command&#34;</span>, ZSTR_VAL(trim_s));<span style=color:#6272a4>//丰富phpredis 指令数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">314</span><span><span style=color:#6272a4></span>                    zend_string_free(trim_s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">315</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">316</span><span>                smart_str_free(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">317</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">318</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (strcmp(class_name, <span style=color:#f1fa8c>&#34;Memcached&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">319</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">320</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;db.type&#34;</span>, <span style=color:#f1fa8c>&#34;memcached&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">321</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-Memcached&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">322</span><span>            <span style=color:#8be9fd>uint32_t</span> arg_count <span style=color:#ff79c6>=</span> ZEND_CALL_NUM_ARGS(execute_data);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">323</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">324</span><span>            smart_str command <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">325</span><span>            smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, zend_str_tolower_dup((<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) function_name, strlen((<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) function_name)));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">326</span><span>            smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">327</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">328</span><span>            <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">329</span><span>            <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;</span> arg_count <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">330</span><span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>str <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">331</span><span>                zval str_p;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">332</span><span>                zval <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> ZEND_CALL_ARG(execute_data, i);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">333</span><span>                <span style=color:#ff79c6>if</span> (Z_TYPE_P(p) <span style=color:#ff79c6>==</span> IS_ARRAY) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">334</span><span>                    str <span style=color:#ff79c6>=</span> sky_json_encode(p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">335</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">336</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">337</span><span>                ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>str_p, p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">338</span><span>                <span style=color:#ff79c6>if</span> (Z_TYPE_P(<span style=color:#ff79c6>&amp;</span>str_p) <span style=color:#ff79c6>!=</span> IS_ARRAY <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(<span style=color:#ff79c6>&amp;</span>str_p) <span style=color:#ff79c6>!=</span> IS_STRING) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">339</span><span>                    convert_to_string(<span style=color:#ff79c6>&amp;</span>str_p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">340</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">341</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">342</span><span>                <span style=color:#ff79c6>if</span> (str <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">343</span><span>                    str <span style=color:#ff79c6>=</span> Z_STRVAL_P(<span style=color:#ff79c6>&amp;</span>str_p);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">344</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">345</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">346</span><span>                <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">347</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;memcached.key&#34;</span>, str);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">348</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">349</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, zend_str_tolower_dup(str, strlen(str)));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">350</span><span>                smart_str_appends(<span style=color:#ff79c6>&amp;</span>command, <span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">351</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">352</span><span>            <span style=color:#6272a4>// store command to tags
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">353</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (command.s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">354</span><span>                smart_str_0(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">355</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;memcached.command&#34;</span>, ZSTR_VAL(php_trim(command.s, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>3</span>)));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">356</span><span>                smart_str_free(<span style=color:#ff79c6>&amp;</span>command);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">357</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">358</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">359</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">360</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">361</span><span>        zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">362</span><span>        zval <span style=color:#ff79c6>*</span>spans <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">363</span><span>        zval <span style=color:#ff79c6>*</span>span_id <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">364</span><span>        zval <span style=color:#ff79c6>*</span>last_span <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">365</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>l_millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">366</span><span>        <span style=color:#8be9fd>long</span> millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">367</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">368</span><span>        spans <span style=color:#ff79c6>=</span> get_spans();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">369</span><span>        last_span <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL_P(spans), zend_hash_num_elements(Z_ARRVAL_P(spans)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">370</span><span>        span_id <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(last_span), <span style=color:#f1fa8c>&#34;spanId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;spanId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">371</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">372</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanId&#34;</span>, Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">373</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">374</span><span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">375</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">376</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">377</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;startTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">378</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanType&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">379</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanLayer&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">380</span><span><span style=color:#6272a4>//        add_assoc_string(&amp;temp, &#34;component&#34;, component);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">381</span><span><span style=color:#6272a4></span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;componentId&#34;</span>, componentId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">382</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;operationName&#34;</span>, operationName);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">383</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;peer&#34;</span>, peer <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">384</span><span>        efree(component);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">385</span><span>        efree(operationName);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">386</span><span>        <span style=color:#ff79c6>if</span> (peer <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">387</span><span>            efree(peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">388</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">389</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">390</span><span>      <span style=color:#6272a4>//执行PHP内核原函数指针
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">391</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (ori_execute_internal) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">392</span><span>            ori_execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">393</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">394</span><span>            execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">395</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">396</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">397</span><span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">398</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">399</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">400</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">401</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">402</span><span>        add_assoc_zval(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;tags&#34;</span>, <span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">403</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;endTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">404</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>0</span>); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">405</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">406</span><span>        zend_hash_next_index_insert(Z_ARRVAL_P(spans), <span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">407</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">408</span><span>        <span style=color:#ff79c6>if</span> (ori_execute_internal) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">409</span><span>            ori_execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">410</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">411</span><span>            execute_internal(execute_data, return_value);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">412</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">413</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">414</span><span>}
</span></span></code></pre></div><h3 id=33-php-curl-内核hook拦截>3.3 PHP-CURL 内核Hook拦截<a class=anchorjs-link href=#33-php-curl-%e5%86%85%e6%a0%b8hook%e6%8b%a6%e6%88%aa></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#6272a4>//curl执行拦截
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_curl_exec_handler</span>(INTERNAL_FUNCTION_PARAMETERS)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>    <span style=color:#ff79c6>if</span>(application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>        orig_curl_exec(INTERNAL_FUNCTION_PARAM_PASSTHRU);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>	zval		<span style=color:#ff79c6>*</span>zid;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>	<span style=color:#ff79c6>if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span style=color:#f1fa8c>&#34;r&#34;</span>, <span style=color:#ff79c6>&amp;</span>zid) <span style=color:#ff79c6>==</span> FAILURE) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>	<span style=color:#8be9fd>int</span> is_send <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    zval function_name,curlInfo;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>    zval params[<span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>    ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>params[<span style=color:#bd93f9>0</span>], zid);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#6272a4>//执行curl_getinfo函数：
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#6272a4></span>    ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>function_name,  <span style=color:#f1fa8c>&#34;curl_getinfo&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>    call_user_function(CG(function_table), <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#ff79c6>&amp;</span>function_name, <span style=color:#ff79c6>&amp;</span>curlInfo, <span style=color:#bd93f9>1</span>, params); <span style=color:#6272a4>//从CG全局函数表、调用curl_getinfo函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span><span style=color:#6272a4></span>    zval_dtor(<span style=color:#ff79c6>&amp;</span>function_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    zval_dtor(<span style=color:#ff79c6>&amp;</span>params[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>    <span style=color:#6272a4>//获取curl请求的url信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span><span style=color:#6272a4></span>    zval <span style=color:#ff79c6>*</span>z_url <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(curlInfo),  ZEND_STRL(<span style=color:#f1fa8c>&#34;url&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>url_str <span style=color:#ff79c6>=</span> Z_STRVAL_P(z_url);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>    <span style=color:#ff79c6>if</span>(strlen(url_str) <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>curlInfo);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>        is_send <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>    <span style=color:#6272a4>//构建标准的HTTP URI结构
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#6272a4></span>    php_url <span style=color:#ff79c6>*</span>url_info <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    <span style=color:#ff79c6>if</span>(is_send <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>        url_info <span style=color:#ff79c6>=</span> php_url_parse(url_str); <span style=color:#6272a4>//解析
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span>(url_info<span style=color:#ff79c6>-&gt;</span>scheme <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>||</span> url_info<span style=color:#ff79c6>-&gt;</span>host <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>            zval_dtor(<span style=color:#ff79c6>&amp;</span>curlInfo);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>            php_url_free(url_info); <span style=color:#6272a4>//释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span><span style=color:#6272a4></span>            is_send <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>sw <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>    zval <span style=color:#ff79c6>*</span>spans <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>    zval <span style=color:#ff79c6>*</span>last_span <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>    zval <span style=color:#ff79c6>*</span>span_id <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>operation_name <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>full_url <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    <span style=color:#6272a4>//确定要发送的请求、当前请求合理，才进行下面的信息丰富。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (is_send <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span><span style=color:#6272a4>// for php7.3.0+
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>#if PHP_VERSION_ID &gt;= 70300
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span><span style=color:#ff79c6></span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_scheme <span style=color:#ff79c6>=</span> ZSTR_VAL(url_info<span style=color:#ff79c6>-&gt;</span>scheme);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_host <span style=color:#ff79c6>=</span> ZSTR_VAL(url_info<span style=color:#ff79c6>-&gt;</span>host);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_path <span style=color:#ff79c6>=</span> ZSTR_VAL(url_info<span style=color:#ff79c6>-&gt;</span>path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_query <span style=color:#ff79c6>=</span> ZSTR_VAL(url_info<span style=color:#ff79c6>-&gt;</span>query);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span><span style=color:#ff79c6></span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_scheme <span style=color:#ff79c6>=</span> url_info<span style=color:#ff79c6>-&gt;</span>scheme;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_host <span style=color:#ff79c6>=</span> url_info<span style=color:#ff79c6>-&gt;</span>host;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_path <span style=color:#ff79c6>=</span> url_info<span style=color:#ff79c6>-&gt;</span>path;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>php_url_query <span style=color:#ff79c6>=</span> url_info<span style=color:#ff79c6>-&gt;</span>query;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>        <span style=color:#6272a4>//处理url_info内部的被调用方端口值
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd>int</span> peer_port <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        <span style=color:#ff79c6>if</span> (url_info<span style=color:#ff79c6>-&gt;</span>port) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>            peer_port <span style=color:#ff79c6>=</span> url_info<span style=color:#ff79c6>-&gt;</span>port;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>            <span style=color:#ff79c6>if</span> (strcasecmp(<span style=color:#f1fa8c>&#34;http&#34;</span>, php_url_scheme) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>//默认端口设置
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#6272a4></span>                peer_port <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>80</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>                peer_port <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>443</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>        <span style=color:#6272a4>//处理url_info内部的query参数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (url_info<span style=color:#ff79c6>-&gt;</span>query){
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>            <span style=color:#ff79c6>if</span> (url_info<span style=color:#ff79c6>-&gt;</span>path <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>operation_name, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;/&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>full_url, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s?%s&#34;</span>, <span style=color:#f1fa8c>&#34;/&#34;</span>, php_url_query);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>operation_name, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, php_url_path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>full_url, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s?%s&#34;</span>, php_url_path, php_url_query);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>        <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>            <span style=color:#ff79c6>if</span> (url_info<span style=color:#ff79c6>-&gt;</span>path <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>operation_name, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;/&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>full_url, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;/&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>operation_name, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, php_url_path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>                spprintf(<span style=color:#ff79c6>&amp;</span>full_url, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s&#34;</span>, php_url_path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>        spans <span style=color:#ff79c6>=</span> get_spans(); <span style=color:#6272a4>//获取spans数组
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#6272a4></span>        last_span <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL_P(spans), zend_hash_num_elements(Z_ARRVAL_P(spans)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>); <span style=color:#6272a4>//获取最后一个span
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span><span style=color:#6272a4></span>        span_id <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(last_span), <span style=color:#f1fa8c>&#34;spanId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;spanId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>        <span style=color:#6272a4>//生成新的Trace-Span
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>        { <span style=color:#6272a4>// skywalking 5.x
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span><span style=color:#6272a4></span>            spprintf(<span style=color:#ff79c6>&amp;</span>peer, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s://%s:%d&#34;</span>, php_url_scheme, php_url_host, peer_port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>            sw <span style=color:#ff79c6>=</span> generate_sw3(Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, peer, operation_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>6</span> <span style=color:#ff79c6>||</span> SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>7</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>        { <span style=color:#6272a4>// skywalking 6.x
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span><span style=color:#6272a4></span>            spprintf(<span style=color:#ff79c6>&amp;</span>peer, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s:%d&#34;</span>, php_url_host, peer_port);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>            sw <span style=color:#ff79c6>=</span> generate_sw6(Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>            spprintf(<span style=color:#ff79c6>&amp;</span>peer, <span style=color:#bd93f9>0</span>, <span style=color:#f1fa8c>&#34;%s:%d&#34;</span>, php_url_host, peer_port); <span style=color:#6272a4>//
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span><span style=color:#6272a4></span>            sw <span style=color:#ff79c6>=</span> generate_sw8(Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, peer); <span style=color:#6272a4>//生成version 8的span
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span><span style=color:#6272a4></span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span><span style=color:#6272a4>     sw6_l = snprintf(NULL, 0, &#34;sw8: 1-%s-%s-%&#34; PRId3264 &#34;-%s-%s-%s-%s&#34;,
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span><span style=color:#6272a4>            Z_STRVAL(traceIdEncode),
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span><span style=color:#6272a4>            Z_STRVAL(currentTraceIdEncode),
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span><span style=color:#6272a4>            span_id,
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span><span style=color:#6272a4>            Z_STRVAL(serviceEncode),
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span><span style=color:#6272a4>            Z_STRVAL(serviceInstanceEncode),
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span><span style=color:#6272a4>            Z_STRVAL(parentEndpointEncode),
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span><span style=color:#6272a4>            Z_STRVAL(targetAddressEncode));
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span><span style=color:#6272a4>    */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>    <span style=color:#6272a4>//如果span创建成功 : sw结构样例：
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//sw8: 1-MS41NDY0LjE1OTg1MDU3ODEwMDAx-MS41NDY0LjE1OTg1MDU3ODEwMDAx-1-bG9jYWxfcGhw-YjFmN2QzNTctZTNkYi00ODkzLTk1NjktY2ZmOTczNWNlNDRh-L3NjX2N1cmxfcG9zdC5waHA=-MTI3LjAuMC4xOjkwOTA=
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (sw <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>        zval <span style=color:#ff79c6>*</span>option <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>        <span style=color:#8be9fd>int</span> is_init <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>        option <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header)), Z_RES_HANDLE_P(zid));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>        <span style=color:#ff79c6>if</span>(option <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>            option <span style=color:#ff79c6>=</span> emalloc(<span style=color:#ff79c6>sizeof</span>(zval));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>            bzero(option, <span style=color:#ff79c6>sizeof</span>(zval));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>            array_init(option);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>            is_init <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>        add_next_index_string(option, sw); <span style=color:#6272a4>//sw字符串为sw8： 打头，所以天然就是HTTP header
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span><span style=color:#6272a4></span>        add_index_bool(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header_send), (zend_ulong)Z_RES_HANDLE_P(zid), IS_TRUE);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>        zval func;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>        zval argv[<span style=color:#bd93f9>3</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>        zval ret;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>        ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>func, <span style=color:#f1fa8c>&#34;curl_setopt&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>        ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>0</span>], zid);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>        ZVAL_LONG(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>1</span>], CURLOPT_HTTPHEADER);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>        ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>2</span>], option);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>        call_user_function(CG(function_table), <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#ff79c6>&amp;</span>func, <span style=color:#ff79c6>&amp;</span>ret, <span style=color:#bd93f9>3</span>, argv); <span style=color:#6272a4>//给curl header调用注入全链路Trace信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span><span style=color:#6272a4></span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>ret);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>func);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>        <span style=color:#ff79c6>if</span>(is_init <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>            zval_ptr_dtor(option);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>            efree(option);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>argv[<span style=color:#bd93f9>2</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>        efree(sw);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>    zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>l_millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>    <span style=color:#8be9fd>long</span> millisecond;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span>    <span style=color:#ff79c6>if</span>(is_send <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanId&#34;</span>, Z_LVAL_P(span_id) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;startTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanType&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanLayer&#34;</span>, <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;componentId&#34;</span>, COMPONENT_HTTPCLIENT);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194</span><span>	orig_curl_exec(INTERNAL_FUNCTION_PARAM_PASSTHRU); <span style=color:#6272a4>//执行原生的curl函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196</span><span>    <span style=color:#ff79c6>if</span> (is_send <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197</span><span>        <span style=color:#6272a4>//结束时间获取
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198</span><span><span style=color:#6272a4></span>        l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199</span><span>        millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200</span><span>        efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202</span><span>        zval function_name_1, curlInfo_1;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203</span><span>        zval params_1[<span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204</span><span>        ZVAL_COPY(<span style=color:#ff79c6>&amp;</span>params_1[<span style=color:#bd93f9>0</span>], zid);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205</span><span>        ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>function_name_1, <span style=color:#f1fa8c>&#34;curl_getinfo&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206</span><span>        call_user_function(CG(function_table), <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#ff79c6>&amp;</span>function_name_1, <span style=color:#ff79c6>&amp;</span>curlInfo_1, <span style=color:#bd93f9>1</span>, params_1);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>params_1[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>function_name_1);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;endTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;operationName&#34;</span>, operation_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;peer&#34;</span>, peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215</span><span>        zval tags;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;url&#34;</span>, full_url);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;component&#34;</span>, <span style=color:#f1fa8c>&#34;PHP-CURL&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220</span><span>        <span style=color:#6272a4>//HTTP 响应code
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221</span><span><span style=color:#6272a4></span>        zval <span style=color:#ff79c6>*</span>z_http_code <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(curlInfo_1), ZEND_STRL(<span style=color:#f1fa8c>&#34;http_code&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222</span><span>      
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223</span><span>        <span style=color:#ff79c6>if</span> (Z_LVAL_P(z_http_code) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>200</span>){
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226</span><span>        <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231</span><span>        <span style=color:#6272a4>//针对http_code进行类型转化，便于增加tag
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (Z_TYPE_P(z_http_code) <span style=color:#ff79c6>==</span> IS_LONG)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234</span><span>            convert_to_string(z_http_code);                                       <span style=color:#6272a4>//针对z_http_code进行类型转换
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235</span><span><span style=color:#6272a4></span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;http.status_code&#34;</span>, Z_STRVAL_P(z_http_code)); <span style=color:#6272a4>//追加 reponse http code tag
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236</span><span><span style=color:#6272a4></span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238</span><span>        add_assoc_zval(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;tags&#34;</span>, <span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239</span><span>        efree(peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240</span><span>        efree(operation_name);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241</span><span>        efree(full_url);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243</span><span>        php_url_free(url_info);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245</span><span>        zval _refs;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>_refs);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247</span><span>        add_assoc_zval(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;refs&#34;</span>, <span style=color:#ff79c6>&amp;</span>_refs);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248</span><span>        zend_hash_next_index_insert(Z_ARRVAL_P(spans), <span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>curlInfo_1);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250</span><span>        zval_dtor(<span style=color:#ff79c6>&amp;</span>curlInfo);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252</span><span>}
</span></span></code></pre></div><h2 id=四-关键附属函数分析>四. 关键附属函数分析<a class=anchorjs-link href=#%e5%9b%9b-%e5%85%b3%e9%94%ae%e9%99%84%e5%b1%9e%e5%87%bd%e6%95%b0%e5%88%86%e6%9e%90></a></h2><h4 id=41-全局变量初始化函数>4.1 全局变量初始化函数<a class=anchorjs-link href=#41-%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e5%88%9d%e5%a7%8b%e5%8c%96%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>//初始化内核扩展全局变量
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>php_skywalking_init_globals</span>(zend_skywalking_globals <span style=color:#ff79c6>*</span>skywalking_globals)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>	skywalking_globals<span style=color:#ff79c6>-&gt;</span>app_code <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>	skywalking_globals<span style=color:#ff79c6>-&gt;</span>enable <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>	skywalking_globals<span style=color:#ff79c6>-&gt;</span>version <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>6</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>	skywalking_globals<span style=color:#ff79c6>-&gt;</span>sock_path <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;/var/run/sky-agent.sock&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    skywalking_globals<span style=color:#ff79c6>-&gt;</span>app_code_env_key <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;APM_APP_CODE&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h4 id=42-json序列化函数>4.2 json序列化函数<a class=anchorjs-link href=#42-json%e5%ba%8f%e5%88%97%e5%8c%96%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_json_encode</span>(zval <span style=color:#ff79c6>*</span>parameter){
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	smart_str buf <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	zend_long options <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>64</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>#if PHP_VERSION_ID &gt;= 70100
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6></span>	<span style=color:#ff79c6>if</span> (php_json_encode(<span style=color:#ff79c6>&amp;</span>buf, parameter, (<span style=color:#8be9fd>int</span>)options) <span style=color:#ff79c6>!=</span> SUCCESS) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		smart_str_free(<span style=color:#ff79c6>&amp;</span>buf);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		<span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6></span>	php_json_encode(<span style=color:#ff79c6>&amp;</span>buf, parameter, (<span style=color:#8be9fd>int</span>)options);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6></span>	smart_str_0(<span style=color:#ff79c6>&amp;</span>buf);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#ff79c6>if</span>(buf.s <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>bufs <span style=color:#ff79c6>=</span> emalloc(strlen(ZSTR_VAL(buf.s)) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        strcpy(bufs, ZSTR_VAL(buf.s));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        smart_str_free(<span style=color:#ff79c6>&amp;</span>buf);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>return</span> bufs;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><h4 id=43-发送apm数据函数>4.3 发送APM数据函数<a class=anchorjs-link href=#43-%e5%8f%91%e9%80%81apm%e6%95%b0%e6%8d%ae%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>write_log</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>text) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#6272a4>// to stream
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span>(text <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>||</span> strlen(text) <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>sockaddr_un</span> un;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        un.sun_family <span style=color:#ff79c6>=</span> AF_UNIX;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        strcpy(un.sun_path, SKYWALKING_G(sock_path));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>message <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>) emalloc(strlen(text) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        bzero(message, strlen(text) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        fd <span style=color:#ff79c6>=</span> socket(AF_UNIX, SOCK_STREAM, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>timeval</span> tv;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            tv.tv_sec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            tv.tv_usec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>100000</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            setsockopt(fd, SOL_SOCKET, SO_RCVTIMEO, (<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)<span style=color:#ff79c6>&amp;</span>tv, <span style=color:#ff79c6>sizeof</span> tv);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#8be9fd>int</span> conn <span style=color:#ff79c6>=</span> connect(fd, (<span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>sockaddr</span> <span style=color:#ff79c6>*</span>) <span style=color:#ff79c6>&amp;</span>un, <span style=color:#ff79c6>sizeof</span>(un));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#ff79c6>if</span> (conn <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                sprintf(message, <span style=color:#f1fa8c>&#34;1%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, text);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                write(fd, message, strlen(message));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                php_error_docref(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;[skywalking] failed to connect the sock.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            close(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            php_error_docref(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;[skywalking] failed to open the sock.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        efree(message);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        efree(text);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>}
</span></span></code></pre></div><h4 id=44-生成上下文函数>4.4 生成上下文函数<a class=anchorjs-link href=#44-%e7%94%9f%e6%88%90%e4%b8%8a%e4%b8%8b%e6%96%87%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>generate_context</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span>    <span style=color:#8be9fd>int</span> sys_pid <span style=color:#ff79c6>=</span> getpid();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>    <span style=color:#8be9fd>long</span> second <span style=color:#ff79c6>=</span> get_second();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>    second <span style=color:#ff79c6>=</span> second <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>10000</span> <span style=color:#ff79c6>+</span> sky_increment_id; <span style=color:#6272a4>//创建traceid的因子
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>makeTraceId;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    makeTraceId <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) emalloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>180</span>); <span style=color:#6272a4>//分配traceId所需要的内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>    bzero(makeTraceId, <span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>180</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    sprintf(makeTraceId, <span style=color:#f1fa8c>&#34;%d.%d.%ld&#34;</span>, application_instance, sys_pid, second);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;currentTraceId&#34;</span>, makeTraceId); <span style=color:#6272a4>//针对上下文context变量添加currentTraceId元素
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4></span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;isChild&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>    <span style=color:#6272a4>// parent
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#6272a4></span>    zval <span style=color:#ff79c6>*</span>carrier <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>    zval <span style=color:#ff79c6>*</span>sw;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    zend_bool jit_initialization <span style=color:#ff79c6>=</span> PG(auto_globals_jit); <span style=color:#6272a4>//PHP全局变量
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>    <span style=color:#ff79c6>if</span> (jit_initialization) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>        zend_string <span style=color:#ff79c6>*</span>server_str <span style=color:#ff79c6>=</span> zend_string_init(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>        zend_is_auto_global(server_str);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>        zend_string_release(server_str);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>    carrier <span style=color:#ff79c6>=</span> zend_hash_str_find(<span style=color:#ff79c6>&amp;</span>EG(symbol_table), ZEND_STRL(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>)); <span style=color:#6272a4>//获取查找$_SERVER超级全局变量
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#ff79c6>if</span>(SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>        sw <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(carrier), <span style=color:#f1fa8c>&#34;HTTP_SW3&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;HTTP_SW3&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>        <span style=color:#ff79c6>if</span> (sw <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(sw) <span style=color:#ff79c6>==</span> IS_STRING <span style=color:#ff79c6>&amp;&amp;</span> Z_STRLEN_P(sw) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>10</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;sw3&#34;</span>, Z_STRVAL_P(sw));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>            zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>            array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>            php_explode(zend_string_init(ZEND_STRL(<span style=color:#f1fa8c>&#34;|&#34;</span>), <span style=color:#bd93f9>0</span>), Z_STR_P(sw), <span style=color:#ff79c6>&amp;</span>temp, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>            <span style=color:#ff79c6>if</span>(zend_array_count(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>temp)) <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>8</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>                zval <span style=color:#ff79c6>*</span>sw3_0 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>                zval <span style=color:#ff79c6>*</span>sw3_1 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>                zval <span style=color:#ff79c6>*</span>sw3_2 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>                zval <span style=color:#ff79c6>*</span>sw3_3 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>                zval <span style=color:#ff79c6>*</span>sw3_4 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>                zval <span style=color:#ff79c6>*</span>sw3_5 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>                zval <span style=color:#ff79c6>*</span>sw3_6 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>6</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>                zval <span style=color:#ff79c6>*</span>sw3_7 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>7</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>                zval child;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>                array_init(<span style=color:#ff79c6>&amp;</span>child);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>                ZVAL_LONG(<span style=color:#ff79c6>&amp;</span>child, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>                zend_hash_str_update(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;isChild&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;isChild&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>child);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>, Z_STRVAL_P(sw3_0));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, zend_atol(Z_STRVAL_P(sw3_1), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw3_1)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>, zend_atol(Z_STRVAL_P(sw3_2), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw3_2)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>, zend_atol(Z_STRVAL_P(sw3_3), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw3_3)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>                add_assoc_str(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;networkAddress&#34;</span>, trim_sharp(sw3_4));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>                add_assoc_str(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>, trim_sharp(sw3_5));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>                add_assoc_str(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentOperationName&#34;</span>, trim_sharp(sw3_6));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>, Z_STRVAL_P(sw3_7));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>, application_instance);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>, application_instance);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>uri <span style=color:#ff79c6>=</span> get_page_request_uri();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>, (uri <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>, makeTraceId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>            <span style=color:#ff79c6>if</span>(uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>                efree(uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>6</span> <span style=color:#ff79c6>||</span> SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        sw <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(carrier), <span style=color:#f1fa8c>&#34;HTTP_SW6&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;HTTP_SW6&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>        <span style=color:#ff79c6>if</span> (sw <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(sw) <span style=color:#ff79c6>==</span> IS_STRING <span style=color:#ff79c6>&amp;&amp;</span> Z_STRLEN_P(sw) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>10</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;sw6&#34;</span>, Z_STRVAL_P(sw));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>            zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>            array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>            php_explode(zend_string_init(ZEND_STRL(<span style=color:#f1fa8c>&#34;-&#34;</span>), <span style=color:#bd93f9>0</span>), Z_STR_P(sw), <span style=color:#ff79c6>&amp;</span>temp, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>            <span style=color:#ff79c6>if</span>(zend_array_count(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>temp)) <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>                zval <span style=color:#ff79c6>*</span>sw6_0 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>                zval <span style=color:#ff79c6>*</span>sw6_1 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>1</span>); <span style=color:#6272a4>// Trace Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw6_2 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>2</span>); <span style=color:#6272a4>// Parent trace segment Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw6_3 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>3</span>); <span style=color:#6272a4>// Parent span Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw6_4 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>4</span>); <span style=color:#6272a4>// Parent service instance Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw6_5 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>5</span>); <span style=color:#6272a4>// Entrance service instance Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw6_6 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>6</span>); <span style=color:#6272a4>// Target address of this request
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>                zval <span style=color:#ff79c6>*</span>sw6_7 <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>                zval <span style=color:#ff79c6>*</span>sw6_8 <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>                <span style=color:#ff79c6>if</span> (zend_array_count(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>temp)) <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>9</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>                    sw6_7 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>7</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>                    sw6_8 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>8</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>                zval child;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>                array_init(<span style=color:#ff79c6>&amp;</span>child);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>                ZVAL_LONG(<span style=color:#ff79c6>&amp;</span>child, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>                zend_hash_str_update(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;isChild&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;isChild&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>child);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>                zval sw6_1decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>                zval sw6_2decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>                zval sw6_6decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw6_1decode, Z_STRVAL_P(sw6_1));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw6_2decode, Z_STRVAL_P(sw6_2));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw6_6decode, Z_STRVAL_P(sw6_6));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>, Z_STRVAL(sw6_2decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, zend_atol(Z_STRVAL_P(sw6_3), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw6_3)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>, zend_atol(Z_STRVAL_P(sw6_4), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw6_4)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>, zend_atol(Z_STRVAL_P(sw6_5), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw6_5)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;networkAddress&#34;</span>, Z_STRVAL(sw6_6decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>                <span style=color:#ff79c6>if</span> (sw6_7 <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> sw6_8 <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>                    zval sw6_7decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>                    zval sw6_8decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>                    zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw6_7decode, Z_STRVAL_P(sw6_7));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>                    zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw6_8decode, Z_STRVAL_P(sw6_8));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>, Z_STRVAL(sw6_7decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>                    add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentOperationName&#34;</span>, Z_STRVAL(sw6_8decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>                    zval_dtor(<span style=color:#ff79c6>&amp;</span>sw6_7decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>                    zval_dtor(<span style=color:#ff79c6>&amp;</span>sw6_8decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>, Z_STRVAL(sw6_1decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw6_1decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw6_2decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw6_6decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>, application_instance);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>, application_instance);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>uri <span style=color:#ff79c6>=</span> get_page_request_uri();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>            <span style=color:#ff79c6>if</span> (uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>                path <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)emalloc(strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>                bzero(path, strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>                <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>                <span style=color:#ff79c6>for</span>(i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> strlen(uri); i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>                    <span style=color:#ff79c6>if</span> (uri[i] <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;?&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>                    path[i] <span style=color:#ff79c6>=</span> uri[i];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>                path[i] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>, (path <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>            <span style=color:#ff79c6>if</span> (path <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>                efree(path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>, makeTraceId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>            <span style=color:#ff79c6>if</span>(uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                efree(uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>8</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>        sw <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(carrier), <span style=color:#f1fa8c>&#34;HTTP_SW8&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;HTTP_SW8&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>); <span style=color:#6272a4>//$SERVER[&#39;HTTP_SW8&#39;];
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (sw <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> Z_TYPE_P(sw) <span style=color:#ff79c6>==</span> IS_STRING <span style=color:#ff79c6>&amp;&amp;</span> Z_STRLEN_P(sw) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>10</span>) { <span style=color:#6272a4>//从header头部拿到了trace信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span><span style=color:#6272a4></span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;sw8&#34;</span>, Z_STRVAL_P(sw));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>            zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>            array_init(<span style=color:#ff79c6>&amp;</span>temp); <span style=color:#6272a4>//初始化数组元素
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>            php_explode(zend_string_init(ZEND_STRL(<span style=color:#f1fa8c>&#34;-&#34;</span>), <span style=color:#bd93f9>0</span>), Z_STR_P(sw), <span style=color:#ff79c6>&amp;</span>temp, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>            <span style=color:#ff79c6>if</span>(zend_array_count(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>temp)) <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>                zval <span style=color:#ff79c6>*</span>sw8_0 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>                zval <span style=color:#ff79c6>*</span>sw8_1 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>1</span>); <span style=color:#6272a4>// Trace Id base64
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_2 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>2</span>); <span style=color:#6272a4>// Parent trace segment Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_3 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>3</span>); <span style=color:#6272a4>// Parent span Id
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_4 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>4</span>); <span style=color:#6272a4>// Parent service
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_5 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>5</span>); <span style=color:#6272a4>// Parent service instance
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_6 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>6</span>); <span style=color:#6272a4>// Parent endpoint
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span><span style=color:#6272a4></span>                zval <span style=color:#ff79c6>*</span>sw8_7 <span style=color:#ff79c6>=</span> zend_hash_index_find(Z_ARRVAL(temp), <span style=color:#bd93f9>7</span>); <span style=color:#6272a4>// Target address used at client side of this request
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span>                zval child;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>                array_init(<span style=color:#ff79c6>&amp;</span>child);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>                ZVAL_LONG(<span style=color:#ff79c6>&amp;</span>child, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>                zend_hash_str_update(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;isChild&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;isChild&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>child); <span style=color:#6272a4>//因为当前HTTP SERVER有TraceId，所以链路存在父对象、因此切换当前上下文状态为child状态。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>                zval sw8_1decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>                zval sw8_2decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192</span><span>                zval sw8_4decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193</span><span>                zval sw8_5decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194</span><span>                zval sw8_6decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195</span><span>                zval sw8_7decode;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_1decode, Z_STRVAL_P(sw8_1));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_2decode, Z_STRVAL_P(sw8_2));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_4decode, Z_STRVAL_P(sw8_4));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_5decode, Z_STRVAL_P(sw8_5));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_6decode, Z_STRVAL_P(sw8_6));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201</span><span>                zval_b64_decode(<span style=color:#ff79c6>&amp;</span>sw8_7decode, Z_STRVAL_P(sw8_7));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203</span><span>                <span style=color:#6272a4>//针对当前请求的上下文丰富相关链路数据。
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204</span><span><span style=color:#6272a4></span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;traceId&#34;</span>, Z_STRVAL(sw8_1decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>, Z_STRVAL(sw8_2decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206</span><span>                add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, zend_atol(Z_STRVAL_P(sw8_3), <span style=color:#ff79c6>sizeof</span>(Z_STRVAL_P(sw8_3)) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentService&#34;</span>, Z_STRVAL(sw8_4decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentServiceInstance&#34;</span>, Z_STRVAL(sw8_5decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentEndpoint&#34;</span>, Z_STRVAL(sw8_6decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210</span><span>                add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;targetAddress&#34;</span>, Z_STRVAL(sw8_7decode));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212</span><span>                <span style=color:#6272a4>//释放转码相关内存
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213</span><span><span style=color:#6272a4></span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_1decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_2decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_4decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_5decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_6decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218</span><span>                zval_dtor(<span style=color:#ff79c6>&amp;</span>sw8_7decode);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221</span><span>            <span style=color:#6272a4>//$SERVER没有全链路ID，证明当前为ROOT根
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>//此处可以注入采样率
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223</span><span><span style=color:#6272a4></span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentService&#34;</span>, service);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentServiceInstance&#34;</span>, service_instance);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225</span><span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>uri <span style=color:#ff79c6>=</span> get_page_request_uri(); <span style=color:#6272a4>//获取当前请求的URI PATH
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226</span><span><span style=color:#6272a4></span>            <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227</span><span>            <span style=color:#ff79c6>if</span> (uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228</span><span>                path <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)emalloc(strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229</span><span>                bzero(path, strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231</span><span>                <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232</span><span>                <span style=color:#ff79c6>for</span>(i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> strlen(uri); i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233</span><span>                    <span style=color:#ff79c6>if</span> (uri[i] <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;?&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234</span><span>                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236</span><span>                    path[i] <span style=color:#ff79c6>=</span> uri[i];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238</span><span>                path[i] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;parentEndpoint&#34;</span>, (path <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> path); <span style=color:#6272a4>//把自己当前的PATH当做父级EndPoint
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> (path <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243</span><span>                efree(path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;traceId&#34;</span>, makeTraceId); <span style=color:#6272a4>//丰富traceId信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span>(uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248</span><span>                efree(uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">253</span><span>    efree(makeTraceId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">254</span><span>}
</span></span></code></pre></div><h4 id=45-解析请求uri信息函数>4.5 解析请求URI信息函数<a class=anchorjs-link href=#45-%e8%a7%a3%e6%9e%90%e8%af%b7%e6%b1%82uri%e4%bf%a1%e6%81%af%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//获取当前请求的URI地址
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_page_request_uri</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    zval <span style=color:#ff79c6>*</span>carrier <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    zval <span style=color:#ff79c6>*</span>request_uri;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    smart_str uri <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>}; <span style=color:#6272a4>//创建smart_str对象
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>if</span> (strcasecmp(<span style=color:#f1fa8c>&#34;cli&#34;</span>, sapi_module.name) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        smart_str_appendl(<span style=color:#ff79c6>&amp;</span>uri, <span style=color:#f1fa8c>&#34;cli&#34;</span>, strlen(<span style=color:#f1fa8c>&#34;cli&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        zend_bool jit_initialization <span style=color:#ff79c6>=</span> PG(auto_globals_jit);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>if</span> (jit_initialization) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            zend_string <span style=color:#ff79c6>*</span>server_str <span style=color:#ff79c6>=</span> zend_string_init(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            zend_is_auto_global(server_str);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            zend_string_release(server_str);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        carrier <span style=color:#ff79c6>=</span> zend_hash_str_find(<span style=color:#ff79c6>&amp;</span>EG(symbol_table), ZEND_STRL(<span style=color:#f1fa8c>&#34;_SERVER&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        request_uri <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(carrier), <span style=color:#f1fa8c>&#34;REQUEST_URI&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;REQUEST_URI&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        smart_str_appendl(<span style=color:#ff79c6>&amp;</span>uri, Z_STRVAL_P(request_uri), strlen(Z_STRVAL_P(request_uri)));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    smart_str_0(<span style=color:#ff79c6>&amp;</span>uri); <span style=color:#6272a4>//smart_str追加\0结尾
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (uri.s <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) { <span style=color:#6272a4>//转化为char*类型
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>uris <span style=color:#ff79c6>=</span> emalloc(strlen(ZSTR_VAL(uri.s)) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        strcpy(uris, ZSTR_VAL(uri.s));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        smart_str_free(<span style=color:#ff79c6>&amp;</span>uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>return</span> uris;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>}
</span></span></code></pre></div><h4 id=46-初始化请求函数>4.6 初始化请求函数<a class=anchorjs-link href=#46-%e5%88%9d%e5%a7%8b%e5%8c%96%e8%af%b7%e6%b1%82%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#6272a4>//请求初始化操作：用来丰富trace、spans等信息： 审计：2020.08.27 00:01
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>request_init</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(curl_header_send));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)); <span style=color:#6272a4>//初始化上下文
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#6272a4></span>	array_init(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment)); <span style=color:#6272a4>//初始化to agent的数据格式
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>    generate_context(); <span style=color:#6272a4>//生成上下文
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;application_instance&#34;</span>, application_instance); <span style=color:#6272a4>//from agent
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span><span style=color:#6272a4></span>    add_assoc_stringl(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;uuid&#34;</span>, application_uuid, strlen(application_uuid)); <span style=color:#6272a4>//from agent
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#6272a4></span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;pid&#34;</span>, getppid());
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;application_id&#34;</span>, application_id);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;version&#34;</span>, SKYWALKING_G(version));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    SKY_ADD_ASSOC_ZVAL(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;segment&#34;</span>); <span style=color:#6272a4>//创建子数组对象，用于构建 $UpstreamSegment[&#39;segment&#39;] = array();
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#6272a4></span>    SKY_ADD_ASSOC_ZVAL(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;globalTraceIds&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    add_assoc_stringl(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;service&#34;</span>, service, strlen(service)); <span style=color:#6272a4>//like app_code： from agent
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#6272a4></span>    add_assoc_stringl(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;serviceInstance&#34;</span>, service_instance, strlen(service_instance)); <span style=color:#6272a4>//uuid ： from agent
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span><span style=color:#6272a4></span>	zval <span style=color:#ff79c6>*</span>traceId <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;currentTraceId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;currentTraceId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>	zval traceSegmentObject;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>	zval spans;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>	array_init(<span style=color:#ff79c6>&amp;</span>spans);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>	array_init(<span style=color:#ff79c6>&amp;</span>traceSegmentObject);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>	add_assoc_string(<span style=color:#ff79c6>&amp;</span>traceSegmentObject, <span style=color:#f1fa8c>&#34;traceSegmentId&#34;</span>, Z_STRVAL_P(traceId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>	add_assoc_long(<span style=color:#ff79c6>&amp;</span>traceSegmentObject, <span style=color:#f1fa8c>&#34;isSizeLimited&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>	zval temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>uri <span style=color:#ff79c6>=</span> get_page_request_uri();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)emalloc(strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>    bzero(path, strlen(uri) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>    <span style=color:#ff79c6>for</span>(i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> strlen(uri); i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>        <span style=color:#ff79c6>if</span> (uri[i] <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;?&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>        path[i] <span style=color:#ff79c6>=</span> uri[i];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>    path[i] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>	array_init(<span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>    peer <span style=color:#ff79c6>=</span> get_page_request_peer(); <span style=color:#6272a4>// 从PHP $_SERVER变量中读取peer数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#6272a4></span>    zval tags;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>tags); <span style=color:#6272a4>//创建tags对象
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span><span style=color:#6272a4></span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;url&#34;</span>, (uri <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;server_type&#34;</span>, <span style=color:#f1fa8c>&#34;PHP&#34;</span>);      <span style=color:#6272a4>//注入PHP Server类型
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span><span style=color:#6272a4></span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>tags, <span style=color:#f1fa8c>&#34;php_version&#34;</span>,PHP_VERSION); <span style=color:#6272a4>//注入PHP版本号
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>    add_assoc_zval(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;tags&#34;</span>, <span style=color:#ff79c6>&amp;</span>tags);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanId&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>    <span style=color:#8be9fd>long</span> millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>    efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;startTime&#34;</span>, millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;operationName&#34;</span>, path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;peer&#34;</span>, (peer <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#ff79c6>:</span> peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanType&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>    add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;spanLayer&#34;</span>, <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>    <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>8</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;componentId&#34;</span>, <span style=color:#bd93f9>8001</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>temp, <span style=color:#f1fa8c>&#34;componentId&#34;</span>, COMPONENT_UNDERTOW);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    <span style=color:#6272a4>// sw8 or sw6 for parent endpoint name
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span><span style=color:#6272a4></span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context), <span style=color:#f1fa8c>&#34;currentEndpoint&#34;</span>, path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>    efree(path);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>    <span style=color:#ff79c6>if</span> (peer <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>        efree(peer);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>    <span style=color:#ff79c6>if</span> (uri <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        efree(uri);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>    zval <span style=color:#ff79c6>*</span>isChild <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL_P(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;isChild&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;isChild&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    <span style=color:#6272a4>// refs
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span><span style=color:#6272a4></span>    zval refs;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>refs);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>    zval globalTraceIds;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>    array_init(<span style=color:#ff79c6>&amp;</span>globalTraceIds);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>    zval tmpGlobalTraceIds;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    add_assoc_string(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment), <span style=color:#f1fa8c>&#34;traceId&#34;</span>, Z_STRVAL_P(traceId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>    <span style=color:#ff79c6>if</span>(Z_LVAL_P(isChild) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>        zval ref;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>        array_init(<span style=color:#ff79c6>&amp;</span>ref);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        zval <span style=color:#ff79c6>*</span>parentTraceSegmentId <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>        zval <span style=color:#ff79c6>*</span>parentSpanId <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        zval <span style=color:#ff79c6>*</span>parentApplicationInstance <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentApplicationInstance&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>        zval <span style=color:#ff79c6>*</span>entryApplicationInstance <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;entryApplicationInstance&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>        zval <span style=color:#ff79c6>*</span>entryOperationName <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;entryOperationName&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>        zval <span style=color:#ff79c6>*</span>networkAddress <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;networkAddress&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;networkAddress&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>        zval <span style=color:#ff79c6>*</span>parentOperationName <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentOperationName&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentOperationName&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>        zval <span style=color:#ff79c6>*</span>distributedTraceId <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;distributedTraceId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;type&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>        add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentTraceSegmentId&#34;</span>, Z_STRVAL_P(parentTraceSegmentId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>        add_assoc_long(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentSpanId&#34;</span>, Z_LVAL_P(parentSpanId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>        <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>8</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>            zval <span style=color:#ff79c6>*</span>traceId <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;traceId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;traceId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>            zval <span style=color:#ff79c6>*</span>parentService <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentService&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentService&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>            zval <span style=color:#ff79c6>*</span>parentServiceInstance <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentServiceInstance&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentServiceInstance&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>            zval <span style=color:#ff79c6>*</span>parentEndpoint <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;parentEndpoint&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;parentEndpoint&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>            zval <span style=color:#ff79c6>*</span>targetAddress <span style=color:#ff79c6>=</span> zend_hash_str_find(Z_ARRVAL(SKYWALKING_G(context)), <span style=color:#f1fa8c>&#34;targetAddress&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;targetAddress&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;traceId&#34;</span>, Z_STRVAL_P(traceId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentService&#34;</span>, Z_STRVAL_P(parentService));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentServiceInstance&#34;</span>, Z_STRVAL_P(parentServiceInstance));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentEndpoint&#34;</span>, Z_STRVAL_P(parentEndpoint));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;targetAddress&#34;</span>, Z_STRVAL_P(targetAddress));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>            zend_hash_str_update(Z_ARRVAL(SKYWALKING_G(UpstreamSegment)), <span style=color:#f1fa8c>&#34;traceId&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;traceId&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, traceId);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentApplicationInstanceId&#34;</span>, Z_LVAL_P(parentApplicationInstance));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>            add_assoc_long(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;entryApplicationInstanceId&#34;</span>, Z_LVAL_P(entryApplicationInstance));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;networkAddress&#34;</span>, Z_STRVAL_P(networkAddress));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;entryServiceName&#34;</span>, Z_STRVAL_P(entryOperationName));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>            add_assoc_string(<span style=color:#ff79c6>&amp;</span>ref, <span style=color:#f1fa8c>&#34;parentServiceName&#34;</span>, Z_STRVAL_P(parentOperationName));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>            ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>tmpGlobalTraceIds, Z_STRVAL_P(distributedTraceId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>        zend_hash_next_index_insert(Z_ARRVAL(refs), <span style=color:#ff79c6>&amp;</span>ref);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>        ZVAL_STRING(<span style=color:#ff79c6>&amp;</span>tmpGlobalTraceIds, Z_STRVAL_P(traceId));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>    zend_hash_str_add(Z_ARRVAL(temp), <span style=color:#f1fa8c>&#34;refs&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;refs&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>refs); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>    zend_hash_next_index_insert(Z_ARRVAL(spans), <span style=color:#ff79c6>&amp;</span>temp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>    add_assoc_zval(<span style=color:#ff79c6>&amp;</span>traceSegmentObject, <span style=color:#f1fa8c>&#34;spans&#34;</span>, <span style=color:#ff79c6>&amp;</span>spans);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>    <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>    {                                                                              <span style=color:#6272a4>//谨慎调整
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span><span style=color:#6272a4></span>        zend_hash_next_index_insert(Z_ARRVAL(globalTraceIds), <span style=color:#ff79c6>&amp;</span>tmpGlobalTraceIds); <span style=color:#6272a4>//问题症结 ：skywalking 8.0版本之后移除这个参数支持
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span><span style=color:#6272a4></span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>    zend_hash_str_update(Z_ARRVAL(SKYWALKING_G(UpstreamSegment)), <span style=color:#f1fa8c>&#34;segment&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;segment&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>traceSegmentObject);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>    zend_hash_str_update(Z_ARRVAL(SKYWALKING_G(UpstreamSegment)), <span style=color:#f1fa8c>&#34;globalTraceIds&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#f1fa8c>&#34;globalTraceIds&#34;</span>) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>globalTraceIds);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>}
</span></span></code></pre></div><h4 id=47-apm数据flush函数>4.7 APM数据flush函数<a class=anchorjs-link href=#47-apm%e6%95%b0%e6%8d%aeflush%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_flush_all</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>l_millisecond <span style=color:#ff79c6>=</span> get_millisecond();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#8be9fd>long</span> millisecond <span style=color:#ff79c6>=</span> zend_atol(l_millisecond, strlen(l_millisecond));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	efree(l_millisecond);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	zval <span style=color:#ff79c6>*</span>span <span style=color:#ff79c6>=</span> get_first_span();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	add_assoc_long(span, <span style=color:#f1fa8c>&#34;endTime&#34;</span>, millisecond); <span style=color:#6272a4>//标志请求结束时间
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>	<span style=color:#ff79c6>if</span> ((SG(sapi_headers).http_response_code <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>500</span>)) { <span style=color:#6272a4>//标志是否出错
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>		add_assoc_long(span, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		add_assoc_long(span, <span style=color:#f1fa8c>&#34;isError&#34;</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	write_log(sky_json_encode(<span style=color:#ff79c6>&amp;</span>SKYWALKING_G(UpstreamSegment))); <span style=color:#6272a4>//发送APM数据 - UNIX domain socket途径
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>}
</span></span></code></pre></div><h4 id=48-apm注册函数>4.8 APM注册函数<a class=anchorjs-link href=#48-apm%e6%b3%a8%e5%86%8c%e5%87%bd%e6%95%b0></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//sky-agent注册 :2020.08.26 22:34审计结束
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sky_register</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (application_instance <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>sockaddr_un</span> un;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        un.sun_family <span style=color:#ff79c6>=</span> AF_UNIX; <span style=color:#6272a4>//UNIX通信类型
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>        strcpy(un.sun_path, SKYWALKING_G(sock_path)); <span style=color:#6272a4>//UNIX通信地址
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#8be9fd>char</span> message[<span style=color:#bd93f9>1024</span>]; <span style=color:#6272a4>//内存空间优化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd>char</span> return_message[<span style=color:#bd93f9>1024</span>]; <span style=color:#6272a4>//内存空间优化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        fd <span style=color:#ff79c6>=</span> socket(AF_UNIX, SOCK_STREAM, <span style=color:#bd93f9>0</span>); <span style=color:#6272a4>//创建client fd
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>timeval</span> tv;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            tv.tv_sec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            tv.tv_usec <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>50000</span>; <span style=color:#6272a4>//单位微秒：50ms
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>            setsockopt(fd, SOL_SOCKET, SO_RCVTIMEO, (<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>) <span style=color:#ff79c6>&amp;</span>tv, <span style=color:#ff79c6>sizeof</span> tv);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#8be9fd>int</span> conn <span style=color:#ff79c6>=</span> connect(fd, (<span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>sockaddr</span> <span style=color:#ff79c6>*</span>) <span style=color:#ff79c6>&amp;</span>un, <span style=color:#ff79c6>sizeof</span>(un));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>if</span> (conn <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#6272a4>//进行ServiceName构建：如果环境变量不存在KEY对应的值，则进行环境变量获取
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4></span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>env_app_code <span style=color:#ff79c6>=</span> getenv(SKYWALKING_G(app_code_env_key));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>                <span style=color:#ff79c6>if</span> (env_app_code <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                    SKYWALKING_G(app_code) <span style=color:#ff79c6>=</span> env_app_code;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                bzero(message, <span style=color:#ff79c6>sizeof</span>(message));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                sprintf(message, <span style=color:#f1fa8c>&#34;0{</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>app_code</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>pid</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:%d,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>version</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:%d}</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, SKYWALKING_G(app_code),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                        getppid(), SKYWALKING_G(version));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                write(fd, message, strlen(message));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                bzero(return_message, <span style=color:#ff79c6>sizeof</span>(return_message));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                read(fd, return_message, <span style=color:#ff79c6>sizeof</span>(return_message));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ids[<span style=color:#bd93f9>10</span>] <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>                <span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> strtok(return_message, <span style=color:#f1fa8c>&#34;,&#34;</span>); <span style=color:#6272a4>//分割握手协议
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>while</span> (p <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                    ids[i<span style=color:#ff79c6>++</span>] <span style=color:#ff79c6>=</span> p;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                    p <span style=color:#ff79c6>=</span> strtok(<span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#f1fa8c>&#34;,&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>                <span style=color:#ff79c6>if</span> (ids[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> ids[<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>&amp;&amp;</span> ids[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>                    <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>6</span> <span style=color:#ff79c6>||</span> SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>                        application_id <span style=color:#ff79c6>=</span> atoi(ids[<span style=color:#bd93f9>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>                        application_instance <span style=color:#ff79c6>=</span> atoi(ids[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                        strncpy(application_uuid, ids[<span style=color:#bd93f9>2</span>], <span style=color:#ff79c6>sizeof</span> application_uuid <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (SKYWALKING_G(version) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>8</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                        application_id <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                        application_instance <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>                        strncpy(service, ids[<span style=color:#bd93f9>0</span>], <span style=color:#ff79c6>sizeof</span> service <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>); <span style=color:#6272a4>//拷贝service app_code ,此处和sidecar进行交互，可以定制化 ： app_code
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#6272a4></span>                        strncpy(service_instance, ids[<span style=color:#bd93f9>1</span>], <span style=color:#ff79c6>sizeof</span> service_instance <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>                        strncpy(application_uuid, ids[<span style=color:#bd93f9>2</span>], <span style=color:#ff79c6>sizeof</span> application_uuid <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>            } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                php_error_docref(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;[skywalking] failed to connect the socket.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            close(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>            php_error_docref(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;[skywalking] failed to open the socket.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>}
</span></span></code></pre></div><h2 id=五附录>五.附录<a class=anchorjs-link href=#%e4%ba%94%e9%99%84%e5%bd%95></a></h2><h3 id=51-附录一--skywalking-php内核组件的component列表>5.1 附录一 ： SkyWalking-PHP内核组件的Component列表<a class=anchorjs-link href=#51-%e9%99%84%e5%bd%95%e4%b8%80--skywalking-php%e5%86%85%e6%a0%b8%e7%bb%84%e4%bb%b6%e7%9a%84component%e5%88%97%e8%a1%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#ifndef SKYWALKING_COMPONENTS_H
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#define SKYWALKING_COMPONENTS_H
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>#define COMPONENT_TOMCAT 1
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>#define COMPONENT_HTTPCLIENT 2
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>#define COMPONENT_DUBBO 3
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>#define COMPONENT_MOTAN 8
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>#define COMPONENT_RESIN 10
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>#define COMPONENT_FEIGN 11
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>#define COMPONENT_OKHTTP 12
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>#define COMPONENT_SPRING_REST_TEMPLATE 13
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>#define COMPONENT_SPRING_MVC_ANNOTATION 14
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>#define COMPONENT_STRUTS2 15
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>#define COMPONENT_NUTZ_MVC_ANNOTATION 16
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>#define COMPONENT_NUTZ_HTTP 17
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>#define COMPONENT_JETTY_CLIENT 18
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>#define COMPONENT_JETTY_SERVER 19
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>#define COMPONENT_SHARDING_JDBC 21
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>#define COMPONENT_GRPC 23
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>#define COMPONENT_ELASTIC_JOB 24
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>#define COMPONENT_HTTP_ASYNC_CLIENT 26
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>#define COMPONENT_SERVICECOMB 28
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>#define COMPONENT_HYSTRIX 29
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>#define COMPONENT_JEDIS 30
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>#define COMPONENT_H2_JDBC_DRIVER 32
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>#define COMPONENT_MYSQL_JDBC_DRIVER 33
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>#define COMPONENT_OJDBC 34
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>#define COMPONENT_SPYMEMCACHED 35
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>#define COMPONENT_XMEMCACHED 36
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#ff79c6>#define COMPONENT_POSTGRESQL_DRIVER 37
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>#define COMPONENT_ROCKET_MQ_PRODUCER 38
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#ff79c6>#define COMPONENT_ROCKET_MQ_CONSUMER 39
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#ff79c6>#define COMPONENT_KAFKA_PRODUCER 40
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>#define COMPONENT_KAFKA_CONSUMER 41
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#ff79c6>#define COMPONENT_MONGO_DRIVER 42
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>#define COMPONENT_SOFARPC 43
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#ff79c6>#define COMPONENT_ACTIVEMQ_PRODUCER 45
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>#define COMPONENT_ACTIVEMQ_CONSUMER 46
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#ff79c6>#define COMPONENT_TRANSPORT_CLIENT 48
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#ff79c6>#define COMPONENT_UNDERTOW 49
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#ff79c6>#define COMPONENT_RPC 50
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#ff79c6>#endif </span><span style=color:#6272a4>//SKYWALKING_COMPONENTS_H
</span></span></span></code></pre></div><h3 id=52-附录二apm拦截所需的关键函数定义>5.2 附录二：APM拦截所需的关键函数定义<a class=anchorjs-link href=#52-%e9%99%84%e5%bd%95%e4%ba%8capm%e6%8b%a6%e6%88%aa%e6%89%80%e9%9c%80%e7%9a%84%e5%85%b3%e9%94%ae%e5%87%bd%e6%95%b0%e5%ae%9a%e4%b9%89></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_json_encode</span>(zval <span style=color:#ff79c6>*</span>parameter); <span style=color:#6272a4>//json序列化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>get_second</span>(); <span style=color:#6272a4>//获取秒级时间戳
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_millisecond</span>(); <span style=color:#6272a4>//获取毫秒级时间戳
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>generate_sw3</span>(zend_long span_id, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer_host, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>operation_name); <span style=color:#6272a4>//生成sw3协议数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>generate_sw6</span>(zend_long span_id, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer_host); <span style=color:#6272a4>//生成sw6协议数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>generate_sw8</span>(zend_long span_id, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>peer_host); <span style=color:#6272a4>//生成sw8协议数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>generate_context</span>(); <span style=color:#6272a4>//生成上下文
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_page_request_uri</span>(); <span style=color:#6272a4>//获取request的uri
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_page_request_peer</span>(); <span style=color:#6272a4>//获取request的主机信息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>write_log</span>( <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>text); <span style=color:#6272a4>//发送APM日志
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>request_init</span>();<span style=color:#6272a4>//初始化一次请求
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>zval_b64_encode</span>(zval <span style=color:#ff79c6>*</span>out, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>in); <span style=color:#6272a4>//base64序列化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>zval_b64_decode</span>(zval <span style=color:#ff79c6>*</span>out, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>in); <span style=color:#6272a4>//base64反序列化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_get_class_name</span>(zval <span style=color:#ff79c6>*</span>obj); <span style=color:#6272a4>//获取zval数据结构的class名称
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> zval <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_read_property</span>(zval <span style=color:#ff79c6>*</span>obj, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>property, <span style=color:#8be9fd>int</span> parent); <span style=color:#6272a4>//读取apm监控数据的某个属性
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_redis_fnamewall</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>function_name); <span style=color:#6272a4>//针对redis操作增加函数边界符号 |%s|
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sky_redis_opt_for_string_key</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fnamewall); <span style=color:#6272a4>//查询redis指令是否在APM监控范围内
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_flush_all</span>(); <span style=color:#6272a4>//发送skywalking APM数据包
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> zval <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_first_span</span>(); <span style=color:#6272a4>//获取收个全链路span数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> zval <span style=color:#ff79c6>*</span><span style=color:#50fa7b>get_spans</span>(); <span style=color:#6272a4>//获取全部的spans数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>_get_current_machine_ip</span>(); <span style=color:#6272a4>//获取当前机器的IP
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>sky_memcached_fnamewall</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>function_name); <span style=color:#6272a4>//针对memcache操作增加函数边界服务 |%s|
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sky_memcached_opt_for_string_key</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fnamewall); <span style=color:#6272a4>//查询memcache指令是否在APM监控范围内
</span></span></span></code></pre></div><h3 id=53-附录三apm关键函数hook定义>5.3 附录三：APM关键函数hook定义<a class=anchorjs-link href=#53-%e9%99%84%e5%bd%95%e4%b8%89apm%e5%85%b3%e9%94%ae%e5%87%bd%e6%95%b0hook%e5%ae%9a%e4%b9%89></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//curl函数Hook函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_curl_exec_handler</span>(INTERNAL_FUNCTION_PARAMETERS); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_curl_setopt_handler</span>(INTERNAL_FUNCTION_PARAMETERS);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_curl_setopt_array_handler</span>(INTERNAL_FUNCTION_PARAMETERS);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sky_curl_close_handler</span>(INTERNAL_FUNCTION_PARAMETERS);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>orig_curl_exec)(INTERNAL_FUNCTION_PARAMETERS) <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>orig_curl_setopt)(INTERNAL_FUNCTION_PARAMETERS) <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>orig_curl_setopt_array)(INTERNAL_FUNCTION_PARAMETERS) <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>static</span> <span style=color:#50fa7b>void</span> (<span style=color:#ff79c6>*</span>orig_curl_close)(INTERNAL_FUNCTION_PARAMETERS) <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span></code></pre></div><h3 id=54-附录三全局变量定义>5.4 附录三：全局变量定义<a class=anchorjs-link href=#54-%e9%99%84%e5%bd%95%e4%b8%89%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e5%ae%9a%e4%b9%89></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>  	Declare any global variables you may need between the BEGIN
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4>	and END macros here:
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>ZEND_BEGIN_MODULE_GLOBALS(skywalking)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>sock_path; <span style=color:#6272a4>//和sidecar通信的unix地址
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>app_code; <span style=color:#6272a4>//服务名称，app_name eg:skywalking.app_code = MyProjectName
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>app_code_env_key; <span style=color:#6272a4>//app_name 环境变量地址：环境变量-&gt;默认KEY：APM_APP_CODE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    zend_bool enable; <span style=color:#6272a4>//是否开启内核扩展
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    zval UpstreamSegment; <span style=color:#6272a4>//全局上报数据段
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    zval context; <span style=color:#6272a4>//APM上下文
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>    zval curl_header; <span style=color:#6272a4>//curl header数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    zval curl_header_send; <span style=color:#6272a4>//记录当前R周期 是否已经send过curl_header
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span>  version; <span style=color:#6272a4>//APM 版本号
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>ZEND_END_MODULE_GLOBALS(skywalking)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>extern</span> ZEND_DECLARE_MODULE_GLOBALS(skywalking);
</span></span></code></pre></div><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/icorer_blog/posts/microservice_governance_apm_application/ data-toggle=tooltip data-placement=top title=微服务治理：服务遥测之APM-SkyWalking技术应用>Previous<br><span>微服务治理：服务遥测之APM-SkyWalking技术应用</span></a></li><li class=next><a href=/icorer_blog/posts/cloudnative_k8s_tcp_upstream_balance/ data-toggle=tooltip data-placement=top title=TCP长连接在K8S环境下的负载均衡分析>Next<br><span>TCP长连接在K8S环境下的负载均衡分析</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/icorer_blog/tags/blockchain/>blockchain</a>
<a href=/icorer_blog/tags/clang/>CLang</a>
<a href=/icorer_blog/tags/cloudnative/>cloudnative</a>
<a href=/icorer_blog/tags/cmake/>Cmake</a>
<a href=/icorer_blog/tags/fpga/>FPGA</a>
<a href=/icorer_blog/tags/gc/>GC</a>
<a href=/icorer_blog/tags/golang/>GoLang</a>
<a href=/icorer_blog/tags/hackathon/>Hackathon</a>
<a href=/icorer_blog/tags/http2/>HTTP2</a>
<a href=/icorer_blog/tags/http3/>HTTP3</a>
<a href=/icorer_blog/tags/icefiredb/>IceFireDB</a>
<a href=/icorer_blog/tags/k8s/>k8s</a>
<a href=/icorer_blog/tags/kafka/>kafka</a>
<a href=/icorer_blog/tags/linux/>linux</a>
<a href=/icorer_blog/tags/nosql/>NoSQL</a>
<a href=/icorer_blog/tags/php/>PHP</a>
<a href=/icorer_blog/tags/php-kernel/>php kernel</a>
<a href=/icorer_blog/tags/php%E5%86%85%E6%A0%B8/>PHP内核</a>
<a href=/icorer_blog/tags/quic/>QUIC</a>
<a href=/icorer_blog/tags/redis/>redis</a>
<a href=/icorer_blog/tags/serverless/>serverless</a>
<a href=/icorer_blog/tags/unikernel/>unikernel</a>
<a href=/icorer_blog/tags/wanxiang/>Wanxiang</a>
<a href=/icorer_blog/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/icorer_blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/>云原生</a>
<a href=/icorer_blog/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>信息安全</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/>内存数据库</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/>内存泄漏</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81/>内核源码</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E7%A0%94%E7%A9%B6/>内核研究</a>
<a href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/>区块链</a>
<a href=/icorer_blog/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>垃圾回收</a>
<a href=/icorer_blog/tags/%E5%AD%98%E5%82%A8/>存储</a>
<a href=/icorer_blog/tags/%E5%AE%B9%E5%99%A8/>容器</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E5%BC%80%E5%8F%91/>底层开发</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/>底层研究</a>
<a href=/icorer_blog/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/>开源项目</a>
<a href=/icorer_blog/tags/%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97/>异构计算</a>
<a href=/icorer_blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>微服务</a>
<a href=/icorer_blog/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/>性能测试</a>
<a href=/icorer_blog/tags/%E6%8A%80%E6%9C%AF%E7%A7%91%E6%99%AE/>技术科普</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/>数据库技术</a>
<a href=/icorer_blog/tags/%E6%96%87%E7%AB%A0%E7%BF%BB%E8%AF%91/>文章翻译</a>
<a href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/>新架构</a>
<a href=/icorer_blog/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/>时序数据库</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/>服务治理</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/>服务网格</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E9%81%A5%E6%B5%8B/>服务遥测</a>
<a href=/icorer_blog/tags/%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF/>缓存技术</a>
<a href=/icorer_blog/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a>
<a href=/icorer_blog/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/>虚拟机</a>
<a href=/icorer_blog/tags/%E8%AE%BA%E6%96%87/>论文</a>
<a href=/icorer_blog/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB/>零信任</a>
<a href=/icorer_blog/tags/%E9%AB%98%E6%80%A7%E8%83%BD/>高性能</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=/icorer_blog/index.xml><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/corerman1><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/gitsrc><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 笔迹-工匠之芯 2022</p></div></div></div></footer><script src=/icorer_blog/js/jquery.min.js></script>
<script src=/icorer_blog/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/icorer_blog/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/icorer_blog/js/simple-jekyll-search.min.js></script>
<script src=/icorer_blog/js/search.min.7d1445cf07369bca2715d9f63738c16c73a7a2273a95d6729bee561f7e84c6c8.js></script>
<script src=/icorer_blog/zoomjs/zoom.min.js></script></body></html>