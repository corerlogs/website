<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon type=image/ico sizes=16x16 href=/icorer_blog/img/favicon.ico><meta property="og:image" content="https://icorer.com/img/34047788_pepere.jpg"><title>PHP-CURL-Guzzle-HTTP-连接复用内核原理 | 笔迹-工匠之芯</title><meta name=author content="LB"><meta name=description content="PHP-CURL连接复用内核原理0.写在前面PHP是一个时代的产物,它的底层支持是C语言,因此它在CPU密集型计算或者系统内核调用上有天生的优势,Zend引擎把PHP执行生命期分成了五个阶段1,这五个阶段并不是全部都能常驻进程,这种模式下,对于很多使用场景会造成不好的影响,比如网络IO.
对于网络IO中的HTTP请求 , 很多工程师使用 php-curl 系列函数 . 所以这篇文章将从内核角度讲解php如何支持curl请求的连接复用(这里的连接复用也是指在一个RINIT2&ndash;>RSHUTDOWN3周期内复用).
1. PHP引擎借力CURL库函数PHP需要使用curl组件进行HTTP系列通信,因此它在底层需要curl有相关的支撑,所以curl首先需要在系统环境中被部署或者被编译,并对外部提供动态链接库文件,PHP通过调用curl相关的动态链接库函数来进行自己内核函数的实现过程.
多说一句,PHP并不一定需要curl才能完成http请求,因为php引擎中已经包含了socket完善的函数库,所以有些php扩展包支持curl和原生stream_socket(tcp)两种模式,例如:guzzle
2. PHP-CURL基础数据结构(php_curl结构体) 1147 typedef struct { 2148 php_curl_write *write; 3149 php_curl_write *write_header; 4150 php_curl_read *read; 5151 zval std_err; 6152 php_curl_progress *progress; 7153 #if LIBCURL_VERSION_NUM >= 0x071500 /* Available since 7.21.0 */ 8154 php_curl_fnmatch *fnmatch; 9155 #endif 10156 } php_curl_handlers; 11 12173 typedef struct { 13174 CURL *cp; //curl库 实体结构体 14175 php_curl_handlers *handlers; //header 头部 15176 zend_resource *res; //引擎资源指针 16177 struct _php_curl_free *to_free; 17178 struct _php_curl_send_headers header; 18179 struct _php_curl_error err; //错误码 19180 zend_bool in_callback; 20181 uint32_t* clone; 21182 } php_curl; 3."><meta name=keywords content="blog,博客,工匠之芯,笔迹-工匠之芯"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP-CURL-Guzzle-HTTP-连接复用内核原理"><meta name=twitter:description content="PHP-CURL连接复用内核原理0.写在前面PHP是一个时代的产物,它的底层支持是C语言,因此它在CPU密集型计算或者系统内核调用上有天生的优势,Zend引擎把PHP执行生命期分成了五个阶段1,这五个阶段并不是全部都能常驻进程,这种模式下,对于很多使用场景会造成不好的影响,比如网络IO.
对于网络IO中的HTTP请求 , 很多工程师使用 php-curl 系列函数 . 所以这篇文章将从内核角度讲解php如何支持curl请求的连接复用(这里的连接复用也是指在一个RINIT2&ndash;>RSHUTDOWN3周期内复用).
1. PHP引擎借力CURL库函数PHP需要使用curl组件进行HTTP系列通信,因此它在底层需要curl有相关的支撑,所以curl首先需要在系统环境中被部署或者被编译,并对外部提供动态链接库文件,PHP通过调用curl相关的动态链接库函数来进行自己内核函数的实现过程.
多说一句,PHP并不一定需要curl才能完成http请求,因为php引擎中已经包含了socket完善的函数库,所以有些php扩展包支持curl和原生stream_socket(tcp)两种模式,例如:guzzle
2. PHP-CURL基础数据结构(php_curl结构体) 1147 typedef struct { 2148 php_curl_write *write; 3149 php_curl_write *write_header; 4150 php_curl_read *read; 5151 zval std_err; 6152 php_curl_progress *progress; 7153 #if LIBCURL_VERSION_NUM >= 0x071500 /* Available since 7.21.0 */ 8154 php_curl_fnmatch *fnmatch; 9155 #endif 10156 } php_curl_handlers; 11 12173 typedef struct { 13174 CURL *cp; //curl库 实体结构体 14175 php_curl_handlers *handlers; //header 头部 15176 zend_resource *res; //引擎资源指针 16177 struct _php_curl_free *to_free; 17178 struct _php_curl_send_headers header; 18179 struct _php_curl_error err; //错误码 19180 zend_bool in_callback; 20181 uint32_t* clone; 21182 } php_curl; 3."><meta property="og:title" content="PHP-CURL-Guzzle-HTTP-连接复用内核原理"><meta property="og:description" content="PHP-CURL连接复用内核原理0.写在前面PHP是一个时代的产物,它的底层支持是C语言,因此它在CPU密集型计算或者系统内核调用上有天生的优势,Zend引擎把PHP执行生命期分成了五个阶段1,这五个阶段并不是全部都能常驻进程,这种模式下,对于很多使用场景会造成不好的影响,比如网络IO.
对于网络IO中的HTTP请求 , 很多工程师使用 php-curl 系列函数 . 所以这篇文章将从内核角度讲解php如何支持curl请求的连接复用(这里的连接复用也是指在一个RINIT2&ndash;>RSHUTDOWN3周期内复用).
1. PHP引擎借力CURL库函数PHP需要使用curl组件进行HTTP系列通信,因此它在底层需要curl有相关的支撑,所以curl首先需要在系统环境中被部署或者被编译,并对外部提供动态链接库文件,PHP通过调用curl相关的动态链接库函数来进行自己内核函数的实现过程.
多说一句,PHP并不一定需要curl才能完成http请求,因为php引擎中已经包含了socket完善的函数库,所以有些php扩展包支持curl和原生stream_socket(tcp)两种模式,例如:guzzle
2. PHP-CURL基础数据结构(php_curl结构体) 1147 typedef struct { 2148 php_curl_write *write; 3149 php_curl_write *write_header; 4150 php_curl_read *read; 5151 zval std_err; 6152 php_curl_progress *progress; 7153 #if LIBCURL_VERSION_NUM >= 0x071500 /* Available since 7.21.0 */ 8154 php_curl_fnmatch *fnmatch; 9155 #endif 10156 } php_curl_handlers; 11 12173 typedef struct { 13174 CURL *cp; //curl库 实体结构体 14175 php_curl_handlers *handlers; //header 头部 15176 zend_resource *res; //引擎资源指针 16177 struct _php_curl_free *to_free; 17178 struct _php_curl_send_headers header; 18179 struct _php_curl_error err; //错误码 19180 zend_bool in_callback; 20181 uint32_t* clone; 21182 } php_curl; 3."><meta property="og:type" content="article"><meta property="og:url" content="https://icorer.com/icorer_blog/posts/php-curl-guzzle-http-connection-reuse-kernel-principle/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-22T13:16:18+08:00"><meta property="article:modified_time" content="2019-02-22T13:16:18+08:00"><link rel=stylesheet href=/icorer_blog/css/bootstrap.min.css crossorigin=anonymous><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/icorer_blog/sass/main.css><link rel=stylesheet href=/icorer_blog/zoomjs/zoom.min.css><script src=/icorer_blog/js/lazysizes.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/icorer_blog/apple-touch-icon.png><link rel=manifest href=/icorer_blog/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://icorer.com/icorer_blog/>笔迹-工匠之芯</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=https://icorer.com title=工匠之芯>工匠之芯</a></li><li><a href=https://icorer.com/icorer_about title=关于我>关于我</a></li><li><a href=https://github.com/gitsrc title=开源仓库>开源仓库</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder=内容搜索...></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/icorer_blog/tags/php/ title=PHP>PHP</a>
<a class=tag href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E7%A0%94%E7%A9%B6/ title=内核研究>内核研究</a>
<a class=tag href=/icorer_blog/tags/php%E5%86%85%E6%A0%B8/ title=PHP内核>PHP内核</a></div><h1>PHP-CURL-Guzzle-HTTP-连接复用内核原理</h1><h2 class=subheading></h2><span class=meta>Posted by LB
on Fri, Feb 22, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=php-curl连接复用内核原理>PHP-CURL连接复用内核原理<a class=anchorjs-link href=#php-curl%e8%bf%9e%e6%8e%a5%e5%a4%8d%e7%94%a8%e5%86%85%e6%a0%b8%e5%8e%9f%e7%90%86></a></h1><h2 id=0写在前面>0.写在前面<a class=anchorjs-link href=#0%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2></a></h2><p>PHP是一个时代的产物,它的底层支持是C语言,因此它在CPU密集型计算或者系统内核调用上有天生的优势,Zend引擎把PHP执行生命期分成了五个阶段<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>,这五个阶段并不是全部都能常驻进程,这种模式下,对于很多使用场景会造成不好的影响,比如网络IO.</p><p>对于网络IO中的HTTP请求 , 很多工程师使用 php-curl 系列函数 . 所以这篇文章将从内核角度讲解php如何支持curl请求的连接复用(这里的连接复用也是指在一个RINIT<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>&ndash;>RSHUTDOWN<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>周期内复用).</p><h2 id=1-php引擎借力curl库函数>1. PHP引擎借力CURL库函数<a class=anchorjs-link href=#1-php%e5%bc%95%e6%93%8e%e5%80%9f%e5%8a%9bcurl%e5%ba%93%e5%87%bd%e6%95%b0></a></h2><p>PHP需要使用curl组件进行HTTP系列通信,因此它在底层需要curl有相关的支撑,所以curl首先需要在系统环境中被部署或者被编译,并对外部提供动态链接库文件,PHP通过调用curl相关的动态链接库函数来进行自己内核函数的实现过程.</p><p><figure><a class=paragraph-image><img data-src=https://github.com/gitsrc/gitResCloud/raw/master/PHP-CURL-Guzzle-HTTP-%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/PHP-CURL%E5%86%85%E6%A0%B8.png data-action=zoom alt class=lazyload></a></figure></p><p>多说一句,PHP并不一定需要curl才能完成http请求,因为php引擎中已经包含了socket完善的函数库,所以有些php扩展包支持curl和原生stream_socket(tcp)两种模式,例如:<strong>guzzle</strong></p><h2 id=2-php-curl基础数据结构php_curl结构体>2. PHP-CURL基础数据结构(php_curl结构体)<a class=anchorjs-link href=#2-php-curl%e5%9f%ba%e7%a1%80%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84php_curl%e7%bb%93%e6%9e%84%e4%bd%93></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bd93f9>147</span>  <span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bd93f9>148</span>  	php_curl_write    <span style=color:#ff79c6>*</span>write;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bd93f9>149</span>  	php_curl_write    <span style=color:#ff79c6>*</span>write_header;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bd93f9>150</span>  	php_curl_read     <span style=color:#ff79c6>*</span>read;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bd93f9>151</span>  	zval               std_err;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bd93f9>152</span>  	php_curl_progress <span style=color:#ff79c6>*</span>progress;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bd93f9>153</span>  #<span style=color:#ff79c6>if</span> LIBCURL_VERSION_NUM <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0x071500</span> <span style=color:#6272a4>/* Available since 7.21.0 */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bd93f9>154</span>  	php_curl_fnmatch  <span style=color:#ff79c6>*</span>fnmatch;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bd93f9>155</span>  #endif
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bd93f9>156</span>  } php_curl_handlers;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bd93f9>173</span>  <span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bd93f9>174</span>  	CURL                         <span style=color:#ff79c6>*</span>cp; <span style=color:#6272a4>//curl库 实体结构体
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>175</span>  	php_curl_handlers            <span style=color:#ff79c6>*</span>handlers; <span style=color:#6272a4>//header 头部
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>176</span>  	zend_resource                <span style=color:#ff79c6>*</span>res; <span style=color:#6272a4>//引擎资源指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>177</span>  	<span style=color:#ff79c6>struct</span> _php_curl_free        <span style=color:#ff79c6>*</span>to_free;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bd93f9>178</span>  	<span style=color:#ff79c6>struct</span> _php_curl_send_headers header;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bd93f9>179</span>  	<span style=color:#ff79c6>struct</span> _php_curl_error        err; <span style=color:#6272a4>//错误码
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>180</span>  	zend_bool                     in_callback;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bd93f9>181</span>  	<span style=color:#8be9fd>uint32_t</span><span style=color:#ff79c6>*</span>                     clone;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bd93f9>182</span>  } php_curl;
</span></span></code></pre></div><h2 id=3--透析curl初始化阶段curl_init函数>3. 透析CURL初始化阶段(curl_init函数)<a class=anchorjs-link href=#3--%e9%80%8f%e6%9e%90curl%e5%88%9d%e5%a7%8b%e5%8c%96%e9%98%b6%e6%ae%b5curl_init%e5%87%bd%e6%95%b0></a></h2><p>curl_init是php调用curl的开端,之所以要分析这个函数,因为这个函数中就包括PHP如何调用curl库函数,如何对curl进行参数设置, 代码的解析通过注释的方式 , 内核源码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bd93f9>37</span>  #include <span style=color:#ff79c6>&lt;</span>curl<span style=color:#ff79c6>/</span>curl.h<span style=color:#ff79c6>&gt;</span>  <span style=color:#6272a4>//引入curl库头文件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>38</span>  #include <span style=color:#ff79c6>&lt;</span>curl<span style=color:#ff79c6>/</span>easy.h<span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>/* {{{ proto resource curl_init([string url])
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>   Initialize a cURL session */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bd93f9>2019</span>  <span style=color:#50fa7b>PHP_FUNCTION</span>(curl_init)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bd93f9>2020</span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bd93f9>2021</span>  	php_curl <span style=color:#ff79c6>*</span>ch;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bd93f9>2022</span>  	CURL 	 <span style=color:#ff79c6>*</span>cp;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bd93f9>2023</span>  	zend_string <span style=color:#ff79c6>*</span>url <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bd93f9>2024</span>  <span style=color:#6272a4>//解析php函数参数 ,不是必须参数,如果存在则丰富url zend_string(php内核字符串类型)类型指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2025</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_START</span>(<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bd93f9>2026</span>  		Z_PARAM_OPTIONAL
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bd93f9>2027</span>  		<span style=color:#50fa7b>Z_PARAM_STR</span>(url)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bd93f9>2028</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_END</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bd93f9>2029</span>     <span style=color:#ff79c6>/</span> <span style=color:#ff79c6>*</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>         <span style=color:#ff79c6>*</span> curl_easy_init（）是curl库对外提供的alloc，setup和init的外部函数
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>         <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>struct</span> Curl_easy <span style=color:#ff79c6>*</span><span style=color:#50fa7b>curl_easy_init</span>(<span style=color:#8be9fd>void</span>); <span style=color:#ff79c6>/</span>lib<span style=color:#ff79c6>/</span>easy.<span style=color:#8be9fd;font-style:italic>c</span> :<span style=color:#bd93f9>381</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>         <span style=color:#ff79c6>*</span> 返回简单的句柄。如果出现任何问题，则返回<span style=color:#8be9fd;font-style:italic>NULL</span>。
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>         */
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bd93f9>2030</span>  	cp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>curl_easy_init</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bd93f9>2031</span>  	<span style=color:#50fa7b>if</span> (<span style=color:#ff79c6>!</span>cp) { <span style=color:#6272a4>//如果curl初始化失败 则 返回false
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2032</span>  		<span style=color:#50fa7b>php_error_docref</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;Could not initialize a new cURL handle&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bd93f9>2033</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bd93f9>2034</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#bd93f9>2035</span>    <span style=color:#6272a4>//这个是核心内存构造函数,主要构造curl句柄的结构指针内存,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2036</span>  	ch <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>alloc_curl_handle</span>(); 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bd93f9>2037</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bd93f9>2038</span>  	ch<span style=color:#ff79c6>-&gt;</span>cp <span style=color:#ff79c6>=</span> cp;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bd93f9>2039</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bd93f9>2040</span>  	ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>=</span> PHP_CURL_STDOUT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bd93f9>2041</span>  	ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>read<span style=color:#ff79c6>-&gt;</span>method  <span style=color:#ff79c6>=</span> PHP_CURL_DIRECT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#bd93f9>2042</span>  	ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write_header<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>=</span> PHP_CURL_IGNORE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#bd93f9>2043</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#bd93f9>2044</span>  	<span style=color:#50fa7b>_php_curl_set_default_options</span>(ch); <span style=color:#6272a4>//初始化CURL对象的默认参数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#bd93f9>2045</span>    <span style=color:#6272a4>//如果url指针不为null,则把url参数设置好
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2046</span>  	<span style=color:#ff79c6>if</span> (url) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    	<span style=color:#6272a4>/*php_curl_option_url包含: 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#6272a4>    	 1.url解析(php_url_parse_ex) 在(LIBCURL_VERSION_NUM &gt; 0x073800) 支持file://
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#6272a4>    	 2.php_curl_option_str --&gt; curl_easy_setopt(ch-&gt;cp, option, str);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4>    	   函数:设置curl句柄的字符串类型参数,在libcurl 7.17.0之后进行url字符串拷贝. 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4>    		   copystr = estrndup(url, len); 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4>    	   	   error = curl_easy_setopt(ch-&gt;cp, option, copystr);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#6272a4>    	*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#bd93f9>2047</span>  		<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>php_curl_option_url</span>(ch, <span style=color:#50fa7b>ZSTR_VAL</span>(url), <span style=color:#50fa7b>ZSTR_LEN</span>(url)) <span style=color:#ff79c6>==</span> FAILURE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#bd93f9>2048</span>  			<span style=color:#50fa7b>_php_curl_close_ex</span>(ch);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#bd93f9>2049</span>  			RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#bd93f9>2050</span>  		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#bd93f9>2051</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#bd93f9>2052</span>  <span style=color:#6272a4>/*zval *return_value，我们在函数内部修改这个指针，函数执行完成后，内核将把这个指针指向的zval
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#6272a4>        返回给用户端的函数调用者。这种结果值的设计很少见,可以达到很多意想不到的效果,就像这个函数,设置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#6272a4>        完返回值,又可以继续进行相关操作.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#6272a4>        注册ch资源 并 把相关资源指针初始化到返回值内存内.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4>      */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>  <span style=color:#6272a4>//ZEND_API zend_resource* zend_register_resource(void *rsrc_pointer, int rsrc_type);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2053</span>  	<span style=color:#50fa7b>ZVAL_RES</span>(return_value, <span style=color:#50fa7b>zend_register_resource</span>(ch, le_curl));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#bd93f9>2054</span>  	ch<span style=color:#ff79c6>-&gt;</span>res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>Z_RES_P</span>(return_value); <span style=color:#6272a4>//提取资源的指针(在php引擎中是资源id)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2055</span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#bd93f9>2056</span>  <span style=color:#6272a4>/* }}} */</span>
</span></span></code></pre></div><h2 id=4--透析curl参数设置curl_setopt函数>4. 透析CURL参数设置(curl_setopt函数)<a class=anchorjs-link href=#4--%e9%80%8f%e6%9e%90curl%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%aecurl_setopt%e5%87%bd%e6%95%b0></a></h2><p>php在初始化curl阶段之后,如果初始化成功则会能到一个有效的curl句柄,随后需要对这个curl句柄中的参数进行丰富性设置,下面我们就来看一下内核这部分源代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bd93f9>3014</span>  <span style=color:#6272a4>/* {{{ proto bool curl_setopt(resource ch, int option, mixed value)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>3015     Set an option for a cURL transfer */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bd93f9>3016</span>  <span style=color:#50fa7b>PHP_FUNCTION</span>(curl_setopt)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bd93f9>3017</span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bd93f9>3018</span>  	zval       <span style=color:#ff79c6>*</span>zid, <span style=color:#ff79c6>*</span>zvalue;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bd93f9>3019</span>  	zend_long        options;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bd93f9>3020</span>  	php_curl   <span style=color:#ff79c6>*</span>ch;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bd93f9>3021</span>   <span style=color:#6272a4>/* 解析参数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>		* 1.resource : zid
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>		* 2.long: options
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>		* 3.zval: zvalue
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4>		*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bd93f9>3022</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_START</span>(<span style=color:#bd93f9>3</span>, <span style=color:#bd93f9>3</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bd93f9>3023</span>  		<span style=color:#50fa7b>Z_PARAM_RESOURCE</span>(zid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bd93f9>3024</span>  		<span style=color:#50fa7b>Z_PARAM_LONG</span>(options)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bd93f9>3025</span>  		<span style=color:#50fa7b>Z_PARAM_ZVAL</span>(zvalue)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bd93f9>3026</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_END</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#6272a4>/*获取资源地址
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4>        * zend_fetch_resource : if(resource_type == res-&gt;type){return res-&gt;ptr;}
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>        * 把void* 指针转换为 php_curl* 指针类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>        */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bd93f9>3027</span>    <span style=color:#6272a4>// #define le_curl_name &#34;cURL handle&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3028</span>  	<span style=color:#ff79c6>if</span> ((ch <span style=color:#ff79c6>=</span> (php_curl<span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>zend_fetch_resource</span>(<span style=color:#50fa7b>Z_RES_P</span>(zid), le_curl_name, le_curl)) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bd93f9>3029</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bd93f9>3030</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#bd93f9>3031</span>    <span style=color:#6272a4>//检查参数 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>//PHP7 删除了CURLOPT_SAFE_UPLOAD选项， 必须使用 CURLFile interface 来上传文件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3032</span>  	<span style=color:#ff79c6>if</span> (options <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> options <span style=color:#ff79c6>!=</span> CURLOPT_SAFE_UPLOAD) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bd93f9>3033</span>  		<span style=color:#50fa7b>php_error_docref</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;Invalid curl configuration option&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bd93f9>3034</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bd93f9>3035</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bd93f9>3036</span>    <span style=color:#6272a4>//对ch句柄设置选项对应的参数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3037</span>  	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>_php_curl_setopt</span>(ch, options, zvalue) <span style=color:#ff79c6>==</span> SUCCESS) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#bd93f9>3038</span>  		RETURN_TRUE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#bd93f9>3039</span>  	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#bd93f9>3040</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#bd93f9>3041</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#bd93f9>3042</span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#bd93f9>3043</span>  <span style=color:#6272a4>/* }}} */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#bd93f9>3044</span>  
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>//这个选项在第五部分会设计,所以单独拿出来, 设置CURL的结果输出类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>2899</span>  <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>CURLOPT_RETURNTRANSFER</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bd93f9>2900</span>  <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>zend_is_true</span>(zvalue)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bd93f9>2901</span>  		ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>=</span> PHP_CURL_RETURN;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bd93f9>2902</span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bd93f9>2903</span>  		ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>=</span> PHP_CURL_STDOUT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bd93f9>2904</span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bd93f9>2905</span>  <span style=color:#ff79c6>break</span>;
</span></span></code></pre></div><h2 id=5-透析curl的执行过程curl_exec函数>5. 透析CURL的执行过程(curl_exec函数)<a class=anchorjs-link href=#5-%e9%80%8f%e6%9e%90curl%e7%9a%84%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8bcurl_exec%e5%87%bd%e6%95%b0></a></h2><p>当设置好curl参数之后 , 就可以执行curl_exec函数,发出用户请求.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bd93f9>3094</span>  <span style=color:#6272a4>/* {{{ proto bool curl_exec(resource ch)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>3095     Perform a cURL session */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bd93f9>3096</span>  <span style=color:#50fa7b>PHP_FUNCTION</span>(curl_exec)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bd93f9>3097</span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bd93f9>3098</span>  	CURLcode	error;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bd93f9>3099</span>  	zval		<span style=color:#ff79c6>*</span>zid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bd93f9>3100</span>  	php_curl	<span style=color:#ff79c6>*</span>ch;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bd93f9>3101</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bd93f9>3102</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_START</span>(<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bd93f9>3103</span>  		<span style=color:#50fa7b>Z_PARAM_RESOURCE</span>(zid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bd93f9>3104</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_END</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bd93f9>3105</span>    <span style=color:#6272a4>//解析并获取php_curl句柄
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3106</span>  	<span style=color:#ff79c6>if</span> ((ch <span style=color:#ff79c6>=</span> (php_curl<span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>zend_fetch_resource</span>(<span style=color:#50fa7b>Z_RES_P</span>(zid), le_curl_name, le_curl)) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bd93f9>3107</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bd93f9>3108</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bd93f9>3109</span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>		  检验资源所对应的句柄们,ch属于php_curl类型,类型中包含一些读写资源指针,需要对这些资源进行可
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4>          用性判断,根据具体情况更新ch所对应的相应参数.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4>          */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bd93f9>3110</span>  	<span style=color:#50fa7b>_php_curl_verify_handlers</span>(ch, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bd93f9>3111</span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4>         由于ch对象能够被复用,所以这部分是对ch进行数据复位工作,主要包括相关缓冲区清空,错误码归置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4>        */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bd93f9>3112</span>  	<span style=color:#50fa7b>_php_curl_cleanup_handle</span>(ch);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bd93f9>3113</span>    <span style=color:#6272a4>/*调用curl库函数进行请求发送
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>		* curl内核调用关系:curl_easy_perform --&gt;easy_perform--&gt;easy_transfer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4>        */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bd93f9>3114</span>  	error <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>curl_easy_perform</span>(ch<span style=color:#ff79c6>-&gt;</span>cp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bd93f9>3115</span>  	<span style=color:#50fa7b>SAVE_CURL_ERROR</span>(ch, error);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bd93f9>3116</span>  	<span style=color:#6272a4>/* CURLE_PARTIAL_FILE is returned by HEAD requests */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bd93f9>3117</span>  	<span style=color:#ff79c6>if</span> (error <span style=color:#ff79c6>!=</span> CURLE_OK <span style=color:#ff79c6>&amp;&amp;</span> error <span style=color:#ff79c6>!=</span> CURLE_PARTIAL_FILE) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bd93f9>3118</span>  		<span style=color:#50fa7b>smart_str_free</span>(<span style=color:#ff79c6>&amp;</span>ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>buf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#bd93f9>3119</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#bd93f9>3120</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#bd93f9>3121</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#bd93f9>3122</span>  	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#50fa7b>Z_ISUNDEF</span>(ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>std_err)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#bd93f9>3123</span>  		php_stream  <span style=color:#ff79c6>*</span>stream;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#bd93f9>3124</span>  		stream <span style=color:#ff79c6>=</span> (php_stream<span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>zend_fetch_resource2_ex</span>(<span style=color:#ff79c6>&amp;</span>ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>std_err, <span style=color:#8be9fd;font-style:italic>NULL</span>, <span style=color:#50fa7b>php_file_le_stream</span>(), <span style=color:#50fa7b>php_file_le_pstream</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#bd93f9>3125</span>  		<span style=color:#50fa7b>if</span> (stream) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#bd93f9>3126</span>  			<span style=color:#50fa7b>php_stream_flush</span>(stream);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#bd93f9>3127</span>  		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#bd93f9>3128</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#bd93f9>3129</span>  <span style=color:#6272a4>/*下面的这部分 就是判断curl的结果该往哪地方输出,有stdout,file,php_var
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4>        */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#bd93f9>3130</span>  	<span style=color:#ff79c6>if</span> (ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>==</span> PHP_CURL_RETURN <span style=color:#ff79c6>&amp;&amp;</span> ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>buf.s) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#bd93f9>3131</span>  		<span style=color:#50fa7b>smart_str_0</span>(<span style=color:#ff79c6>&amp;</span>ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>buf);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#bd93f9>3132</span>  		<span style=color:#50fa7b>RETURN_STR_COPY</span>(ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>buf.s);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#bd93f9>3133</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#bd93f9>3134</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#bd93f9>3135</span>  	<span style=color:#6272a4>/* flush the file handle, so any remaining data is synched to disk */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#bd93f9>3136</span>  	<span style=color:#ff79c6>if</span> (ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>==</span> PHP_CURL_FILE <span style=color:#ff79c6>&amp;&amp;</span> ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>fp) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#bd93f9>3137</span>  		<span style=color:#50fa7b>fflush</span>(ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>fp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#bd93f9>3138</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#bd93f9>3139</span>  	<span style=color:#ff79c6>if</span> (ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write_header<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>==</span> PHP_CURL_FILE <span style=color:#ff79c6>&amp;&amp;</span> ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write_header<span style=color:#ff79c6>-&gt;</span>fp) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#bd93f9>3140</span>  		<span style=color:#50fa7b>fflush</span>(ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write_header<span style=color:#ff79c6>-&gt;</span>fp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#bd93f9>3141</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#bd93f9>3142</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#bd93f9>3143</span>  	<span style=color:#ff79c6>if</span> (ch<span style=color:#ff79c6>-&gt;</span>handlers<span style=color:#ff79c6>-&gt;</span>write<span style=color:#ff79c6>-&gt;</span>method <span style=color:#ff79c6>==</span> PHP_CURL_RETURN) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#bd93f9>3144</span>  		<span style=color:#50fa7b>RETURN_EMPTY_STRING</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#bd93f9>3145</span>  	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#bd93f9>3146</span>  		RETURN_TRUE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#bd93f9>3147</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#bd93f9>3148</span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#bd93f9>3149</span>  <span style=color:#6272a4>/* }}} */</span>
</span></span></code></pre></div><h2 id=6-透析curl的关闭过程>6. 透析CURL的关闭过程<a class=anchorjs-link href=#6-%e9%80%8f%e6%9e%90curl%e7%9a%84%e5%85%b3%e9%97%ad%e8%bf%87%e7%a8%8b></a></h2><p>PHP-CURL的过程化解析,最后一部分是关于CURL的关闭阶段,我来分析一下这部分的内核源代码.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bd93f9>3481</span>  <span style=color:#6272a4>/* {{{ proto void curl_close(resource ch)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>3482     Close a cURL session */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bd93f9>3483</span>  <span style=color:#50fa7b>PHP_FUNCTION</span>(curl_close)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bd93f9>3484</span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bd93f9>3485</span>  	zval		<span style=color:#ff79c6>*</span>zid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bd93f9>3486</span>  	php_curl	<span style=color:#ff79c6>*</span>ch;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bd93f9>3487</span>    <span style=color:#6272a4>//解析引擎中资源id
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3488</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_START</span>(<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bd93f9>3489</span>  		<span style=color:#50fa7b>Z_PARAM_RESOURCE</span>(zid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bd93f9>3490</span>  	<span style=color:#50fa7b>ZEND_PARSE_PARAMETERS_END</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bd93f9>3491</span>    <span style=color:#6272a4>//把void*资源指针转换为 php_curl*指针,如果失败则返回false
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3492</span>  	<span style=color:#ff79c6>if</span> ((ch <span style=color:#ff79c6>=</span> (php_curl<span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>zend_fetch_resource</span>(<span style=color:#50fa7b>Z_RES_P</span>(zid), le_curl_name, le_curl)) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bd93f9>3493</span>  		RETURN_FALSE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bd93f9>3494</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bd93f9>3495</span>    <span style=color:#6272a4>//调用回调函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3496</span>  	<span style=color:#ff79c6>if</span> (ch<span style=color:#ff79c6>-&gt;</span>in_callback) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bd93f9>3497</span>  		<span style=color:#50fa7b>php_error_docref</span>(<span style=color:#8be9fd;font-style:italic>NULL</span>, E_WARNING, <span style=color:#f1fa8c>&#34;Attempt to close cURL handle from a callback&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bd93f9>3498</span>  		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bd93f9>3499</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bd93f9>3500</span>  <span style=color:#6272a4>//销毁资源
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>3501</span>  	<span style=color:#50fa7b>zend_list_close</span>(<span style=color:#50fa7b>Z_RES_P</span>(zid));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bd93f9>3502</span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bd93f9>3503</span>  <span style=color:#6272a4>/* }}} */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bd93f9>3504</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#6272a4>//销毁zend链表内存,销毁res内存资源
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span><span style=color:#bd93f9>82</span>  ZEND_API <span style=color:#8be9fd>int</span> ZEND_FASTCALL <span style=color:#50fa7b>zend_list_close</span>(zend_resource <span style=color:#ff79c6>*</span>res)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bd93f9>83</span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bd93f9>84</span>  	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>GC_REFCOUNT</span>(res) <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bd93f9>85</span>  		<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>zend_list_free</span>(res);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bd93f9>86</span>  	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (res<span style=color:#ff79c6>-&gt;</span>type <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bd93f9>87</span>  		<span style=color:#50fa7b>zend_resource_dtor</span>(res);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#bd93f9>88</span>  	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#bd93f9>89</span>  	<span style=color:#ff79c6>return</span> SUCCESS;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#bd93f9>90</span>  }
</span></span></code></pre></div><h2 id=7curl内核分析>7.CURL内核分析<a class=anchorjs-link href=#7curl%e5%86%85%e6%a0%b8%e5%88%86%e6%9e%90></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//这部分承载着curl的简单模式下的HTTP请求,curl_exec最终会到这里,当然curl会继续往下走一层,到multi的请求与监控层.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>//curl内核调用关系:curl_easy_perform --&gt;easy_perform--&gt;easy_transfer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>static</span> CURLcode <span style=color:#50fa7b>easy_perform</span>(<span style=color:#ff79c6>struct</span> Curl_easy <span style=color:#ff79c6>*</span>data, <span style=color:#8be9fd>bool</span> events)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>struct</span> Curl_multi <span style=color:#ff79c6>*</span>multi;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  CURLMcode mcode;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  CURLcode result <span style=color:#ff79c6>=</span> CURLE_OK;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#50fa7b>SIGPIPE_VARIABLE</span>(pipe_st);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#ff79c6>if</span>(<span style=color:#ff79c6>!</span>data)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>return</span> CURLE_BAD_FUNCTION_ARGUMENT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>//初始化data的错误buffer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span>(data<span style=color:#ff79c6>-&gt;</span>set.errorbuffer)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#6272a4>/* clear this as early as possible */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    data<span style=color:#ff79c6>-&gt;</span>set.errorbuffer[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#ff79c6>if</span>(data<span style=color:#ff79c6>-&gt;</span>multi) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#50fa7b>failf</span>(data, <span style=color:#f1fa8c>&#34;easy handle already used in multi handle&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>return</span> CURLE_FAILED_INIT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#ff79c6>if</span>(data<span style=color:#ff79c6>-&gt;</span>multi_easy)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    multi <span style=color:#ff79c6>=</span> data<span style=color:#ff79c6>-&gt;</span>multi_easy;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#6272a4>/* this multi handle will only ever have a single easy handled attached
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>       to it, so make it use minimal hashes */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    multi <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>Curl_multi_handle</span>(<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#ff79c6>if</span>(<span style=color:#ff79c6>!</span>multi)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#ff79c6>return</span> CURLE_OUT_OF_MEMORY;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    data<span style=color:#ff79c6>-&gt;</span>multi_easy <span style=color:#ff79c6>=</span> multi;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  <span style=color:#ff79c6>if</span>(multi<span style=color:#ff79c6>-&gt;</span>in_callback)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>return</span> CURLE_RECURSIVE_API_CALL;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>  <span style=color:#6272a4>/* Copy the MAXCONNECTS option to the multi handle */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>  <span style=color:#50fa7b>curl_multi_setopt</span>(multi, CURLMOPT_MAXCONNECTS, data<span style=color:#ff79c6>-&gt;</span>set.maxconnects);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>  mcode <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>curl_multi_add_handle</span>(multi, data);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>  <span style=color:#ff79c6>if</span>(mcode) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    <span style=color:#50fa7b>curl_multi_cleanup</span>(multi);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    <span style=color:#ff79c6>if</span>(mcode <span style=color:#ff79c6>==</span> CURLM_OUT_OF_MEMORY)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      <span style=color:#ff79c6>return</span> CURLE_OUT_OF_MEMORY;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>return</span> CURLE_FAILED_INIT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>  <span style=color:#50fa7b>sigpipe_ignore</span>(data, <span style=color:#ff79c6>&amp;</span>pipe_st);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>  <span style=color:#6272a4>/* assign this after curl_multi_add_handle() since that function checks for
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#6272a4>     it and rejects this handle otherwise */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>  data<span style=color:#ff79c6>-&gt;</span>multi <span style=color:#ff79c6>=</span> multi;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>  <span style=color:#6272a4>/* run the transfer */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>  result <span style=color:#ff79c6>=</span> events <span style=color:#ff79c6>?</span> <span style=color:#50fa7b>easy_events</span>(multi) <span style=color:#ff79c6>:</span> <span style=color:#50fa7b>easy_transfer</span>(multi);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>  <span style=color:#6272a4>/* ignoring the return code isn&#39;t nice, but atm we can&#39;t really handle
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4>     a failure here, room for future improvement! */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>  (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>curl_multi_remove_handle</span>(multi, data);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>  <span style=color:#50fa7b>sigpipe_restore</span>(<span style=color:#ff79c6>&amp;</span>pipe_st);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>  <span style=color:#6272a4>/* The multi handle is kept alive, owned by the easy handle */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>  <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>}
</span></span></code></pre></div><h2 id=8php-http-请求连接复用>8.PHP-HTTP 请求连接复用<a class=anchorjs-link href=#8php-http-%e8%af%b7%e6%b1%82%e8%bf%9e%e6%8e%a5%e5%a4%8d%e7%94%a8></a></h2><p>PHP的HTTP请求如果想连接复用,这里讨论的连接复用是在一个一般有两种途径:</p><p>这里的连接复用也是指在一个RINIT<sup id=fnref1:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>&ndash;>RSHUTDOWN<sup id=fnref1:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>周期内复用:</p><ol><li><p>借助外部库,复用外部库所创建的实例(类似于PHP的单体), 外部库可以借助curl</p></li><li><p>借助php内核的<strong>stream_socket_client</strong>的<strong>STREAM_CLIENT_PERSISTENT</strong></p><p>(可以参考predis源码的src/Connection/StreamConnection.php : 169)</p></li></ol><h2 id=9-php-curl组合的http连接复用>9. PHP-CURL组合的HTTP连接复用<a class=anchorjs-link href=#9-php-curl%e7%bb%84%e5%90%88%e7%9a%84http%e8%bf%9e%e6%8e%a5%e5%a4%8d%e7%94%a8></a></h2><p>通过上面的源码分析,我们可以看出:</p><ul><li>curl_init 阶段会调用curl库创建相关内存区域,</li><li>curl_close阶段会销毁资源</li></ul><p>所以 , 在PHP调用curl阶段,我们如果想复用HTTP连接,就必须要把ch改造为单体,不要出现覆盖性创建,也要避免使用curl_close,避免相关资源的销毁,这样复用ch就会复用CURL</p><p>虽然复用了CURL,并不能代表能够复用HTTP,因为从源码分析中,我们可以看出http请求是curl帮我们承载的,所以对于连接的管理是curl帮我们做的,根据远端web服务器的http协议,curl会自动判断并选择性的复用连接.</p><h2 id=10php-guzzle组合的http复用>10.PHP-Guzzle组合的HTTP复用<a class=anchorjs-link href=#10php-guzzle%e7%bb%84%e5%90%88%e7%9a%84http%e5%a4%8d%e7%94%a8></a></h2><p>对于很多公司使用的是Guzzle功能包丰富和承载HTTP请求,所以我需要对Guzzle的源码做一些解读.</p><p>这里我只解析Guzzle的HTTP的handle选择过程.</p><h3 id=101-guzzle的client创建流程>10.1. **Guzzle的Client创建流程<a class=anchorjs-link href=#101-guzzle%e7%9a%84client%e5%88%9b%e5%bb%ba%e6%b5%81%e7%a8%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Client <span style=color:#ff79c6>::</span><span style=color:#50fa7b>__construct</span>()<span style=color:#ff79c6>--&gt;</span>HandlerStack<span style=color:#ff79c6>::</span><span style=color:#50fa7b>create</span>()<span style=color:#ff79c6>--&gt;</span>HandlerStack<span style=color:#ff79c6>::</span><span style=color:#50fa7b>choose_handler</span>()
</span></span></code></pre></div><h3 id=102-choose_handler函数解析>10.2. <strong>choose_handler()函数解析</strong><a class=anchorjs-link href=#102-choose_handler%e5%87%bd%e6%95%b0%e8%a7%a3%e6%9e%90></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>function</span> <span style=color:#50fa7b>choose_handler</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd;font-style:italic>$handler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> (function_exists(<span style=color:#f1fa8c>&#39;curl_multi_exec&#39;</span>) <span style=color:#ff79c6>&amp;&amp;</span> function_exists(<span style=color:#f1fa8c>&#39;curl_exec&#39;</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#8be9fd;font-style:italic>$handler</span> <span style=color:#ff79c6>=</span> Proxy<span style=color:#ff79c6>::</span><span style=color:#50fa7b>wrapSync</span>(<span style=color:#ff79c6>new</span> CurlMultiHandler(), <span style=color:#ff79c6>new</span> CurlHandler());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    } <span style=color:#ff79c6>elseif</span> (function_exists(<span style=color:#f1fa8c>&#39;curl_exec&#39;</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#8be9fd;font-style:italic>$handler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CurlHandler();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    } <span style=color:#ff79c6>elseif</span> (function_exists(<span style=color:#f1fa8c>&#39;curl_multi_exec&#39;</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#8be9fd;font-style:italic>$handler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CurlMultiHandler();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>if</span> (ini_get(<span style=color:#f1fa8c>&#39;allow_url_fopen&#39;</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#8be9fd;font-style:italic>$handler</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$handler</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            <span style=color:#ff79c6>?</span> Proxy<span style=color:#ff79c6>::</span><span style=color:#50fa7b>wrapStreaming</span>(<span style=color:#8be9fd;font-style:italic>$handler</span>, <span style=color:#ff79c6>new</span> StreamHandler())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>new</span> StreamHandler();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    } <span style=color:#ff79c6>elseif</span> (<span style=color:#ff79c6>!</span><span style=color:#8be9fd;font-style:italic>$handler</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> \RuntimeException(<span style=color:#f1fa8c>&#39;GuzzleHttp requires cURL, the &#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#ff79c6>.</span> <span style=color:#f1fa8c>&#39;allow_url_fopen ini setting, or a custom HTTP handler.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>$handler</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span></code></pre></div><p><strong>choose_handler函数选择stack中的起始handler，选择策略为：</strong></p><ul><li><strong>扩展自带curl_multi_exec和curl_exec函数则根据$options中的synchronous选项决定，empty(synchronous)为false则使用CurlHandler，否则使用CurlMultiHandler</strong></li><li><strong>扩展只有curl_exec函数则使用CurlHandler</strong></li><li><strong>扩展只有curl_multi_exec函数则使用CurlMultiHandler</strong></li></ul><p>通过分析这部分源代码,我们可以了解<strong>Guzzle也可以通过静态变量的方式来做到复用curl资源,来达到连接复用的目的</strong>.</p><h3 id=103-guzzle连接复用的样例代码>10.3. Guzzle连接复用的样例代码<a class=anchorjs-link href=#103-guzzle%e8%bf%9e%e6%8e%a5%e5%a4%8d%e7%94%a8%e7%9a%84%e6%a0%b7%e4%be%8b%e4%bb%a3%e7%a0%81></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//为缩减版代码
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>protected</span> <span style=color:#ff79c6>static</span> <span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>protected</span> <span style=color:#ff79c6>function</span> <span style=color:#50fa7b>getGuzzleClient</span>(<span style=color:#8be9fd;font-style:italic>$baseUrl</span>, <span style=color:#8be9fd;font-style:italic>$persistent</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#8be9fd;font-style:italic>$persistent</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Client([<span style=color:#f1fa8c>&#39;base_uri&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#8be9fd;font-style:italic>$baseUrl</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>return</span> self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>//获取Client静态变量,复用curl单体
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>  <span style=color:#8be9fd;font-style:italic>$client</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getGuzzleClient</span>(<span style=color:#8be9fd;font-style:italic>$base_uri</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#8be9fd;font-style:italic>$headers</span> <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            <span style=color:#f1fa8c>&#39;token&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#f1fa8c>&#39;Content-Type&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#f1fa8c>&#39;Accept-Encoding&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;gzip&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        ];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#8be9fd;font-style:italic>$responseBody</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#8be9fd;font-style:italic>$httpCode</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#8be9fd;font-style:italic>$error</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#8be9fd;font-style:italic>$response</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$client</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>request</span>(<span style=color:#f1fa8c>&#39;POST&#39;</span>, <span style=color:#8be9fd;font-style:italic>$func</span>, [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                <span style=color:#f1fa8c>&#39;headers&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#8be9fd;font-style:italic>$headers</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                <span style=color:#f1fa8c>&#39;body&#39;</span> <span style=color:#ff79c6>=&gt;</span> \GuzzleHttp\json_encode(<span style=color:#8be9fd;font-style:italic>$body</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                <span style=color:#f1fa8c>&#39;timeout&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#8be9fd;font-style:italic>$timeout</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                <span style=color:#f1fa8c>&#39;connect_timeout&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#8be9fd;font-style:italic>$connectTimeout</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            ]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#8be9fd;font-style:italic>$httpCode</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$response</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getStatusCode</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#8be9fd;font-style:italic>$responseBody</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$response</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getBody</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        } <span style=color:#ff79c6>catch</span> (\Exception <span style=color:#8be9fd;font-style:italic>$e</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            <span style=color:#8be9fd;font-style:italic>$error</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$e</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getMessage</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        }
</span></span></code></pre></div><h3 id=104-上面的guzzle样例是否复用了curl对象>10.4. <strong>上面的guzzle样例是否复用了CURL对象?</strong><a class=anchorjs-link href=#104-%e4%b8%8a%e9%9d%a2%e7%9a%84guzzle%e6%a0%b7%e4%be%8b%e6%98%af%e5%90%a6%e5%a4%8d%e7%94%a8%e4%ba%86curl%e5%af%b9%e8%b1%a1></a></h3><p>​ 这个问题很关键, 因为我们想借助curl的TCP复用,那就必须要成功的在PHP层复用CURL内核对象.</p><p>​ 我们通过上面的源码分析可以知道PHP内核对于curl内核的创建返回使用的是资源类型进行存储,在PHP内核中,资源有个资源ID进行区分 . 因此我们要想验证上述代码是否成功的复用CURL对象,就需要把CURL对象打印出来.</p><p>​ 验证上述理论,首先我需要分析一个Guzzle的复用ch对象部分源码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    <span style=color:#6272a4>//文件: CurlFactory.php
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>function</span> <span style=color:#50fa7b>create</span>(RequestInterface <span style=color:#8be9fd;font-style:italic>$request</span>, <span style=color:#ff79c6>array</span> <span style=color:#8be9fd;font-style:italic>$options</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>if</span> (isset(<span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;curl&#39;</span>][<span style=color:#f1fa8c>&#39;body_as_string&#39;</span>])) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;_body_as_string&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;curl&#39;</span>][<span style=color:#f1fa8c>&#39;body_as_string&#39;</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            unset(<span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;curl&#39;</span>][<span style=color:#f1fa8c>&#39;body_as_string&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#8be9fd;font-style:italic>$easy</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> EasyHandle;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#8be9fd;font-style:italic>$easy</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>request</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$request</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#8be9fd;font-style:italic>$easy</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>options</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$options</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#8be9fd;font-style:italic>$conf</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getDefaultConf</span>(<span style=color:#8be9fd;font-style:italic>$easy</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>applyMethod</span>(<span style=color:#8be9fd;font-style:italic>$easy</span>, <span style=color:#8be9fd;font-style:italic>$conf</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>applyHandlerOptions</span>(<span style=color:#8be9fd;font-style:italic>$easy</span>, <span style=color:#8be9fd;font-style:italic>$conf</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>applyHeaders</span>(<span style=color:#8be9fd;font-style:italic>$easy</span>, <span style=color:#8be9fd;font-style:italic>$conf</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        unset(<span style=color:#8be9fd;font-style:italic>$conf</span>[<span style=color:#f1fa8c>&#39;_headers&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#6272a4>// Add handler options from the request configuration options
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (isset(<span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;curl&#39;</span>])) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#8be9fd;font-style:italic>$conf</span> <span style=color:#ff79c6>=</span> array_replace(<span style=color:#8be9fd;font-style:italic>$conf</span>, <span style=color:#8be9fd;font-style:italic>$options</span>[<span style=color:#f1fa8c>&#39;curl&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#8be9fd;font-style:italic>$conf</span>[CURLOPT_HEADERFUNCTION] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>createHeaderFn</span>(<span style=color:#8be9fd;font-style:italic>$easy</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#6272a4>//这部分是对handle进行存在性判断,我们在这里加上一行var_dump
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>        var_dump(<span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>handles</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#8be9fd;font-style:italic>$easy</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>handle</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>handles</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>?</span> array_pop(<span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>handles</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#ff79c6>:</span> curl_init();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        curl_setopt_array(<span style=color:#8be9fd;font-style:italic>$easy</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>handle</span>, <span style=color:#8be9fd;font-style:italic>$conf</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>$easy</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    }
</span></span></code></pre></div><p>​ 我们调整完guzzle代码后,还需要写一份测试代码,测试代码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>//GuzzleClient.php
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>use</span> \GuzzleHttp\Client;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>GuzzleClient</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>protected</span> <span style=color:#ff79c6>static</span> <span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>static</span> <span style=color:#ff79c6>function</span> <span style=color:#50fa7b>getGuzzleClient</span>(<span style=color:#8be9fd;font-style:italic>$baseUrl</span>, <span style=color:#8be9fd;font-style:italic>$persistent</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#8be9fd;font-style:italic>$persistent</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Client([<span style=color:#f1fa8c>&#39;base_uri&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#8be9fd;font-style:italic>$baseUrl</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>return</span> self<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>$guzzleClientConnection</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4>//get_loop_simple.php 内部循环调用多次
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>for</span> (<span style=color:#8be9fd;font-style:italic>$i</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>;<span style=color:#8be9fd;font-style:italic>$i</span><span style=color:#ff79c6>&lt;=</span><span style=color:#bd93f9>10</span>;<span style=color:#8be9fd;font-style:italic>$i</span><span style=color:#ff79c6>++</span>){
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#6272a4>//获取Client静态变量,复用curl单体
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd;font-style:italic>$client</span> <span style=color:#ff79c6>=</span> GuzzleClient<span style=color:#ff79c6>::</span><span style=color:#50fa7b>getGuzzleClient</span>(<span style=color:#f1fa8c>&#34;http://127.0.0.1&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#8be9fd;font-style:italic>$response</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$client</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>request</span>(<span style=color:#f1fa8c>&#39;GET&#39;</span>, <span style=color:#f1fa8c>&#39;/test.php&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>       <span style=color:#6272a4>// var_dump($response-&gt;getBody()-&gt;getContents());
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>    } <span style=color:#ff79c6>catch</span> (\Exception <span style=color:#8be9fd;font-style:italic>$e</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#8be9fd;font-style:italic>$error</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$e</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>getMessage</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        var_dump(<span style=color:#8be9fd;font-style:italic>$error</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><p>​ 我们通过执行上述测试代码可以看到如下的运行结果:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>array<span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>array<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>  <span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]=</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>  resource<span style=color:#ff79c6>(</span>44<span style=color:#ff79c6>)</span> of <span style=color:#8be9fd;font-style:italic>type</span> <span style=color:#ff79c6>(</span>curl<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>​ <strong>通过上面的运行结果,我们可以除了第一次handle为空,其余每次create过程均没有再次调用curl_init内核函数,而是复用了资源id为44的curl类别资源.</strong></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>PHP生命期包括: MINIT , RINIT , PHP_EXECUTE_SCRIPT, RSHUTDOWN , MSHUTDOWN&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>RINIT代表 PHP引擎中的request startup阶段,指请求初始化阶段.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>RSHUTDOWN代表PHP引擎中的request shutdown阶段,指请求关闭阶段.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/icorer_blog/posts/php-kernel-function-analysis-microtime/ data-toggle=tooltip data-placement=top title="PHP内核函数: microtime">Previous<br><span>PHP内核函数: microtime</span></a></li><li class=next><a href=/icorer_blog/posts/curl-vs-guzzle-performance-test/ data-toggle=tooltip data-placement=top title="Curl-VS-Guzzle 性能测试">Next<br><span>Curl-VS-Guzzle 性能测试</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/icorer_blog/tags/blockchain/>blockchain</a>
<a href=/icorer_blog/tags/clang/>CLang</a>
<a href=/icorer_blog/tags/cloudnative/>cloudnative</a>
<a href=/icorer_blog/tags/cmake/>Cmake</a>
<a href=/icorer_blog/tags/cometbft/>CometBFT</a>
<a href=/icorer_blog/tags/cosmos/>cosmos</a>
<a href=/icorer_blog/tags/dcdn/>DCDN</a>
<a href=/icorer_blog/tags/deca/>DeCA</a>
<a href=/icorer_blog/tags/depin/>DePIN</a>
<a href=/icorer_blog/tags/dpki/>DPKI</a>
<a href=/icorer_blog/tags/drand/>drand</a>
<a href=/icorer_blog/tags/eip/>EIP</a>
<a href=/icorer_blog/tags/epoll/>epoll</a>
<a href=/icorer_blog/tags/ethereum/>Ethereum</a>
<a href=/icorer_blog/tags/fpga/>FPGA</a>
<a href=/icorer_blog/tags/gc/>GC</a>
<a href=/icorer_blog/tags/golang/>GoLang</a>
<a href=/icorer_blog/tags/hackathon/>Hackathon</a>
<a href=/icorer_blog/tags/http2/>HTTP2</a>
<a href=/icorer_blog/tags/http3/>HTTP3</a>
<a href=/icorer_blog/tags/icefiredb/>IceFireDB</a>
<a href=/icorer_blog/tags/k8s/>k8s</a>
<a href=/icorer_blog/tags/kafka/>kafka</a>
<a href=/icorer_blog/tags/layer2/>Layer2</a>
<a href=/icorer_blog/tags/linux/>linux</a>
<a href=/icorer_blog/tags/nginx/>Nginx</a>
<a href=/icorer_blog/tags/nosql/>NoSQL</a>
<a href=/icorer_blog/tags/php/>PHP</a>
<a href=/icorer_blog/tags/php-kernel/>php kernel</a>
<a href=/icorer_blog/tags/php%E5%86%85%E6%A0%B8/>PHP内核</a>
<a href=/icorer_blog/tags/quic/>QUIC</a>
<a href=/icorer_blog/tags/redis/>redis</a>
<a href=/icorer_blog/tags/sbt/>SBT</a>
<a href=/icorer_blog/tags/serverless/>serverless</a>
<a href=/icorer_blog/tags/ssi/>SSI</a>
<a href=/icorer_blog/tags/tendermint/>Tendermint</a>
<a href=/icorer_blog/tags/unikernel/>unikernel</a>
<a href=/icorer_blog/tags/wanxiang/>Wanxiang</a>
<a href=/icorer_blog/tags/web3/>web3</a>
<a href=/icorer_blog/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/icorer_blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/>云原生</a>
<a href=/icorer_blog/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/>以太坊</a>
<a href=/icorer_blog/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>信息安全</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/>内存数据库</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/>内存泄漏</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81/>内核源码</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E7%A0%94%E7%A9%B6/>内核研究</a>
<a href=/icorer_blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/>分布式</a>
<a href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/>区块链</a>
<a href=/icorer_blog/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>垃圾回收</a>
<a href=/icorer_blog/tags/%E5%AD%98%E5%82%A8/>存储</a>
<a href=/icorer_blog/tags/%E5%AE%B9%E5%99%A8/>容器</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E5%BC%80%E5%8F%91/>底层开发</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/>底层研究</a>
<a href=/icorer_blog/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/>开源项目</a>
<a href=/icorer_blog/tags/%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97/>异构计算</a>
<a href=/icorer_blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>微服务</a>
<a href=/icorer_blog/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/>性能测试</a>
<a href=/icorer_blog/tags/%E6%8A%80%E6%9C%AF%E7%A7%91%E6%99%AE/>技术科普</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/>数据库技术</a>
<a href=/icorer_blog/tags/%E6%96%87%E7%AB%A0%E7%BF%BB%E8%AF%91/>文章翻译</a>
<a href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/>新架构</a>
<a href=/icorer_blog/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/>时序数据库</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/>服务治理</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/>服务网格</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E9%81%A5%E6%B5%8B/>服务遥测</a>
<a href=/icorer_blog/tags/%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/>测试报告</a>
<a href=/icorer_blog/tags/%E7%A0%94%E7%A9%B6%E6%8A%A5%E5%91%8A/>研究报告</a>
<a href=/icorer_blog/tags/%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF/>缓存技术</a>
<a href=/icorer_blog/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a>
<a href=/icorer_blog/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/>虚拟机</a>
<a href=/icorer_blog/tags/%E8%A1%8C%E4%B8%9A%E6%8A%A5%E5%91%8A/>行业报告</a>
<a href=/icorer_blog/tags/%E8%AE%BA%E6%96%87/>论文</a>
<a href=/icorer_blog/tags/%E8%B7%A8%E9%93%BE/>跨链</a>
<a href=/icorer_blog/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB/>零信任</a>
<a href=/icorer_blog/tags/%E9%AB%98%E6%80%A7%E8%83%BD/>高性能</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=/icorer_blog/index.xml><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/lb_icefirelabs><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/gitsrc><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 笔迹-工匠之芯 2023</p></div></div></div></footer><script src=/icorer_blog/js/jquery.min.js></script>
<script src=/icorer_blog/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/icorer_blog/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/icorer_blog/js/simple-jekyll-search.min.js></script>
<script src=/icorer_blog/js/search.min.7d1445cf07369bca2715d9f63738c16c73a7a2273a95d6729bee561f7e84c6c8.js></script>
<script src=/icorer_blog/zoomjs/zoom.min.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB37D8LWFT"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VB37D8LWFT")</script></body></html>