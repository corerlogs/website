<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon type=image/ico sizes=16x16 href=https://icorer.com/icorer_blog/posts/web3/imgs/b5efa1d164a14e6ba57ddc42da306102.png><meta property="og:image" content="https://icorer.com/icorer_blog/posts/web3/imgs/b5efa1d164a14e6ba57ddc42da306102.png"><title>Tendermint ABCI分布式KV存储引擎分析 | 笔迹-工匠之芯</title>
<meta name=author content="LB"><meta name=description content="背景介绍 1.Tendermint KV 模块分析 1.1 ABCI应用拦截Tendermint状态机 1.2 ABCI应用Application结构体分析 1.3 ABCI应用处理Tendermint 区块Deliver事务 1.4 ABCI应用处理Tendermint 区块Commit事务 1.5 ABCI应用处理Tendermint 区块Query事务 1.6 ABCI应用处理Tendermint 区块Check事务 1.7 KV存储引擎状态处理 2.Tendermint KV运行实践 2.1 安装Tendermint 2.1.1 二进制安装 2.1.3 源代码安装 2.1.3 运行Tendermint 2.1.4 重新安装 2.2 Tendermint KV编译及运行 2.3 Tendermint KV 运行测试 2.3.1 Tendermint Core RPC 交易广播 2.3.2 Tendermint Core RPC 查询广播 3.总结 附录 背景介绍Tendermint 是一个基于共识算法的分布式系统，它提供了一种在去中心化环境下实现可靠、安全、高效的数据存储和交互的方法。在这个环境中，一个分布式 KV 存储引擎是非常有用的，它可以让不同的节点在共享一个数据集合的同时保持数据的一致性和可靠性。
Tendermint 为分布式 KV 存储引擎提供了一些核心组件，其中最重要的是 ABCI（Application Blockchain Interface）接口和 KV 存储引擎。ABCI 接口定义了应用程序和 Tendermint Core 之间的交互协议，它规定了应用程序需要实现哪些方法以处理交易、查询和状态更改。Tendermint开源的 ts-db存储引擎则提供了一个标准的键值存储接口，可以将数据持久化到磁盘中，同时支持可插拔的存储引擎（例如 LevelDB、RocksDB 等）。"><meta name=keywords content="blog,博客,工匠之芯,笔迹-工匠之芯"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tendermint ABCI分布式KV存储引擎分析"><meta name=twitter:description content="背景介绍 1.Tendermint KV 模块分析 1.1 ABCI应用拦截Tendermint状态机 1.2 ABCI应用Application结构体分析 1.3 ABCI应用处理Tendermint 区块Deliver事务 1.4 ABCI应用处理Tendermint 区块Commit事务 1.5 ABCI应用处理Tendermint 区块Query事务 1.6 ABCI应用处理Tendermint 区块Check事务 1.7 KV存储引擎状态处理 2.Tendermint KV运行实践 2.1 安装Tendermint 2.1.1 二进制安装 2.1.3 源代码安装 2.1.3 运行Tendermint 2.1.4 重新安装 2.2 Tendermint KV编译及运行 2.3 Tendermint KV 运行测试 2.3.1 Tendermint Core RPC 交易广播 2.3.2 Tendermint Core RPC 查询广播 3.总结 附录 背景介绍Tendermint 是一个基于共识算法的分布式系统，它提供了一种在去中心化环境下实现可靠、安全、高效的数据存储和交互的方法。在这个环境中，一个分布式 KV 存储引擎是非常有用的，它可以让不同的节点在共享一个数据集合的同时保持数据的一致性和可靠性。
Tendermint 为分布式 KV 存储引擎提供了一些核心组件，其中最重要的是 ABCI（Application Blockchain Interface）接口和 KV 存储引擎。ABCI 接口定义了应用程序和 Tendermint Core 之间的交互协议，它规定了应用程序需要实现哪些方法以处理交易、查询和状态更改。Tendermint开源的 ts-db存储引擎则提供了一个标准的键值存储接口，可以将数据持久化到磁盘中，同时支持可插拔的存储引擎（例如 LevelDB、RocksDB 等）。"><meta name=twitter:site content="@lb_icefirelabs"><meta property="og:title" content="Tendermint ABCI分布式KV存储引擎分析"><meta property="og:description" content="背景介绍 1.Tendermint KV 模块分析 1.1 ABCI应用拦截Tendermint状态机 1.2 ABCI应用Application结构体分析 1.3 ABCI应用处理Tendermint 区块Deliver事务 1.4 ABCI应用处理Tendermint 区块Commit事务 1.5 ABCI应用处理Tendermint 区块Query事务 1.6 ABCI应用处理Tendermint 区块Check事务 1.7 KV存储引擎状态处理 2.Tendermint KV运行实践 2.1 安装Tendermint 2.1.1 二进制安装 2.1.3 源代码安装 2.1.3 运行Tendermint 2.1.4 重新安装 2.2 Tendermint KV编译及运行 2.3 Tendermint KV 运行测试 2.3.1 Tendermint Core RPC 交易广播 2.3.2 Tendermint Core RPC 查询广播 3.总结 附录 背景介绍Tendermint 是一个基于共识算法的分布式系统，它提供了一种在去中心化环境下实现可靠、安全、高效的数据存储和交互的方法。在这个环境中，一个分布式 KV 存储引擎是非常有用的，它可以让不同的节点在共享一个数据集合的同时保持数据的一致性和可靠性。
Tendermint 为分布式 KV 存储引擎提供了一些核心组件，其中最重要的是 ABCI（Application Blockchain Interface）接口和 KV 存储引擎。ABCI 接口定义了应用程序和 Tendermint Core 之间的交互协议，它规定了应用程序需要实现哪些方法以处理交易、查询和状态更改。Tendermint开源的 ts-db存储引擎则提供了一个标准的键值存储接口，可以将数据持久化到磁盘中，同时支持可插拔的存储引擎（例如 LevelDB、RocksDB 等）。"><meta property="og:type" content="article"><meta property="og:url" content="https://icorer.com/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-23T21:25:16+08:00"><meta property="article:modified_time" content="2023-05-23T21:25:16+08:00"><link rel=stylesheet href=/icorer_blog/css/bootstrap.min.css crossorigin=anonymous><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/icorer_blog/sass/main.css><link rel=stylesheet href=/icorer_blog/zoomjs/zoom.min.css><script src=/icorer_blog/js/lazysizes.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/icorer_blog/apple-touch-icon.png><link rel=manifest href=/icorer_blog/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://icorer.com/icorer_blog/>笔迹-工匠之芯</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=https://icorer.com title=工匠之芯>工匠之芯</a></li><li><a href=https://icorer.com/icorer_about title=关于我>关于我</a></li><li><a href=https://github.com/gitsrc title=开源仓库>开源仓库</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder=内容搜索...></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/icorer_blog/tags/web3/ title=web3>web3</a>
<a class=tag href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/ title=区块链>区块链</a>
<a class=tag href=/icorer_blog/tags/blockchain/ title=blockchain>blockchain</a>
<a class=tag href=/icorer_blog/tags/tendermint/ title=Tendermint>Tendermint</a>
<a class=tag href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ title=数据库>数据库</a>
<a class=tag href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/ title=新架构>新架构</a>
<a class=tag href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/ title=底层研究>底层研究</a>
<a class=tag href=/icorer_blog/tags/%E8%B7%A8%E9%93%BE/ title=跨链>跨链</a>
<a class=tag href=/icorer_blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/ title=分布式>分布式</a></div><h1>Tendermint ABCI分布式KV存储引擎分析</h1><h2 class=subheading></h2><span class=meta>Posted by LB
on Tue, May 23, 2023</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><figure><a class=paragraph-image><img data-src=../imgs/b5efa1d164a14e6ba57ddc42da306102.png data-action=zoom alt=SSI class=lazyload></a></figure></p><ul><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#%e8%83%8c%e6%99%af%e4%bb%8b%e7%bb%8d>背景介绍</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#1tendermint-kv-%e6%a8%a1%e5%9d%97%e5%88%86%e6%9e%90>1.Tendermint KV 模块分析</a><ul><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#11-abci%e5%ba%94%e7%94%a8%e6%8b%a6%e6%88%aatendermint%e7%8a%b6%e6%80%81%e6%9c%ba>1.1 ABCI应用拦截Tendermint状态机</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#12-abci%e5%ba%94%e7%94%a8application%e7%bb%93%e6%9e%84%e4%bd%93%e5%88%86%e6%9e%90>1.2 ABCI应用Application结构体分析</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#13-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97deliver%e4%ba%8b%e5%8a%a1>1.3 ABCI应用处理Tendermint 区块Deliver事务</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#14-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97commit%e4%ba%8b%e5%8a%a1>1.4 ABCI应用处理Tendermint 区块Commit事务</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#15-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97query%e4%ba%8b%e5%8a%a1>1.5 ABCI应用处理Tendermint 区块Query事务</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#16-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97check%e4%ba%8b%e5%8a%a1>1.6 ABCI应用处理Tendermint 区块Check事务</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#17-kv%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8e%e7%8a%b6%e6%80%81%e5%a4%84%e7%90%86>1.7 KV存储引擎状态处理</a></li></ul></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#2tendermint-kv%e8%bf%90%e8%a1%8c%e5%ae%9e%e8%b7%b5>2.Tendermint KV运行实践</a><ul><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#21-%e5%ae%89%e8%a3%85tendermint>2.1 安装Tendermint</a><ul><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#211-%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%ae%89%e8%a3%85>2.1.1 二进制安装</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#213-%e6%ba%90%e4%bb%a3%e7%a0%81%e5%ae%89%e8%a3%85>2.1.3 源代码安装</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#213-%e8%bf%90%e8%a1%8ctendermint>2.1.3 运行Tendermint</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#214-%e9%87%8d%e6%96%b0%e5%ae%89%e8%a3%85>2.1.4 重新安装</a></li></ul></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#22-tendermint-kv%e7%bc%96%e8%af%91%e5%8f%8a%e8%bf%90%e8%a1%8c>2.2 Tendermint KV编译及运行</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#23-tendermint-kv-%e8%bf%90%e8%a1%8c%e6%b5%8b%e8%af%95>2.3 Tendermint KV 运行测试</a><ul><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#231-tendermint-core-rpc-%e4%ba%a4%e6%98%93%e5%b9%bf%e6%92%ad>2.3.1 Tendermint Core RPC 交易广播</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#232-tendermint-core-rpc-%e6%9f%a5%e8%af%a2%e5%b9%bf%e6%92%ad>2.3.2 Tendermint Core RPC 查询广播</a></li></ul></li></ul></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#3%e6%80%bb%e7%bb%93>3.总结</a></li><li><a href=/icorer_blog/posts/web3/tendermint-distributed-kv-storage-engine-analysis/#%e9%99%84%e5%bd%95>附录</a></li></ul><h1 id=背景介绍>背景介绍<a class=anchorjs-link href=#%e8%83%8c%e6%99%af%e4%bb%8b%e7%bb%8d></a></h1><p>Tendermint 是一个基于共识算法的分布式系统，它提供了一种在去中心化环境下实现可靠、安全、高效的数据存储和交互的方法。在这个环境中，一个分布式 KV 存储引擎是非常有用的，它可以让不同的节点在共享一个数据集合的同时保持数据的一致性和可靠性。</p><p>Tendermint 为分布式 KV 存储引擎提供了一些核心组件，其中最重要的是 ABCI（Application Blockchain Interface）接口和 KV 存储引擎。ABCI 接口定义了应用程序和 Tendermint Core 之间的交互协议，它规定了应用程序需要实现哪些方法以处理交易、查询和状态更改。Tendermint开源的 ts-db存储引擎则提供了一个标准的键值存储接口，可以将数据持久化到磁盘中，同时支持可插拔的存储引擎（例如 LevelDB、RocksDB 等）。</p><p>本文将分析一个Tendermint ABCI场景下的小型KV存储实现，帮助读者发散去中心化可信领域的应用思考。</p><h1 id=1tendermint-kv-模块分析>1.Tendermint KV 模块分析<a class=anchorjs-link href=#1tendermint-kv-%e6%a8%a1%e5%9d%97%e5%88%86%e6%9e%90></a></h1><p>由于链上数据不可篡改的属性，区块链被广泛应用于存证溯源等业务场景。Tendermint KV是一个基于Tendermint的分布式key-value数据库的实现案例，KV存储引擎使用了Tendermint的ABCI能力。Tendermint KV数据库核心逻辑是对于key-value数据对进行持久化和查询。</p><p>Tendermint Core负责将需要存储的key-value数据对传给Tendermint KV数据库应用，KV数据库应用负责键值对的存储，并在收到查询请求时将键值对返回。</p><h2 id=11-abci应用拦截tendermint状态机>1.1 ABCI应用拦截Tendermint状态机<a class=anchorjs-link href=#11-abci%e5%ba%94%e7%94%a8%e6%8b%a6%e6%88%aatendermint%e7%8a%b6%e6%80%81%e6%9c%ba></a></h2><p>任何ABCI应用需要构建<code>Application</code>结构体，<code>Application</code> 结构体需要内嵌<code>types.BaseApplication</code>的接口类型，<code>types.BaseApplication</code>包含所有的ABCI方法，因此<code>Application</code>继承了所有的ABCI方法。在初始化<code>Application</code>时，使用<code>BaseApplication</code>作为该<code>Application</code>接口的实现。<code>BaseApplication</code>是一个空的结构体，其ABCI方法实现内部不做任何计算，对于核心DeliverTx()、CheckTx()、Query()方法直接返回CodeTypeOK，对于其他方案则直接返回空值。KV数据库引擎通过重新定义其中一些方法的实现，<code>Application</code>可以基于<code>BaseApplication</code>定义自己的业务逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>type</span> BaseApplication <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>NewBaseApplication</span>() <span style=color:#ff79c6>*</span>BaseApplication {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>&amp;</span>BaseApplication{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>//提供有关应用程序的基本信息,支撑节点加入
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>Info</span>(req RequestInfo) ResponseInfo {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#ff79c6>return</span> ResponseInfo{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>//设置应用程序的选项
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>SetOption</span>(req RequestSetOption) ResponseSetOption {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#ff79c6>return</span> ResponseSetOption{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4>//处理从Tendermint Core传入的交易
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>DeliverTx</span>(req RequestDeliverTx) ResponseDeliverTx {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#ff79c6>return</span> ResponseDeliverTx{Code: CodeTypeOK}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4>//验证传入的交易是否有效
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>CheckTx</span>(req RequestCheckTx) ResponseCheckTx {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#ff79c6>return</span> ResponseCheckTx{Code: CodeTypeOK}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4>//区块提交Hook函数，在区块提交之前，对应用程序状态进行任何必要的修改
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>Commit</span>() ResponseCommit {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#ff79c6>return</span> ResponseCommit{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4>//客户端查询应用程序状态
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>Query</span>(req RequestQuery) ResponseQuery {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#ff79c6>return</span> ResponseQuery{Code: CodeTypeOK}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4>//在应用程序启动时执行，用于初始化应用程序状态
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>InitChain</span>(req RequestInitChain) ResponseInitChain {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	<span style=color:#ff79c6>return</span> ResponseInitChain{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#6272a4>//新的块开始处理之前调用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>BeginBlock</span>(req RequestBeginBlock) ResponseBeginBlock {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#ff79c6>return</span> ResponseBeginBlock{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4>//在新的块处理完成之后调用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>EndBlock</span>(req RequestEndBlock) ResponseEndBlock {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#ff79c6>return</span> ResponseEndBlock{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#6272a4>//列出可用的快照
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>ListSnapshots</span>(req RequestListSnapshots) ResponseListSnapshots {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>	<span style=color:#ff79c6>return</span> ResponseListSnapshots{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#6272a4>//提供一个快照
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>OfferSnapshot</span>(req RequestOfferSnapshot) ResponseOfferSnapshot {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>	<span style=color:#ff79c6>return</span> ResponseOfferSnapshot{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4>//加载一个快照块
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>LoadSnapshotChunk</span>(req RequestLoadSnapshotChunk) ResponseLoadSnapshotChunk {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>	<span style=color:#ff79c6>return</span> ResponseLoadSnapshotChunk{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#6272a4>//将快照块应用于应用程序状态
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (BaseApplication) <span style=color:#50fa7b>ApplySnapshotChunk</span>(req RequestApplySnapshotChunk) ResponseApplySnapshotChunk {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>	<span style=color:#ff79c6>return</span> ResponseApplySnapshotChunk{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>}
</span></span></code></pre></div><p>这些方法是 Tendermint Core 与 ABCI 应用程序之间的接口，应用程序需要实现它们以处理 Tendermint 区块链上的交易和状态更改。在这个代码中，所有的方法都被实现为空方法，返回一个响应对象，这些响应对象都包含一个响应码 <code>CodeTypeOK</code>，表示操作成功完成。这样的实现是为了在定义 ABCI 应用程序时提供一个基础框架，开发人员可以根据自己的需求来实现这些方法，通过接口实现Tendermint 区块链状态机Hook功能。</p><h2 id=12-abci应用application结构体分析>1.2 ABCI应用Application结构体分析<a class=anchorjs-link href=#12-abci%e5%ba%94%e7%94%a8application%e7%bb%93%e6%9e%84%e4%bd%93%e5%88%86%e6%9e%90></a></h2><p>上层应用的核心数据结构体是Application，结构体及非事务性的方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>type</span> Application <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	types.BaseApplication <span style=color:#6272a4>//ABCI接口类型，直接继承所有的ABCI方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	state        State <span style=color:#6272a4>//状态结构体：包含数据库存储、
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>	RetainBlocks <span style=color:#8be9fd>int64</span> <span style=color:#6272a4>//提交后保留的块（通过 ResponseCommit.RetainHeight）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>type</span> State <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#6272a4>//Tendermint 抽象的ts-db对象，对不同的底层存储引擎进行抽象：leveldb、rocksdb...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>	<span style=color:#6272a4>//https://github.com/tendermint/tm-db
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>  db      dbm.DB 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#6272a4>//KV存储引擎中存储的键值对条目数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>	Size    <span style=color:#8be9fd>int64</span>  <span style=color:#f1fa8c>`json:&#34;size&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#6272a4>//Tendermint Core的区块高度
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>	Height  <span style=color:#8be9fd>int64</span>  <span style=color:#f1fa8c>`json:&#34;height&#34;`</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	AppHash []<span style=color:#8be9fd>byte</span> <span style=color:#f1fa8c>`json:&#34;app_hash&#34;`</span> <span style=color:#6272a4>//KV数据库-TendermintCore在Commit之后的应用状态hash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4>//创建一个新app应用，这个app应用兼容ABCI接口标准
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>//可以被ABCI-Server加载，承载Tendermint的事务
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>NewApplication</span>() <span style=color:#ff79c6>*</span>Application {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	<span style=color:#6272a4>//此处根据一个内存数据库对象进行加载状态
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>	state <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>loadState</span>(dbm.<span style=color:#50fa7b>NewMemDB</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>&amp;</span>Application{state: state}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>func</span> (app <span style=color:#ff79c6>*</span>Application) <span style=color:#50fa7b>Info</span>(req types.RequestInfo) (resInfo types.ResponseInfo) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	<span style=color:#ff79c6>return</span> types.ResponseInfo{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>		Data:             fmt.<span style=color:#50fa7b>Sprintf</span>(<span style=color:#f1fa8c>&#34;{\&#34;size\&#34;:%v}&#34;</span>, app.state.Size),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>		Version:          version.ABCIVersion,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>		AppVersion:       ProtocolVersion,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		LastBlockHeight:  app.state.Height,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>		LastBlockAppHash: app.state.AppHash,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>}
</span></span></code></pre></div><p><code>Application</code> 结构体类型继承了 <code>types.BaseApplication</code> 接口类型的所有方法，因此可以被用作 ABCI（Application Blockchain Interface）接口的实现，以处理 Tendermint 区块链上的事务。</p><p><code>State</code> 结构体类型包含一个名为 <code>db</code> 的 <code>dbm.DB</code> 类型字段，该字段抽象了 ts-db 对象，并对不同的底层存储引擎（如 leveldb、rocksdb 等）进行了引擎包装。此外，<code>State</code> 结构体类型还包含三个属性：<code>Size</code> 表示 KV 存储引擎中存储的键值对条目数，<code>Height</code> 表示 Tendermint Core 的区块高度，<code>AppHash</code> 表示 KV 数据库-Tendermint Core 在 Commit 之后的应用状态哈希。</p><p><code>NewApplication</code> 函数创建一个新的 <code>Application</code> 类型的实例，并加载一个内存数据库对象作为其状态。该函数返回一个指向新实例的指针。</p><p><code>Application</code> 结构体重写了ABCI的<code>Info</code> 函数，该方法旨在提供有关应用程序的基本信息。在 Tendermint 中，当一个新的节点连接到网络并准备加入到共识中时，它会调用 <code>Info</code> 方法以获取有关应用程序的信息。</p><ul><li><code>Version</code> 表示 ABCI 版本，该版本号由 Tendermint Core 定义。</li><li><code>AppVersion</code> 表示应用程序协议版本，该版本号由应用程序开发人员定义。</li><li><code>LastBlockHeight</code> 表示上一个块的高度，这个高度将由 Tendermint Core 节点返回给应用程序。</li><li><code>LastBlockAppHash</code> 表示上一个块的应用状态哈希，这个哈希将由 Tendermint Core 节点返回给应用程序。</li></ul><h2 id=13-abci应用处理tendermint-区块deliver事务>1.3 ABCI应用处理Tendermint 区块Deliver事务<a class=anchorjs-link href=#13-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97deliver%e4%ba%8b%e5%8a%a1></a></h2><p>ABCI应用程序通过重写实现Tendermint Core的DeliverTx接口函数，可以拦截Tendermint Core的事务转播状态机，在重写DeliverTx接口函数的过程中，可以加入应用自我的业务逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>func</span> (app <span style=color:#ff79c6>*</span>Application) <span style=color:#50fa7b>DeliverTx</span>(req types.RequestDeliverTx) types.ResponseDeliverTx {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#8be9fd;font-style:italic>var</span> key, value []<span style=color:#8be9fd>byte</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#6272a4>//解析Tendermint Core传来的区块事务请求
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>	parts <span style=color:#ff79c6>:=</span> bytes.<span style=color:#50fa7b>Split</span>(req.Tx, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;=&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>len</span>(parts) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>		key, value = parts[<span style=color:#bd93f9>0</span>], parts[<span style=color:#bd93f9>1</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		key, value = req.Tx, req.Tx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	err <span style=color:#ff79c6>:=</span> app.state.db.<span style=color:#50fa7b>Set</span>(<span style=color:#50fa7b>prefixKey</span>(key), value)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	app.state.Size<span style=color:#ff79c6>++</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	events <span style=color:#ff79c6>:=</span> []types.Event{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>			Type: <span style=color:#f1fa8c>&#34;app&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>			Attributes: []types.EventAttribute{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>				{Key: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;creator&#34;</span>), Value: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;Cosmoshi Netowoko&#34;</span>), Index: <span style=color:#ff79c6>true</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>				{Key: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;key&#34;</span>), Value: key, Index: <span style=color:#ff79c6>true</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>				{Key: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;index_key&#34;</span>), Value: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;index is working&#34;</span>), Index: <span style=color:#ff79c6>true</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>				{Key: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;noindex_key&#34;</span>), Value: []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;index is working&#34;</span>), Index: <span style=color:#ff79c6>false</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4>types.ResponseDeliverTx 对象，其中 Code 字段被设置为 code.CodeTypeOK，表示交易已成功处理
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4>Events 字段包含了刚刚创建的事件。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>这个响应对象将发送回 Tendermint Core，以便它可以将结果广播给其他节点并更新区块链状态。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	<span style=color:#ff79c6>return</span> types.ResponseDeliverTx{Code: code.CodeTypeOK, Events: events}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>}
</span></span></code></pre></div><p>代码实现了 ABCI 接口中的 <code>DeliverTx</code> 方法，该方法用于处理传入的交易。在这个 KV 存储引擎中，交易被表示为一个键值对，其中键和值之间用等号分隔。这个方法首先从传入的请求中解析出键值对，并将它们保存到存储引擎中。具体来说，它使用 <code>bytes.Split</code> 函数将请求的 <code>Tx</code> 字段分割为两个部分，并将它们保存到 <code>key</code> 和 <code>value</code> 变量中。如果请求中只包含一个值，则将 <code>key</code> 和 <code>value</code> 设置为相同。接下来，它使用存储引擎的 <code>Set</code> 方法将键值对保存到存储中，并将存储大小加1。</p><p>除了保存键值对外，该方法还创建了一些事件并将它们返回给 Tendermint Core。这些事件将包含有关交易的信息，例如交易的创造者、键、索引键等。这些事件可以被 Tendermint Core 捕获并广播给其他节点，以便它们也能了解交易的细节。</p><h2 id=14-abci应用处理tendermint-区块commit事务>1.4 ABCI应用处理Tendermint 区块Commit事务<a class=anchorjs-link href=#14-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97commit%e4%ba%8b%e5%8a%a1></a></h2><p>Tendermint在区块提交阶段，可以被ABCI应用程序拦截，对于应用程序来说，需要在这阶段实现状态保存。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>func</span> (app <span style=color:#ff79c6>*</span>Application) <span style=color:#50fa7b>Commit</span>() types.ResponseCommit {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#6272a4>// Using a memdb - just return the big endian size of the db
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>	appHash <span style=color:#ff79c6>:=</span> <span style=color:#8be9fd;font-style:italic>make</span>([]<span style=color:#8be9fd>byte</span>, <span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	binary.<span style=color:#50fa7b>PutVarint</span>(appHash, app.state.Size)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	app.state.AppHash = appHash
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	app.state.Height<span style=color:#ff79c6>++</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#50fa7b>saveState</span>(app.state) <span style=color:#6272a4>//自定义应用数据保存逻辑
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	resp <span style=color:#ff79c6>:=</span> types.ResponseCommit{Data: appHash}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#ff79c6>if</span> app.RetainBlocks &gt; <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> app.state.Height <span style=color:#ff79c6>&gt;=</span> app.RetainBlocks {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		resp.RetainHeight = app.state.Height <span style=color:#ff79c6>-</span> app.RetainBlocks <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#ff79c6>return</span> resp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>代码实现了 ABCI 接口中的 <code>Commit</code> 方法，该方法用于在区块提交之前，对应用程序状态进行必要的修改。在这个 KV 存储引擎中，该方法使用一个内存数据库（memdb）来存储数据，并将该数据库的大小编码为一个字节数组，作为应用程序哈希值返回给 Tendermint Core。</p><p>函数返回一个 <code>types.ResponseCommit</code> 对象，其中 <code>Data</code> 字段被设置为应用程序哈希值，表示已经将当前状态提交到区块链中。如果应用程序设置了保留块数（<code>RetainBlocks</code>）并且当前高度超过了该值，那么 <code>resp.RetainHeight</code> 字段将被设置为需要保留的最早高度，以便 Tendermint Core 可以删除旧的区块并释放资源。</p><h2 id=15-abci应用处理tendermint-区块query事务>1.5 ABCI应用处理Tendermint 区块Query事务<a class=anchorjs-link href=#15-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97query%e4%ba%8b%e5%8a%a1></a></h2><p>ABCI应用通过重写Tendermint Query接口函数，可以实现对于Tendermint Core查询阶段状态机的拦截。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// Returns an associated value or nil if missing.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (app <span style=color:#ff79c6>*</span>Application) <span style=color:#50fa7b>Query</span>(reqQuery types.RequestQuery) (resQuery types.ResponseQuery) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#ff79c6>if</span> reqQuery.Prove {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>		value, err <span style=color:#ff79c6>:=</span> app.state.db.<span style=color:#50fa7b>Get</span>(<span style=color:#50fa7b>prefixKey</span>(reqQuery.Data))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>		<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>			<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		<span style=color:#ff79c6>if</span> value <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>			resQuery.Log = <span style=color:#f1fa8c>&#34;does not exist&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>			resQuery.Log = <span style=color:#f1fa8c>&#34;exists&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		resQuery.Index = <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#6272a4>// TODO make Proof return index
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>		resQuery.Key = reqQuery.Data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		resQuery.Value = value
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		resQuery.Height = app.state.Height
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		<span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	resQuery.Key = reqQuery.Data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	value, err <span style=color:#ff79c6>:=</span> app.state.db.<span style=color:#50fa7b>Get</span>(<span style=color:#50fa7b>prefixKey</span>(reqQuery.Data))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	<span style=color:#ff79c6>if</span> value <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		resQuery.Log = <span style=color:#f1fa8c>&#34;does not exist&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>		resQuery.Log = <span style=color:#f1fa8c>&#34;exists&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	resQuery.Value = value
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	resQuery.Height = app.state.Height
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	<span style=color:#ff79c6>return</span> resQuery
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>}
</span></span></code></pre></div><p>Query函数实现了一个查询存储中特定键值对的功能，如果请求中指定了 <code>reqQuery.Prove</code> 参数为 <code>true</code>，那么查询结果将包含一个证明，证明该键值对确实存在于存储中。否则，查询结果只会返回该键值对的值。如果键不存在，查询结果将返回一个错误信息。</p><p>具体实现中，如果请求中的 <code>reqQuery.Prove</code> 参数为 <code>true</code>，则会得到包含三个主要信息的查询结果：该键值对是否存在、键值对的值以及存储的当前高度。如果 <code>reqQuery.Prove</code> 参数为 <code>false</code>，则查询结果仅包含键值对的值、存在性状态和存储的当前高度。</p><h2 id=16-abci应用处理tendermint-区块check事务>1.6 ABCI应用处理Tendermint 区块Check事务<a class=anchorjs-link href=#16-abci%e5%ba%94%e7%94%a8%e5%a4%84%e7%90%86tendermint-%e5%8c%ba%e5%9d%97check%e4%ba%8b%e5%8a%a1></a></h2><p><code>CheckTx</code> 函数实际上是在做交易（Tx）的校验工作。每次有交易进入系统时，都会调用 <code>CheckTx</code> 函数对其进行校验，以确保交易符合系统规则并且是有效的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>func</span> (app <span style=color:#ff79c6>*</span>Application) <span style=color:#50fa7b>CheckTx</span>(req types.RequestCheckTx) types.ResponseCheckTx {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#ff79c6>return</span> types.ResponseCheckTx{Code: code.CodeTypeOK, GasWanted: <span style=color:#bd93f9>1</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>在这个 KV 存储引擎中，<code>CheckTx</code> 函数主要是进行一些简单的校验，如检查交易的大小是否合法。如果交易是有效的，则函数返回 <code>code.CodeTypeOK</code>，表示交易通过了校验；否则函数返回一个错误代码，表示交易未通过校验。</p><p>这个函数的主要作用是确保交易的合法性，不会对存储状态产生影响。因此，如果交易未通过校验，它将不被接受并且不会对存储状态做任何更改。</p><h2 id=17-kv存储引擎状态处理>1.7 KV存储引擎状态处理<a class=anchorjs-link href=#17-kv%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8e%e7%8a%b6%e6%80%81%e5%a4%84%e7%90%86></a></h2><p>State对象实现了一个存储引擎的状态管理功能，用于维护存储引擎的一些状态信息。具体来说，<code>State</code> 结构体包含了存储引擎的数据库连接、存储中键值对的数量、当前高度以及哈希值等信息。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>type</span> State <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	db      dbm.DB
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	Size    <span style=color:#8be9fd>int64</span>  <span style=color:#f1fa8c>`json:&#34;size&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	Height  <span style=color:#8be9fd>int64</span>  <span style=color:#f1fa8c>`json:&#34;height&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	AppHash []<span style=color:#8be9fd>byte</span> <span style=color:#f1fa8c>`json:&#34;app_hash&#34;`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>loadState</span>(db dbm.DB) State {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#8be9fd;font-style:italic>var</span> state State
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	state.db = db
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	stateBytes, err <span style=color:#ff79c6>:=</span> db.<span style=color:#50fa7b>Get</span>(stateKey)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>len</span>(stateBytes) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		<span style=color:#ff79c6>return</span> state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	err = json.<span style=color:#50fa7b>Unmarshal</span>(stateBytes, <span style=color:#ff79c6>&amp;</span>state)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	<span style=color:#ff79c6>return</span> state
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>saveState</span>(state State) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	stateBytes, err <span style=color:#ff79c6>:=</span> json.<span style=color:#50fa7b>Marshal</span>(state)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	err = state.db.<span style=color:#50fa7b>Set</span>(stateKey, stateBytes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		<span style=color:#8be9fd;font-style:italic>panic</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>}
</span></span></code></pre></div><p><code>loadState</code> 函数用于从存储引擎的数据库中加载状态信息。它首先创建一个 <code>State</code> 结构体，并将数据库连接保存到其中。然后，它使用 <code>db.Get</code> 方法从数据库中获取 <code>stateKey</code> 对应的值，并将其存储到变量 <code>stateBytes</code> 中。如果获取值的过程中发生了错误，则会抛出一个异常。接着，它使用 <code>json.Unmarshal</code> 函数将 <code>stateBytes</code> 反序列化为 <code>State</code> 结构体，并将其存储到变量 <code>state</code> 中。如果反序列化过程中发生了错误，则会抛出一个异常。最后，函数返回 <code>state</code> 变量，其中包含了从数据库中加载的状态信息。</p><p><code>saveState</code> 函数用于将 <code>State</code> 结构体保存到存储引擎的数据库中。它首先使用 <code>json.Marshal</code> 函数将 <code>State</code> 结构体序列化为字节数组，并将其存储到变量 <code>stateBytes</code> 中。如果序列化过程中发生了错误，则会抛出一个异常。接着，它使用 <code>db.Set</code> 方法将 <code>stateBytes</code> 存储到数据库中，对应的键为 <code>stateKey</code>。如果存储过程中发生了错误，则会抛出一个异常。</p><h1 id=2tendermint-kv运行实践>2.Tendermint KV运行实践<a class=anchorjs-link href=#2tendermint-kv%e8%bf%90%e8%a1%8c%e5%ae%9e%e8%b7%b5></a></h1><h2 id=21-安装tendermint>2.1 安装Tendermint<a class=anchorjs-link href=#21-%e5%ae%89%e8%a3%85tendermint></a></h2><h3 id=211-二进制安装>2.1.1 二进制安装<a class=anchorjs-link href=#211-%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%ae%89%e8%a3%85></a></h3><p>Tendermint提供了构建好的二进制文件，可以通过<a href=https://github.com/tendermint/tendermint/releases target=_blank>releases</a>获得。</p><h3 id=213-源代码安装>2.1.3 源代码安装<a class=anchorjs-link href=#213-%e6%ba%90%e4%bb%a3%e7%a0%81%e5%ae%89%e8%a3%85></a></h3><p>你需要安装go环境，以下是一些环境变量的操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>echo <span style=color:#ff79c6>export</span> GOPATH<span style=color:#ff79c6>=</span>\<span style=color:#f1fa8c>&#34;\$HOME/go</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c> &gt;&gt; ~/.bash_profile</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>echo <span style=color:#ff79c6>export</span> PATH<span style=color:#ff79c6>=</span>\<span style=color:#f1fa8c>&#34;\$PATH:\$GOPATH/bin</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c> &gt;&gt; ~/.bash_profile</span>
</span></span></code></pre></div><p>获取源代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>git clone https://github.com/tendermint/tendermint.git
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>cd tendermint
</span></span></code></pre></div><p>代码编译</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make install
</span></span></code></pre></div><p>把二进制文件放在<code>$GOPATH/bin</code> ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make build
</span></span></code></pre></div><p>make build指令会把编译好的二进制文件放在 <code>./build</code> 目录。</p><p>免责声明： Tendermint 的二进制文件是在没有 DWARF 符号表的情况下构建/安装的。如果您想使用 DWARF 符号和调试信息构建/安装 Tendermint，请从 make 文件中的 BUILD_FLAGS 中删除 -s -w 。</p><p>这样最新版的Tendermint就安装结束了，你可以通过运行来验证安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>tendermint version
</span></span></code></pre></div><h3 id=213-运行tendermint>2.1.3 运行Tendermint<a class=anchorjs-link href=#213-%e8%bf%90%e8%a1%8ctendermint></a></h3><p>快速启动一个节点的区块链，使用内部的kvstore存储引擎：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>tendermint init
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4># tendermint node --proxy_app=kvstore #Tendermint本地区块存储模式</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>tendermint node <span style=color:#6272a4>#Tendermint远程RPC存储模式：此模式下，Tendermint会和上层应用进行状态机互动：默认上层应用监听地址：http://127.0.0.1:26658 ,上层应用是用户可以自我编写的业务应用，例如KV存储数据库</span>
</span></span></code></pre></div><h3 id=214-重新安装>2.1.4 重新安装<a class=anchorjs-link href=#214-%e9%87%8d%e6%96%b0%e5%ae%89%e8%a3%85></a></h3><p>如果你已经安装过Tendermint，你可以通过一下命令快速更新。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make install
</span></span></code></pre></div><p>如果需要更新，请运行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>git pull origin master
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>make install
</span></span></code></pre></div><h2 id=22-tendermint-kv编译及运行>2.2 Tendermint KV编译及运行<a class=anchorjs-link href=#22-tendermint-kv%e7%bc%96%e8%af%91%e5%8f%8a%e8%bf%90%e8%a1%8c></a></h2><p>针对kv存储引擎进行编译</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make install_abci
</span></span></code></pre></div><p>运行kv存储引擎</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>abci-cli kvstore
</span></span></code></pre></div><h2 id=23-tendermint-kv-运行测试>2.3 Tendermint KV 运行测试<a class=anchorjs-link href=#23-tendermint-kv-%e8%bf%90%e8%a1%8c%e6%b5%8b%e8%af%95></a></h2><h3 id=231-tendermint-core-rpc-交易广播>2.3.1 Tendermint Core RPC 交易广播<a class=anchorjs-link href=#231-tendermint-core-rpc-%e4%ba%a4%e6%98%93%e5%b9%bf%e6%92%ad></a></h3><p>使用Tendermint Core提供的RPC方法广播交易，广播交易：name=cosmos，根据Application的实现，ABCI应用会存储键值对。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>//将键值对<span style=color:#ff79c6>(</span>name,cosmos<span style=color:#ff79c6>)</span>写入kvstore存储
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>curl -s <span style=color:#f1fa8c>&#39;localhost:26657/broadcast_tx_commit?tx=&#34;name=cosmos&#34;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;jsonrpc&#34;</span>:<span style=color:#f1fa8c>&#34;2.0&#34;</span>,<span style=color:#f1fa8c>&#34;id&#34;</span>:-1,<span style=color:#f1fa8c>&#34;result&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;check_tx&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;code&#34;</span>:0,<span style=color:#f1fa8c>&#34;data&#34;</span>:null,<span style=color:#f1fa8c>&#34;log&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;info&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;gas_wanted&#34;</span>:<span style=color:#f1fa8c>&#34;1&#34;</span>,<span style=color:#f1fa8c>&#34;gas_used&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;events&#34;</span>:<span style=color:#ff79c6>[]</span>,<span style=color:#f1fa8c>&#34;codespace&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;sender&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;priority&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;mempoolError&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>}</span>,<span style=color:#f1fa8c>&#34;deliver_tx&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;code&#34;</span>:0,<span style=color:#f1fa8c>&#34;data&#34;</span>:null,<span style=color:#f1fa8c>&#34;log&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;info&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;gas_wanted&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;gas_used&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;events&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;type&#34;</span>:<span style=color:#f1fa8c>&#34;app&#34;</span>,<span style=color:#f1fa8c>&#34;attributes&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;Y3JlYXRvcg==&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;Q29zbW9zaGkgTmV0b3dva28=&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:true<span style=color:#ff79c6>}</span>,<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;a2V5&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;bmFtZQ==&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:true<span style=color:#ff79c6>}</span>,<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;aW5kZXhfa2V5&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;aW5kZXggaXMgd29ya2luZw==&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:true<span style=color:#ff79c6>}</span>,<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;bm9pbmRleF9rZXk=&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;aW5kZXggaXMgd29ya2luZw==&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:false<span style=color:#ff79c6>}]}]</span>,<span style=color:#f1fa8c>&#34;codespace&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>}</span>,<span style=color:#f1fa8c>&#34;hash&#34;</span>:<span style=color:#f1fa8c>&#34;6750130EC9BBAF5DB247F95356FC83F84ADD4A6524CB8807A6F91EE05272FA32&#34;</span>,<span style=color:#f1fa8c>&#34;height&#34;</span>:<span style=color:#f1fa8c>&#34;10&#34;</span><span style=color:#ff79c6>}}</span>%
</span></span></code></pre></div><h3 id=232-tendermint-core-rpc-查询广播>2.3.2 Tendermint Core RPC 查询广播<a class=anchorjs-link href=#232-tendermint-core-rpc-%e6%9f%a5%e8%af%a2%e5%b9%bf%e6%92%ad></a></h3><p>使用Tendermint Core提供的RPC方法查询ABCI数据库KV数据，查询KEY：name，根据Application的实现，ABCI应用会查询存储并返回内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>curl -s <span style=color:#f1fa8c>&#39;localhost:26657/abci_query?data=&#34;name&#34;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;jsonrpc&#34;</span>:<span style=color:#f1fa8c>&#34;2.0&#34;</span>,<span style=color:#f1fa8c>&#34;id&#34;</span>:-1,<span style=color:#f1fa8c>&#34;result&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;response&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;code&#34;</span>:0,<span style=color:#f1fa8c>&#34;log&#34;</span>:<span style=color:#f1fa8c>&#34;exists&#34;</span>,<span style=color:#f1fa8c>&#34;info&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;bmFtZQ==&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;Y29zbW9z&#34;</span>,<span style=color:#f1fa8c>&#34;proofOps&#34;</span>:null,<span style=color:#f1fa8c>&#34;height&#34;</span>:<span style=color:#f1fa8c>&#34;34&#34;</span>,<span style=color:#f1fa8c>&#34;codespace&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>}}}</span>
</span></span></code></pre></div><p>查询带有数据证明的版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>curl -s <span style=color:#f1fa8c>&#39;localhost:26657/abci_query?data=&#34;name&#34;&amp;prove=true&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;jsonrpc&#34;</span>:<span style=color:#f1fa8c>&#34;2.0&#34;</span>,<span style=color:#f1fa8c>&#34;id&#34;</span>:-1,<span style=color:#f1fa8c>&#34;result&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;response&#34;</span>:<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;code&#34;</span>:0,<span style=color:#f1fa8c>&#34;log&#34;</span>:<span style=color:#f1fa8c>&#34;exists&#34;</span>,<span style=color:#f1fa8c>&#34;info&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span>,<span style=color:#f1fa8c>&#34;index&#34;</span>:<span style=color:#f1fa8c>&#34;-1&#34;</span>,<span style=color:#f1fa8c>&#34;key&#34;</span>:<span style=color:#f1fa8c>&#34;bmFtZQ==&#34;</span>,<span style=color:#f1fa8c>&#34;value&#34;</span>:<span style=color:#f1fa8c>&#34;Y29zbW9z&#34;</span>,<span style=color:#f1fa8c>&#34;proofOps&#34;</span>:null,<span style=color:#f1fa8c>&#34;height&#34;</span>:<span style=color:#f1fa8c>&#34;289&#34;</span>,<span style=color:#f1fa8c>&#34;codespace&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>}}}</span>%
</span></span></code></pre></div><h1 id=3总结>3.总结<a class=anchorjs-link href=#3%e6%80%bb%e7%bb%93></a></h1><p>这份 Tendermint ABCI 去中心化 KV 数据库简单实现了一个基于 Tendermint 技术的分布式、去中心化的键值存储引擎。它通过拦截与实现 ABCI 接口来与 Tendermint 节点交互，并且充分利用 Tendermint 的共识机制来保证数据的可信性和一致性。</p><p>在这个 KV 存储引擎中，Tendermint 提供了强大的去中心化和共识功能，确保数据的一致性和可靠性。通过 Tendermint 的共识机制，任何节点都可以验证数据的真实性，并且在出现故障时自动进行容错和恢复。因此，这个存储引擎可以实现高度的可信性和去中心化，适用于各种需要高度可靠、去中心化的数据存储场景。</p><p>Tendermint 提供了强大的去中心化功能，可以确保节点之间的平等性和自治性。这些特性使得 Tendermint 成为一个非常适合构建分布式应用程序的平台。</p><h1 id=附录>附录<a class=anchorjs-link href=#%e9%99%84%e5%bd%95></a></h1><p><a href=https://github.com/tendermint/tendermint/tree/main/abci/example/kvstore target=_blank>https://github.com/tendermint/tendermint/tree/main/abci/example/kvstore</a></p><p><strong>异常QA</strong></p><p>Q: 短时间多次broadcast_tx_commit，引发"error on broadcasttxcommit: tx already exists in cache"</p><p>A: 流量较小、Tendermint内存有事务缓存，默认队列大小为10000，设置为0即可，对于线上环境可以根据流量来观测此类日志量，进行数值降低调。整。</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/ data-toggle=tooltip data-placement=top title=EIP-4844改进提议：分片Blob事务>Previous<br><span>EIP-4844改进提议：分片Blob事务</span></a></li><li class=next><a href=/icorer_blog/posts/cosmos/cosmos-meet-cometbft/ data-toggle=tooltip data-placement=top title=CometBFT：提升Cosmos区块链共识新高度>Next<br><span>CometBFT：提升Cosmos区块链共识新高度</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/icorer_blog/tags/blockchain/>blockchain</a>
<a href=/icorer_blog/tags/clang/>CLang</a>
<a href=/icorer_blog/tags/cloudnative/>cloudnative</a>
<a href=/icorer_blog/tags/cmake/>Cmake</a>
<a href=/icorer_blog/tags/cometbft/>CometBFT</a>
<a href=/icorer_blog/tags/cosmos/>cosmos</a>
<a href=/icorer_blog/tags/dcdn/>DCDN</a>
<a href=/icorer_blog/tags/deca/>DeCA</a>
<a href=/icorer_blog/tags/depin/>DePIN</a>
<a href=/icorer_blog/tags/dpki/>DPKI</a>
<a href=/icorer_blog/tags/drand/>drand</a>
<a href=/icorer_blog/tags/eip/>EIP</a>
<a href=/icorer_blog/tags/epoll/>epoll</a>
<a href=/icorer_blog/tags/ethereum/>Ethereum</a>
<a href=/icorer_blog/tags/fpga/>FPGA</a>
<a href=/icorer_blog/tags/gc/>GC</a>
<a href=/icorer_blog/tags/golang/>GoLang</a>
<a href=/icorer_blog/tags/hackathon/>Hackathon</a>
<a href=/icorer_blog/tags/http2/>HTTP2</a>
<a href=/icorer_blog/tags/http3/>HTTP3</a>
<a href=/icorer_blog/tags/icefiredb/>IceFireDB</a>
<a href=/icorer_blog/tags/k8s/>k8s</a>
<a href=/icorer_blog/tags/kafka/>kafka</a>
<a href=/icorer_blog/tags/layer2/>Layer2</a>
<a href=/icorer_blog/tags/linux/>linux</a>
<a href=/icorer_blog/tags/nginx/>Nginx</a>
<a href=/icorer_blog/tags/nosql/>NoSQL</a>
<a href=/icorer_blog/tags/php/>PHP</a>
<a href=/icorer_blog/tags/php-kernel/>php kernel</a>
<a href=/icorer_blog/tags/php%E5%86%85%E6%A0%B8/>PHP内核</a>
<a href=/icorer_blog/tags/quic/>QUIC</a>
<a href=/icorer_blog/tags/redis/>redis</a>
<a href=/icorer_blog/tags/sbt/>SBT</a>
<a href=/icorer_blog/tags/serverless/>serverless</a>
<a href=/icorer_blog/tags/ssi/>SSI</a>
<a href=/icorer_blog/tags/tendermint/>Tendermint</a>
<a href=/icorer_blog/tags/unikernel/>unikernel</a>
<a href=/icorer_blog/tags/wanxiang/>Wanxiang</a>
<a href=/icorer_blog/tags/web3/>web3</a>
<a href=/icorer_blog/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/icorer_blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/>云原生</a>
<a href=/icorer_blog/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/>以太坊</a>
<a href=/icorer_blog/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>信息安全</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/>内存数据库</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/>内存泄漏</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81/>内核源码</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E7%A0%94%E7%A9%B6/>内核研究</a>
<a href=/icorer_blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/>分布式</a>
<a href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/>区块链</a>
<a href=/icorer_blog/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>垃圾回收</a>
<a href=/icorer_blog/tags/%E5%AD%98%E5%82%A8/>存储</a>
<a href=/icorer_blog/tags/%E5%AE%B9%E5%99%A8/>容器</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E5%BC%80%E5%8F%91/>底层开发</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/>底层研究</a>
<a href=/icorer_blog/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/>开源项目</a>
<a href=/icorer_blog/tags/%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97/>异构计算</a>
<a href=/icorer_blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>微服务</a>
<a href=/icorer_blog/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/>性能测试</a>
<a href=/icorer_blog/tags/%E6%8A%80%E6%9C%AF%E7%A7%91%E6%99%AE/>技术科普</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/>数据库技术</a>
<a href=/icorer_blog/tags/%E6%96%87%E7%AB%A0%E7%BF%BB%E8%AF%91/>文章翻译</a>
<a href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/>新架构</a>
<a href=/icorer_blog/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/>时序数据库</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/>服务治理</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/>服务网格</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E9%81%A5%E6%B5%8B/>服务遥测</a>
<a href=/icorer_blog/tags/%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/>测试报告</a>
<a href=/icorer_blog/tags/%E7%A0%94%E7%A9%B6%E6%8A%A5%E5%91%8A/>研究报告</a>
<a href=/icorer_blog/tags/%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF/>缓存技术</a>
<a href=/icorer_blog/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a>
<a href=/icorer_blog/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/>虚拟机</a>
<a href=/icorer_blog/tags/%E8%A1%8C%E4%B8%9A%E6%8A%A5%E5%91%8A/>行业报告</a>
<a href=/icorer_blog/tags/%E8%AE%BA%E6%96%87/>论文</a>
<a href=/icorer_blog/tags/%E8%B7%A8%E9%93%BE/>跨链</a>
<a href=/icorer_blog/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB/>零信任</a>
<a href=/icorer_blog/tags/%E9%AB%98%E6%80%A7%E8%83%BD/>高性能</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=/icorer_blog/index.xml><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/lb_icefirelabs><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/gitsrc><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 笔迹-工匠之芯 2023</p></div></div></div></footer><script src=/icorer_blog/js/jquery.min.js></script><script src=/icorer_blog/js/bootstrap.min.js crossorigin=anonymous></script><script src=/icorer_blog/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script><script src=/icorer_blog/js/simple-jekyll-search.min.js></script><script src=/icorer_blog/js/search.min.7d1445cf07369bca2715d9f63738c16c73a7a2273a95d6729bee561f7e84c6c8.js></script><script src=/icorer_blog/zoomjs/zoom.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VB37D8LWFT"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VB37D8LWFT")</script></body></html>