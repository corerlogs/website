<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon type=image/ico sizes=16x16 href=https://icorer.com/icorer_blog/posts/web3/imgs/EIP-4844%20-%20Reduced%20L2%20Fees/rollups-01.jpg><meta property="og:image" content="https://icorer.com/icorer_blog/posts/web3/imgs/EIP-4844%20-%20Reduced%20L2%20Fees/rollups-01.jpg"><title>EIP-4844改进提议：分片Blob事务 | 笔迹-工匠之芯</title><meta name=author content="LB"><meta name=description content="EIP-4844 分片Blob事务以简单、向前兼容的方式扩展以太坊的数据可用性。
一、摘要 二、动机 三、Specification 规范 3.1 Parameters 参数 3.2 Type aliases 类型别名 3.3 Cryptographic Helpers 加密助手 3.4 Helpers 3.5 New transaction type 新的交易类型 3.6 Header extension 头扩展 3.7 Beacon chain validation 信标链验证 3.8 Opcode to get versioned hashes 获取版本哈希的操作码 3.9 Point evaluation precompile 点评估预编译 3.10 Gas accounting 3.11 Networking 网络 四、基本原理 4.1 On the path to sharding 在分片的路上 4.2 How rollups would function 4.3 Versioned hashes & precompile return data 版本化哈希和预编译返回数据 4."><meta name=keywords content="blog,博客,工匠之芯,笔迹-工匠之芯"><meta name=twitter:card content="summary"><meta name=twitter:title content="EIP-4844改进提议：分片Blob事务"><meta name=twitter:description content="EIP-4844 分片Blob事务以简单、向前兼容的方式扩展以太坊的数据可用性。
一、摘要 二、动机 三、Specification 规范 3.1 Parameters 参数 3.2 Type aliases 类型别名 3.3 Cryptographic Helpers 加密助手 3.4 Helpers 3.5 New transaction type 新的交易类型 3.6 Header extension 头扩展 3.7 Beacon chain validation 信标链验证 3.8 Opcode to get versioned hashes 获取版本哈希的操作码 3.9 Point evaluation precompile 点评估预编译 3.10 Gas accounting 3.11 Networking 网络 四、基本原理 4.1 On the path to sharding 在分片的路上 4.2 How rollups would function 4.3 Versioned hashes & precompile return data 版本化哈希和预编译返回数据 4."><meta property="og:title" content="EIP-4844改进提议：分片Blob事务"><meta property="og:description" content="EIP-4844 分片Blob事务以简单、向前兼容的方式扩展以太坊的数据可用性。
一、摘要 二、动机 三、Specification 规范 3.1 Parameters 参数 3.2 Type aliases 类型别名 3.3 Cryptographic Helpers 加密助手 3.4 Helpers 3.5 New transaction type 新的交易类型 3.6 Header extension 头扩展 3.7 Beacon chain validation 信标链验证 3.8 Opcode to get versioned hashes 获取版本哈希的操作码 3.9 Point evaluation precompile 点评估预编译 3.10 Gas accounting 3.11 Networking 网络 四、基本原理 4.1 On the path to sharding 在分片的路上 4.2 How rollups would function 4.3 Versioned hashes & precompile return data 版本化哈希和预编译返回数据 4."><meta property="og:type" content="article"><meta property="og:url" content="https://icorer.com/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-27T23:35:16+08:00"><meta property="article:modified_time" content="2023-02-27T23:35:16+08:00"><link rel=stylesheet href=/icorer_blog/css/bootstrap.min.css crossorigin=anonymous><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/icorer_blog/sass/main.css><link rel=stylesheet href=/icorer_blog/zoomjs/zoom.min.css><script src=/icorer_blog/js/lazysizes.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/icorer_blog/apple-touch-icon.png><link rel=manifest href=/icorer_blog/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://icorer.com/icorer_blog/>笔迹-工匠之芯</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=https://icorer.com title=工匠之芯>工匠之芯</a></li><li><a href=https://icorer.com/icorer_about title=关于我>关于我</a></li><li><a href=https://github.com/gitsrc title=开源仓库>开源仓库</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder=内容搜索...></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/icorer_blog/tags/web3/ title=web3>web3</a>
<a class=tag href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/ title=区块链>区块链</a>
<a class=tag href=/icorer_blog/tags/blockchain/ title=blockchain>blockchain</a>
<a class=tag href=/icorer_blog/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/ title=以太坊>以太坊</a>
<a class=tag href=/icorer_blog/tags/ethereum/ title=Ethereum>Ethereum</a>
<a class=tag href=/icorer_blog/tags/eip/ title=EIP>EIP</a>
<a class=tag href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/ title=新架构>新架构</a>
<a class=tag href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/ title=底层研究>底层研究</a>
<a class=tag href=/icorer_blog/tags/layer2/ title=Layer2>Layer2</a></div><h1>EIP-4844改进提议：分片Blob事务</h1><h2 class=subheading></h2><span class=meta>Posted by LB
on Mon, Feb 27, 2023</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><figure><a class=paragraph-image><img data-src=../imgs/EIP-4844%20-%20Reduced%20L2%20Fees/rollups-01.jpg data-action=zoom alt=SSI class=lazyload></a></figure></p><p><a href=https://eips.ethereum.org/EIPS/eip-4844 target=_blank>EIP-4844</a> 分片Blob事务以简单、向前兼容的方式扩展以太坊的数据可用性。</p><ul><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%b8%80%e6%91%98%e8%a6%81>一、摘要</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%ba%8c%e5%8a%a8%e6%9c%ba>二、动机</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%b8%89specification-%e8%a7%84%e8%8c%83>三、Specification 规范</a><ul><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#31-parameters-%e5%8f%82%e6%95%b0>3.1 Parameters 参数</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#32-type-aliases-%e7%b1%bb%e5%9e%8b%e5%88%ab%e5%90%8d>3.2 Type aliases 类型别名</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#33-cryptographic-helpers-%e5%8a%a0%e5%af%86%e5%8a%a9%e6%89%8b>3.3 Cryptographic Helpers 加密助手</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#34-helpers>3.4 Helpers</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#35-new-transaction-type-%e6%96%b0%e7%9a%84%e4%ba%a4%e6%98%93%e7%b1%bb%e5%9e%8b>3.5 New transaction type 新的交易类型</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#36-header-extension-%e5%a4%b4%e6%89%a9%e5%b1%95>3.6 Header extension 头扩展</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#37-beacon-chain-validation%e4%bf%a1%e6%a0%87%e9%93%be%e9%aa%8c%e8%af%81>3.7 Beacon chain validation 信标链验证</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#38-opcode-to-get-versioned-hashes-%e8%8e%b7%e5%8f%96%e7%89%88%e6%9c%ac%e5%93%88%e5%b8%8c%e7%9a%84%e6%93%8d%e4%bd%9c%e7%a0%81>3.8 Opcode to get versioned hashes 获取版本哈希的操作码</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#39-point-evaluation-precompile%e7%82%b9%e8%af%84%e4%bc%b0%e9%a2%84%e7%bc%96%e8%af%91>3.9 Point evaluation precompile 点评估预编译</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#310--gas-accounting>3.10 Gas accounting</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#311-networking%e7%bd%91%e7%bb%9c>3.11 Networking 网络</a></li></ul></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e5%9b%9b%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86>四、基本原理</a><ul><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#41-on-the-path-to-sharding%e5%9c%a8%e5%88%86%e7%89%87%e7%9a%84%e8%b7%af%e4%b8%8a>4.1 On the path to sharding 在分片的路上</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#42-how-rollups-would-function>4.2 How rollups would function</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#43-versioned-hashes--precompile-return-data-%e7%89%88%e6%9c%ac%e5%8c%96%e5%93%88%e5%b8%8c%e5%92%8c%e9%a2%84%e7%bc%96%e8%af%91%e8%bf%94%e5%9b%9e%e6%95%b0%e6%8d%ae>4.3 Versioned hashes & precompile return data  版本化哈希和预编译返回数据</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#44-data-gasprice-update-rule-%e6%95%b0%e6%8d%ae-gasprice-%e6%9b%b4%e6%96%b0%e8%a7%84%e5%88%99>4.4 Data gasprice update rule 数据 gasprice 更新规则</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#45-%e5%90%9e%e5%90%90%e9%87%8f>4.5 吞吐量</a></li></ul></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%ba%94backwards-compatibility%e5%90%91%e5%90%8e%e5%85%bc%e5%ae%b9>五、Backwards Compatibility    向后兼容</a><ul><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#51-blob-non-accessibilityblob-%e4%b8%8d%e5%8f%af%e8%ae%bf%e9%97%ae>5.1 Blob non-accessibility    Blob 不可访问</a></li></ul></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e5%85%admempool-issues%e5%86%85%e5%ad%98%e6%b1%a0%e9%97%ae%e9%a2%98>六、Mempool issues    内存池问题</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%b8%83test-cases%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b>七、Test Cases    测试用例</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e5%85%absecurity-considerations%e5%ae%89%e5%85%a8%e8%80%83%e8%99%91>八、Security Considerations    安全考虑</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e4%b9%9d%e7%89%88%e6%9d%83%e6%89%80%e6%9c%89>九、版权所有</a></li><li><a href=/icorer_blog/posts/web3/eip-4844-reduced-l2-fees/#%e5%8d%81citation%e5%bc%95%e7%94%a8>十、Citation 引用</a></li></ul><h1 id=一摘要>一、摘要<a class=anchorjs-link href=#%e4%b8%80%e6%91%98%e8%a6%81></a></h1><p>为“携带blob的交易”引入一种新的交易格式，其中包含大量 EVM 执行无法访问的数据，但可以访问其承诺。该格式旨在与将在全分片中使用的格式完全兼容。</p><h1 id=二动机>二、动机<a class=anchorjs-link href=#%e4%ba%8c%e5%8a%a8%e6%9c%ba></a></h1><p><strong>Rollups 在短期和中期，甚至可能在长期内，是以太坊唯一的去信任扩展解决方案</strong>。几个月来，L1 的交易费用一直非常高，并且迫切需要做任何必要的事情来帮助促进整个生态系统转向汇总。 Rollups 显着降低了许多以太坊用户的费用：Optimism 和 Arbitrum 经常提供比以太坊基础层本身低 3-8 倍的费用，而 ZK rollups 具有更好的数据压缩并且可以避免包含签名，费用比基础层低 40-100 倍。</p><p>然而，即使这些费用对许多用户来说也太贵了。长期解决 rollups 自身长期不足的长期解决方案一直是数据分片，这将为 rollups 可以使用的链增加每块专用数据空间约 16 MB。然而，数据分片仍然需要相当长的时间才能完成实施和部署。</p><p>这个 EIP 提供了一个权宜之计解决方案，<strong>通过实现将在分片中使用的交易格式，而不是实际分片这些交易</strong>。相反，<strong>这种交易格式的数据只是信标链的一部分</strong>，<strong>并由所有共识节点完全下载</strong>（但可以在相对较短的延迟后删除）。与完整数据分片相比，这个 EIP 减少了可以包含的交易数量上限，对应于每个区块约 0.25 MB 的目标和约 0.5 MB 的限制。</p><h1 id=三specification-规范>三、Specification 规范<a class=anchorjs-link href=#%e4%b8%89specification-%e8%a7%84%e8%8c%83></a></h1><h2 id=31-parameters-参数>3.1 Parameters 参数<a class=anchorjs-link href=#31-parameters-%e5%8f%82%e6%95%b0></a></h2><table><thead><tr><th>Constant - 常量</th><th>Value</th></tr></thead><tbody><tr><td>BLOB_TX_TYPE</td><td>Bytes1(0x05)</td></tr><tr><td>FIELD_ELEMENTS_PER_BLOB</td><td>4096</td></tr><tr><td>BLS_MODULUS</td><td>52435875175126190479447740508185965837690552500527637822603658699938581184513</td></tr><tr><td>BLOB_COMMITMENT_VERSION_KZG</td><td>Bytes1(0x01)</td></tr><tr><td>POINT_EVALUATION_PRECOMPILE_ADDRESS</td><td>Bytes20(0x14)</td></tr><tr><td>POINT_EVALUATION_PRECOMPILE_GAS</td><td>50000</td></tr><tr><td>MAX_DATA_GAS_PER_BLOCK</td><td>2**19</td></tr><tr><td>TARGET_DATA_GAS_PER_BLOCK</td><td>2**18</td></tr><tr><td>MIN_DATA_GASPRICE</td><td>1</td></tr><tr><td>DATA_GASPRICE_UPDATE_FRACTION</td><td>2225652</td></tr><tr><td>MAX_VERSIONED_HASHES_LIST_SIZE</td><td>2**24</td></tr><tr><td>MAX_CALLDATA_SIZE</td><td>2**24</td></tr><tr><td>MAX_ACCESS_LIST_SIZE</td><td>2**24</td></tr><tr><td>MAX_ACCESS_LIST_STORAGE_KEYS</td><td>2**24</td></tr><tr><td>MAX_TX_WRAP_KZG_COMMITMENTS</td><td>2**12</td></tr><tr><td>LIMIT_BLOBS_PER_TX</td><td>2**12</td></tr><tr><td>DATA_GAS_PER_BLOB</td><td>2**17</td></tr><tr><td>HASH_OPCODE_BYTE</td><td>Bytes1(0x49)</td></tr><tr><td>HASH_OPCODE_GAS</td><td>3</td></tr></tbody></table><h2 id=32-type-aliases-类型别名>3.2 Type aliases 类型别名<a class=anchorjs-link href=#32-type-aliases-%e7%b1%bb%e5%9e%8b%e5%88%ab%e5%90%8d></a></h2><table><thead><tr><th>Type</th><th>Base type 底座型</th><th>Additional checks 额外检查</th></tr></thead><tbody><tr><td>BLSFieldElement</td><td>uint256</td><td>x &lt; BLS_MODULUS</td></tr><tr><td>Blob</td><td>Vector[BLSFieldElement, FIELD_ELEMENTS_PER_BLOB]</td><td></td></tr><tr><td>VersionedHash</td><td>Bytes32</td><td></td></tr><tr><td>KZGCommitment</td><td>Bytes48</td><td>Same as BLS standard “is valid pubkey” check but also allows 0x00..00 for point-at-infinity 与 BLS 标准“是有效公钥”检查相同，但也允许 0x00..00 用于无穷远点</td></tr><tr><td>KZGProof</td><td>Bytes48</td><td>Same as for KZGCommitment与 KZGCommitment 相同</td></tr></tbody></table><h2 id=33-cryptographic-helpers-加密助手>3.3 Cryptographic Helpers 加密助手<a class=anchorjs-link href=#33-cryptographic-helpers-%e5%8a%a0%e5%af%86%e5%8a%a9%e6%89%8b></a></h2><p>在整个提案中，我们使用相应的共识 4844 规范中定义的加密方法和类。具体来说，我们使用来自 <code>polynomial-commitments.md</code> 的以下方法：</p><ul><li><a href=https://github.com/ethereum/consensus-specs/blob/23d3aeebba3b5da0df4bd25108461b442199f406/specs/eip4844/polynomial-commitments.md#verify_kzg_proof target=_blank>verify_kzg_proof()</a></li><li><a href=https://github.com/ethereum/consensus-specs/blob/23d3aeebba3b5da0df4bd25108461b442199f406/specs/eip4844/polynomial-commitments.md#verify_aggregate_kzg_proof target=_blank>verify_aggregate_kzg_proof()</a></li></ul><h2 id=34-helpers>3.4 Helpers<a class=anchorjs-link href=#34-helpers></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>def kzg_to_versioned_hash(kzg<span style=color:#ff79c6>:</span> KZGCommitment) <span style=color:#ff79c6>-&gt;</span> VersionedHash<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> BLOB_COMMITMENT_VERSION_KZG <span style=color:#ff79c6>+</span> <span style=color:#8be9fd;font-style:italic>sha256</span>(kzg)[<span style=color:#bd93f9>1</span><span style=color:#ff79c6>:</span>]
</span></span></code></pre></div><p>使用泰勒展开逼近 <code>factor * e ** (numerator / denominator)</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>def fake_exponential(factor<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>int</span>, numerator<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>int</span>, denominator<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>int</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    output <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    numerator_accum <span style=color:#ff79c6>=</span> factor <span style=color:#ff79c6>*</span> denominator
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>while</span> numerator_accum <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        output <span style=color:#ff79c6>+=</span> numerator_accum
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>        numerator_accum <span style=color:#ff79c6>=</span> (numerator_accum <span style=color:#ff79c6>*</span> numerator) <span style=color:#6272a4>// (denominator * i)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#6272a4></span>        i <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>    <span style=color:#ff79c6>return</span> output <span style=color:#6272a4>// denominator
</span></span></span></code></pre></div><h2 id=35-new-transaction-type-新的交易类型>3.5 New transaction type 新的交易类型<a class=anchorjs-link href=#35-new-transaction-type-%e6%96%b0%e7%9a%84%e4%ba%a4%e6%98%93%e7%b1%bb%e5%9e%8b></a></h2><p>我们引入了一种新的 EIP-2718 交易类型，格式为单字节 <code>BLOB_TX_TYPE</code>后跟包含交易内容的 <code>SignedBlobTransaction</code>容器的 SSZ 编码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>class SignedBlobTransaction(Container)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    message<span style=color:#ff79c6>:</span> BlobTransaction
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    signature<span style=color:#ff79c6>:</span> ECDSASignature
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>class BlobTransaction(Container)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    chain_id<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    nonce<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint64</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    max_priority_fee_per_gas<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    max_fee_per_gas<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd;font-style:italic>gas</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint64</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    to<span style=color:#ff79c6>:</span> Union[None, Address] # Address <span style=color:#ff79c6>=</span> Bytes20
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd;font-style:italic>value</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd;font-style:italic>data</span><span style=color:#ff79c6>:</span> ByteList[MAX_CALLDATA_SIZE]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    access_list<span style=color:#ff79c6>:</span> List[AccessTuple, MAX_ACCESS_LIST_SIZE]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    max_fee_per_data_gas<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    blob_versioned_hashes<span style=color:#ff79c6>:</span> List[VersionedHash, MAX_VERSIONED_HASHES_LIST_SIZE]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>class AccessTuple(Container)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#8be9fd>address</span><span style=color:#ff79c6>:</span> Address # Bytes20
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    storage_keys<span style=color:#ff79c6>:</span> List[Hash, MAX_ACCESS_LIST_STORAGE_KEYS]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>class ECDSASignature(Container)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    y_parity<span style=color:#ff79c6>:</span> boolean
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    r<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    s<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>uint256</span>
</span></span></code></pre></div><p><code>max_priority_fee_per_gas</code>和 <code>max_fee_per_gas</code>字段遵循 EIP-1559 语义， <code>access_list</code>与 <code>EIP-2930</code>相同。</p><p><code>EIP-2718</code>使用“包装数据”进行扩展，类型化的交易可以根据上下文以两种形式编码：</p><ul><li>Network (default): <code>TransactionType || TransactionNetworkPayload</code>或 <code>LegacyTransaction</code></li><li>Minimal (as in execution payload):<code>TransactionType || TransactionPayload</code>或 <code>LegacyTransaction</code></li></ul><p>执行负载/块使用交易的最小编码。在交易池和本地交易日志中使用网络编码。
对于以前类型的交易，网络编码没有什么不同，即 <code>TransactionNetworkPayload == TransactionPayload</code>。
<code>TransactionNetworkPayload</code>用附加数据包装 <code>TransactionPayload</code>：应该在签名验证之前或之后直接验证此包装数据。</p><p>当 blob 事务通过网络传递时（请参阅下面的网络部分），事务的 <code>TransactionNetworkPayload</code>
 版本还包括 <code>blobs</code>和 <code>kzgs</code>（承诺列表）。执行层在签名验证后针对部 <code>TransactionPayload</code>验证包装器有效性：</p><ul><li><code>blob_versioned_hashes</code>中的所有哈希必须以字节 <code>BLOB_COMMITMENT_VERSION_KZG</code>开头</li><li>一个有效块中最多可能有 <code>MAX_DATA_GAS_PER_BLOCK // DATA_GAS_PER_BLOB</code>总 blob 承诺。</li><li>有等量的版本化哈希、kzg 承诺和 blob。</li><li>KZG 承诺哈希到版本哈希，即 <code>kzg_to_versioned_hash(kzg[i]) == versioned_hash[i]</code></li><li>KZG 承诺与 blob 内容相匹配。 （注意：这可以通过附加数据进行优化，使用从承诺和 blob 数据派生的两个点进行随机评估的证明）</li></ul><p>签名被验证并且 <code>tx.origin</code>被计算如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>def unsigned_tx_hash(<span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction) <span style=color:#ff79c6>-&gt;</span> Bytes32<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    # The pre<span style=color:#ff79c6>-</span>image <span style=color:#ff79c6>is</span> prefixed with the transaction<span style=color:#ff79c6>-</span>type to avoid hash collisions with other <span style=color:#8be9fd;font-style:italic>tx</span> hashers and types
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>keccak256</span>(BLOB_TX_TYPE <span style=color:#ff79c6>+</span> ssz.serialize(<span style=color:#8be9fd;font-style:italic>tx</span>.message))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>def get_origin(<span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction) <span style=color:#ff79c6>-&gt;</span> Address<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    sig <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>tx</span>.signature
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    # v <span style=color:#ff79c6>=</span> <span style=color:#8be9fd>int</span>(y_parity) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>27</span>, same <span style=color:#ff79c6>as</span> EIP<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1559</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>ecrecover</span>(unsigned_tx_hash(<span style=color:#8be9fd;font-style:italic>tx</span>), <span style=color:#8be9fd>int</span>(sig.y_parity)<span style=color:#ff79c6>+</span><span style=color:#bd93f9>27</span>, sig.r, sig.s)
</span></span></code></pre></div><p>已签名的 blob 交易的哈希值应计算为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>def signed_tx_hash(<span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction) <span style=color:#ff79c6>-&gt;</span> Bytes32<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>keccak256</span>(BLOB_TX_TYPE <span style=color:#ff79c6>+</span> ssz.serialize(<span style=color:#8be9fd;font-style:italic>tx</span>))
</span></span></code></pre></div><h2 id=36-header-extension-头扩展>3.6 Header extension 头扩展<a class=anchorjs-link href=#36-header-extension-%e5%a4%b4%e6%89%a9%e5%b1%95></a></h2><p>当前标头编码使用新的 256 位无符号整数字段 <code>excess_data_gas</code>进行扩展。这是自此 EIP 激活以来链上消耗的过量数据气体的运行总量。如果数据气体总量低于目标， <code>excess_data_gas</code>上限为零。</p><p>因此，生成的标头 RLP 编码为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>rlp([
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    parent_hash,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#bd93f9>0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347</span>, # ommers hash
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd;font-style:italic>coinbase</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    state_root,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    txs_root,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    receipts_root,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    logs_bloom,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#bd93f9>0</span>, # <span style=color:#8be9fd;font-style:italic>difficulty</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#8be9fd;font-style:italic>number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    gas_limit,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    gas_used,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd;font-style:italic>timestamp</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    extradata,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    prev_randao,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#bd93f9>0x0000000000000000</span>, # nonce
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    base_fee_per_gas,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    withdrawals_root,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    excess_data_gas
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>])
</span></span></code></pre></div><p><code>excess_data_gas</code> 的值可以使用块中的父标头和 blob 数来计算。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>def calc_excess_data_gas(parent<span style=color:#ff79c6>:</span> Header, new_blobs<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>int</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    consumed_data_gas <span style=color:#ff79c6>=</span> new_blobs <span style=color:#ff79c6>*</span> DATA_GAS_PER_BLOB
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>if</span> parent.excess_data_gas <span style=color:#ff79c6>+</span> consumed_data_gas <span style=color:#ff79c6>&lt;</span> TARGET_DATA_GAS_PER_BLOCK<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>else</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        <span style=color:#ff79c6>return</span> parent.excess_data_gas <span style=color:#ff79c6>+</span> consumed_data_gas <span style=color:#ff79c6>-</span> TARGET_DATA_GAS_PER_BLOCK
</span></span></code></pre></div><p>对于第一个分叉后区块， <code>parent.excess_data_gas</code>被评估为 <code>0</code>。</p><h2 id=37-beacon-chain-validation信标链验证>3.7 Beacon chain validation 信标链验证<a class=anchorjs-link href=#37-beacon-chain-validation%e4%bf%a1%e6%a0%87%e9%93%be%e9%aa%8c%e8%af%81></a></h2><p>在共识层上，blob 现在在信标块主体中被引用，但未完全编码。不是将全部内容嵌入正文，而是将 blob 的内容单独传播，作为“<strong>sidecar</strong>”。</p><p>这种“边车”设计通过黑盒 <code>is_data_available()</code>为进一步增加的数据提供前向兼容性：完全分片 <code>is_data_available()</code>可以用数据可用性采样 (DAS) 代替，从而避免所有 blob 被网络上的所有信标节点下载网络。</p><p>请注意，共识层的任务是持久化数据可用性的 blob，而执行层则不是。
<code>ethereum/consensus-specs</code>存储库定义了此 EIP 中涉及的以下信标节点更改：</p><ul><li><strong>Beacon chain信标链</strong>：处理更新的信标块并确保 blob 可用。</li><li><strong>P2P 网络</strong>：Goosip和同步更新的信标块类型和新的 blob 边车。</li><li><strong>Honest validator 诚实验证器</strong>：使用 blob 生成信标块，发布 blob sidecars。</li></ul><h2 id=38-opcode-to-get-versioned-hashes-获取版本哈希的操作码>3.8 Opcode to get versioned hashes 获取版本哈希的操作码<a class=anchorjs-link href=#38-opcode-to-get-versioned-hashes-%e8%8e%b7%e5%8f%96%e7%89%88%e6%9c%ac%e5%93%88%e5%b8%8c%e7%9a%84%e6%93%8d%e4%bd%9c%e7%a0%81></a></h2><p>我们添加了一个操作码 <code>DATAHASH</code>（字节值为 <code>HASH_OPCODE_BYTE</code>），它从栈顶读取 <code>index</code>作为大端 <code>uint256</code>，如果是 <code>tx.message.blob_versioned_hashes[index]</code>则用 <code>index &lt; len(tx.message.blob_versioned_hashes)</code>替换它在栈上，并且否则使用归零的 <code>bytes32</code>值。操作码的 gas 成本为 <code>HASH_OPCODE_GAS</code>。</p><h2 id=39-point-evaluation-precompile点评估预编译>3.9 Point evaluation precompile 点评估预编译<a class=anchorjs-link href=#39-point-evaluation-precompile%e7%82%b9%e8%af%84%e4%bc%b0%e9%a2%84%e7%bc%96%e8%af%91></a></h2><p>在 <code>POINT_EVALUATION_PRECOMPILE_ADDRESS</code> 添加预编译，用于验证 KZG 证明，该证明声称blob（由承诺表示）在给定点计算为给定值。</p><p>预编译花费 <code>POINT_EVALUATION_PRECOMPILE_GAS</code>并执行以下逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>def point_evaluation_precompile(input<span style=color:#ff79c6>:</span> Bytes) <span style=color:#ff79c6>-&gt;</span> Bytes<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Verify p(z) <span style=color:#ff79c6>=</span> y given commitment that corresponds to the polynomial p(x) and a KZG proof.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Also verify that the provided commitment matches the provided versioned_hash.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    # The <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>is</span> encoded <span style=color:#ff79c6>as</span> follows<span style=color:#ff79c6>:</span> versioned_hash <span style=color:#ff79c6>|</span> z <span style=color:#ff79c6>|</span> y <span style=color:#ff79c6>|</span> commitment <span style=color:#ff79c6>|</span> proof <span style=color:#ff79c6>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    versioned_hash <span style=color:#ff79c6>=</span> input[<span style=color:#ff79c6>:</span><span style=color:#bd93f9>32</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    z <span style=color:#ff79c6>=</span> input[<span style=color:#bd93f9>32</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>64</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    y <span style=color:#ff79c6>=</span> input[<span style=color:#bd93f9>64</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>96</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    commitment <span style=color:#ff79c6>=</span> input[<span style=color:#bd93f9>96</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>144</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    kzg_proof <span style=color:#ff79c6>=</span> input[<span style=color:#bd93f9>144</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>192</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    # Verify commitment matches versioned_hash
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#8be9fd;font-style:italic>assert</span> kzg_to_versioned_hash(commitment) <span style=color:#ff79c6>==</span> versioned_hash
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    # Verify KZG proof
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#8be9fd;font-style:italic>assert</span> verify_kzg_proof(commitment, z, y, kzg_proof)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    # Return FIELD_ELEMENTS_PER_BLOB and BLS_MODULUS <span style=color:#ff79c6>as</span> padded <span style=color:#bd93f9>32</span> <span style=color:#8be9fd>byte</span> big endian values
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>return</span> Bytes(U256(FIELD_ELEMENTS_PER_BLOB).to_be_bytes32() <span style=color:#ff79c6>+</span> U256(BLS_MODULUS).to_be_bytes32())
</span></span></code></pre></div><p>预编译必须拒绝非规范的字段元素（即提供的字段元素必须严格小于 <code>BLS_MODULUS</code>）。</p><h2 id=310--gas-accounting>3.10 Gas accounting<a class=anchorjs-link href=#310--gas-accounting></a></h2><p>我们将数据气体作为一种新型气体引入。它独立于普通气体并遵循自己的目标规则，类似于 EIP-1559。我们使用 <code>excess_data_gas</code>标头字段来存储计算数据 gas 价格所需的持久数据。目前，只有 blob 以数据 gas 计价。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>def calc_data_fee(<span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction, parent<span style=color:#ff79c6>:</span> Header) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>return</span> get_total_data_gas(<span style=color:#8be9fd;font-style:italic>tx</span>) <span style=color:#ff79c6>*</span> get_data_gasprice(header)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>def get_total_data_gas(<span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>return</span> DATA_GAS_PER_BLOB <span style=color:#ff79c6>*</span> len(<span style=color:#8be9fd;font-style:italic>tx</span>.message.blob_versioned_hashes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>def get_data_gasprice(header<span style=color:#ff79c6>:</span> Header) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>return</span> fake_exponential(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        MIN_DATA_GASPRICE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        header.excess_data_gas,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        DATA_GASPRICE_UPDATE_FRACTION
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    )
</span></span></code></pre></div><p>区块有效性条件被修改为包括数据气体检查：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>def validate_block(<span style=color:#8be9fd;font-style:italic>block</span><span style=color:#ff79c6>:</span> Block) <span style=color:#ff79c6>-&gt;</span> None<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#8be9fd;font-style:italic>tx</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>block</span>.transactions<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        # the signer must be able to afford the transaction
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#8be9fd;font-style:italic>assert</span> signer(<span style=color:#8be9fd;font-style:italic>tx</span>).<span style=color:#8be9fd;font-style:italic>balance</span> <span style=color:#ff79c6>&gt;=</span> <span style=color:#8be9fd;font-style:italic>tx</span>.message.<span style=color:#8be9fd;font-style:italic>gas</span> <span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>tx</span>.message.max_fee_per_gas <span style=color:#ff79c6>+</span> get_total_data_gas(<span style=color:#8be9fd;font-style:italic>tx</span>) <span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>tx</span>.message.max_fee_per_data_gas
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        # ensure that the user was willing to at least pay the current <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#8be9fd;font-style:italic>gasprice</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#8be9fd;font-style:italic>assert</span> <span style=color:#8be9fd;font-style:italic>tx</span>.message.max_fee_per_data_gas <span style=color:#ff79c6>&gt;=</span> get_data_gasprice(parent(<span style=color:#8be9fd;font-style:italic>block</span>).header)
</span></span></code></pre></div><p>通过 <code>data_fee</code>计算的实际 <code>calc_data_fee</code>在交易执行前从发送方余额中扣除并销毁，并且在交易失败的情况下不予退还。</p><h2 id=311-networking网络>3.11 Networking 网络<a class=anchorjs-link href=#311-networking%e7%bd%91%e7%bb%9c></a></h2><p>节点不得自动向其对等节点广播 blob 事务。相反，这些交易仅使用 <code>NewPooledTransactionHashes</code>消息公布，然后可以通过 <code>GetPooledTransactions</code>手动请求。</p><p>交易在执行层网络上显示为 <code>TransactionType || TransactionNetworkPayload</code>，有效负载是一个 SSZ 编码的容器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>class BlobTransactionNetworkWrapper(Container)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#8be9fd;font-style:italic>tx</span><span style=color:#ff79c6>:</span> SignedBlobTransaction
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    # KZGCommitment <span style=color:#ff79c6>=</span> Bytes48
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    blob_kzgs<span style=color:#ff79c6>:</span> List[KZGCommitment, MAX_TX_WRAP_KZG_COMMITMENTS]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    # BLSFieldElement <span style=color:#ff79c6>=</span> <span style=color:#8be9fd>uint256</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    blobs<span style=color:#ff79c6>:</span> List[Vector[BLSFieldElement, FIELD_ELEMENTS_PER_BLOB], LIMIT_BLOBS_PER_TX]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    # KZGProof <span style=color:#ff79c6>=</span> Bytes48
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    kzg_aggregated_proof<span style=color:#ff79c6>:</span> KZGProof
</span></span></code></pre></div><p>我们对 <code>BlobTransactionNetworkWrapper</code>对象进行网络级验证，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>def validate_blob_transaction_wrapper(wrapper<span style=color:#ff79c6>:</span> BlobTransactionNetworkWrapper)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    versioned_hashes <span style=color:#ff79c6>=</span> wrapper.<span style=color:#8be9fd;font-style:italic>tx</span>.message.blob_versioned_hashes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    commitments <span style=color:#ff79c6>=</span> wrapper.blob_kzgs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    blobs <span style=color:#ff79c6>=</span> wrapper.blobs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    # note<span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>assert</span> blobs are not malformatted
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd;font-style:italic>assert</span> len(versioned_hashes) <span style=color:#ff79c6>==</span> len(commitments) <span style=color:#ff79c6>==</span> len(blobs)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    # Verify that commitments <span style=color:#ff79c6>match</span> the blobs by checking the KZG proof
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#8be9fd;font-style:italic>assert</span> verify_aggregate_kzg_proof(blobs, commitments, wrapper.kzg_aggregated_proof)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    # Now that all commitments have been verified, check that versioned_hashes matches the commitments
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>for</span> versioned_hash, commitment <span style=color:#ff79c6>in</span> zip(versioned_hashes, commitments)<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#8be9fd;font-style:italic>assert</span> versioned_hash <span style=color:#ff79c6>==</span> kzg_to_versioned_hash(commitment)
</span></span></code></pre></div><h1 id=四基本原理>四、基本原理<a class=anchorjs-link href=#%e5%9b%9b%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86></a></h1><h2 id=41-on-the-path-to-sharding在分片的路上>4.1 On the path to sharding 在分片的路上<a class=anchorjs-link href=#41-on-the-path-to-sharding%e5%9c%a8%e5%88%86%e7%89%87%e7%9a%84%e8%b7%af%e4%b8%8a></a></h2><p>该 EIP 引入了 blob 事务，其格式与最终分片规范中预期存在的格式相同。通过允许它们最初扩展到每个槽 0.25 MB，这为汇总提供了一个临时但显着的扩展缓解，一个单独的费用市场允许费用非常低，同时该系统的使用受到限制。</p><p>rollup 缩放权宜之计的核心目标是提供临时的缩放缓解，而不会给 rollup 施加额外的开发负担以利用这种缓解。今天，汇总使用调用数据。将来，rollup 将别无选择，只能使用分片数据（也称为“blob”），因为分片数据会便宜得多。因此，rollups 不可避免地要对其处理数据的方式进行一次大升级。但我们能做的是确保 rollups 只需要升级一次。这立即意味着有两种可能的权宜之计：（i）降低现有调用数据的 gas 成本，以及（ii）提出将用于分片数据但尚未实际分片的格式。之前的EIP都是第(i)类的解决方案；该 EIP 是类别 (ii) 的解决方案。</p><p>设计这个 EIP 的主要权衡是现在实施更多与以后必须实施更多：我们是在实现完全分片的过程中实施 25% 的工作，还是 50%，还是 75%？</p><p>该 EIP 中已经完成的工作包括：</p><ul><li>一种新的交易类型，其格式完全相同，需要存在于“全分片”中</li><li>全分片所需的所有执行层逻辑</li><li>全分片所需的所有执行/共识交叉验证逻辑</li><li><code>BeaconBlock</code>验证和数据可用性采样 blob 之间的层分离</li><li>完全分片所需的大部分 <code>BeaconBlock</code>逻辑</li><li>blob 的自我调整的独立 gasprice</li></ul><p>要实现完全分片，还有待完成的工作包括：</p><ul><li>共识层 <code>blob_kzgs</code>的低度扩展，允许二维采样</li><li>数据可用性采样的实际实现</li><li>PBS（提议者/构建者分离），以避免要求单个验证者在一个时隙中处理 32 MB 的数据</li><li>每个验证器的保管证明或类似的协议内要求，以验证每个块中分片数据的特定部分</li></ul><p>该 EIP 还为长期协议清理奠定了基础：</p><ul><li>新增SSZ交易类型，开创了所有新交易类型都应该是SSZ的先例</li><li>它定义了 <code>TransactionNetworkPayload</code>来分隔交易类型的网络和块编码</li><li>它的（更清洁的）gas 价格更新规则可以应用于主要基本费用</li></ul><h2 id=42-how-rollups-would-function>4.2 How rollups would function<a class=anchorjs-link href=#42-how-rollups-would-function></a></h2><p>rollups 不是将 rollup 块数据放在交易调用数据中，而是希望 rollup 块提交者将数据放入 blob 中。这保证了可用性（这是 rollup 所需要的），但比 calldata 便宜得多。汇总需要数据一次可用，足够长以确保诚实的参与者可以构建汇总状态，但不是永远可用。</p><p>Optimistic rollups 只需要在提交欺诈证明时实际提供基础数据。<strong>欺诈证明</strong>可以以更小的步骤验证转换，通过 calldata 一次最多加载 blob 的几个值。对于每个值，它将提供一个 KZG 证明，并使用点评估预编译来根据之前提交的版本化哈希验证该值，然后像今天一样对该数据执行欺诈证明验证。</p><p>ZK rollups将为其交易或状态增量数据提供两个承诺：blob 中的 kzg 和使用 ZK 汇总内部使用的任何证明系统的一些承诺。他们将使用等价协议的承诺证明，使用点评估预编译来证明 kzg（协议确保指向可用数据）和 ZK rollup 自己的承诺引用相同的数据。</p><h2 id=43-versioned-hashes--precompile-return-data-版本化哈希和预编译返回数据>4.3 Versioned hashes & precompile return data  版本化哈希和预编译返回数据<a class=anchorjs-link href=#43-versioned-hashes--precompile-return-data-%e7%89%88%e6%9c%ac%e5%8c%96%e5%93%88%e5%b8%8c%e5%92%8c%e9%a2%84%e7%bc%96%e8%af%91%e8%bf%94%e5%9b%9e%e6%95%b0%e6%8d%ae></a></h2><p>我们使用<strong>版本化哈希</strong>（而不是 kzgs）作为对执行层中 blob 的引用，以确保与未来更改的向前兼容性。例如，如果我们<strong>出于量子安全原因需要切换到 Merkle 树 + STARKs</strong>，那么我们将添加一个新版本，允许点评估预编译使用新格式。 Rollup 不必对其工作方式进行任何 EVM 级别的更改；排序者只需要在适当的时候切换到使用新的交易类型。</p><p>但是，点评估发生在有限域内，并且只有在场模已知的情况下才能明确定义。智能合约可以包含一个将承诺版本映射到模数的表，但这不允许智能合约考虑未来对未知模数的升级。通过允许访问 EVM 内部的模数，可以构建智能合约，以便它可以使用未来的承诺和证明，而无需升级。</p><p>为了不添加另一个预编译，我们直接从点评估预编译返回模数和多项式次数。然后它可以被调用者使用。它也是“免费”的，因为调用者可以忽略这部分返回值而不会产生额外成本——在可预见的未来保持可升级的系统现在可能会使用这条路线。</p><h2 id=44-data-gasprice-update-rule-数据-gasprice-更新规则>4.4 Data gasprice update rule 数据 gasprice 更新规则<a class=anchorjs-link href=#44-data-gasprice-update-rule-%e6%95%b0%e6%8d%ae-gasprice-%e6%9b%b4%e6%96%b0%e8%a7%84%e5%88%99></a></h2><p>数据 gasprice 更新规则旨在近似公式 <code>data_gasprice = MIN_DATA_GASPRICE * e**(excess_data_gas / DATA_GASPRICE_UPDATE_FRACTION)</code> ，其中 <code>excess_data_gas</code>是该链相对于“目标”数量（每个块 <code>TARGET_DATA_GAS_PER_BLOCK</code>）消耗的数据 gas 总量的“额外”量。与EIP-1559 一样，它是一个自我修正的公式：随着超额增加， <code>data_gasprice</code>呈指数增长，减少使用并最终迫使超额回落。</p><p>逐块行为大致如下。如果 <code>N</code>块消耗 <code>X</code>数据gas，那么在 <code>N+1</code>块中 <code>excess_data_gas</code>增加 <code>X -TARGET_DATA_GAS_PER_BLOCK</code> ，所以 <code>data_gasprice</code>块的 <code>N+1</code>增加 <code>e**((X - TARGET_DATA_GAS_PER_BLOCK) / DATA_GASPRICE_UPDATE_FRACTION)</code> 。因此，它与现有的 EIP-1559 具有相似的效果，但在某种意义上更“稳定”，因为无论其分布如何，它都以相同的方式响应相同的总使用量。</p><p>参数 <code>DATA_GASPRICE_UPDATE_FRACTION</code>控制 blob gas 价格的最大变化率。选择它的目标是每个块 <code>e(TARGET_DATA_GAS_PER_BLOCK / DATA_GASPRICE_UPDATE_FRACTION) ≈ 1.125</code>的最大更改率。</p><h2 id=45-吞吐量>4.5 吞吐量<a class=anchorjs-link href=#45-%e5%90%9e%e5%90%90%e9%87%8f></a></h2><p>选择 <code>TARGET_DATA_GAS_PER_BLOCK</code>和 <code>MAX_DATA_GAS_PER_BLOCK</code>的值对应于每个块 2 个 blob (0.25 MB) 和最多 4 个 blob (0.5 MB) 的目标。这些小的初始限制旨在最大程度地减少此 EIP 对网络造成的压力，并且随着网络在更大的块下展示可靠性，预计在未来的升级中会增加。</p><h1 id=五backwards-compatibility向后兼容>五、Backwards Compatibility    向后兼容<a class=anchorjs-link href=#%e4%ba%94backwards-compatibility%e5%90%91%e5%90%8e%e5%85%bc%e5%ae%b9></a></h1><h2 id=51-blob-non-accessibilityblob-不可访问>5.1 Blob non-accessibility    Blob 不可访问<a class=anchorjs-link href=#51-blob-non-accessibilityblob-%e4%b8%8d%e5%8f%af%e8%ae%bf%e9%97%ae></a></h2><p>该 EIP 引入了一种交易类型，它具有不同的内存池版本 ( <code>BlobTransactionNetworkWrapper</code> ) 和执行负载版本 ( <code>SignedBlobTransaction</code> )，两者之间只能进行单向转换。 blob 在 <code>BlobTransactionNetworkWrapper</code> 中而不是在 <code>SignedBlobTransaction</code> 中；相反，他们进入了 <code>BeaconBlockBody</code> 。这意味着现在有一部分交易无法从 web3 API 访问。</p><h1 id=六mempool-issues内存池问题>六、Mempool issues    内存池问题<a class=anchorjs-link href=#%e5%85%admempool-issues%e5%86%85%e5%ad%98%e6%b1%a0%e9%97%ae%e9%a2%98></a></h1><p>Blob 交易在 mempool 层具有较大的数据大小，这会带来 mempool DoS 风险，尽管这并不是前所未有的风险，因为这也适用于具有大量 calldata 的交易。</p><p>通过只广播 blob 交易的公告，接收节点将可以控制接收哪些交易和接收多少交易，从而允许它们将吞吐量限制在可接受的水平。 EIP-5793 将通过扩展 <code>NewPooledTransactionHashes</code>公告消息以包括交易类型和大小来进一步细粒度地控制节点。</p><p>此外，我们建议在 mempool 交易替换规则中包含 1.1 倍的数据 gasprice 涨幅要求。</p><h1 id=七test-cases测试用例>七、Test Cases    测试用例<a class=anchorjs-link href=#%e4%b8%83test-cases%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b></a></h1><p>待定</p><h1 id=八security-considerations安全考虑>八、Security Considerations    安全考虑<a class=anchorjs-link href=#%e5%85%absecurity-considerations%e5%ae%89%e5%85%a8%e8%80%83%e8%99%91></a></h1><p>该 EIP 最多将每个信标块的存储要求增加约 0.5 MB。这比今天区块的理论最大大小大 4 倍（30M gas / 每个调用数据字节 16 gas = 1.875M 字节），因此它不会大大增加最坏情况下的带宽。合并后，块时间预计是静态的，而不是不可预测的泊松分布，从而为大块的传播提供了保证的时间段。</p><p>这个 EIP 的持续负载远低于降低调用数据成本的替代方案，即使调用数据是有限的，因为没有现有的软件可以无限期地存储 blob，并且不期望它们需要存储多长时间执行负载。这使得更容易实施一项政策，即这些斑点应该在例如之后被删除。 30-60 天，与建议的（但尚未实施）执行负载历史的一年轮换时间相比，延迟要短得多。</p><h1 id=九版权所有>九、版权所有<a class=anchorjs-link href=#%e4%b9%9d%e7%89%88%e6%9d%83%e6%89%80%e6%9c%89></a></h1><p>通过 <a href=https://eips.ethereum.org/LICENSE target=_blank>CC0</a> 放弃版权和相关权利。</p><h1 id=十citation引用>十、Citation 引用<a class=anchorjs-link href=#%e5%8d%81citation%e5%bc%95%e7%94%a8></a></h1><p>Vitalik Buterin ( <a href=https://github.com/vbuterin target=_blank>@vbuterin</a>)、Dankrad Feist ( <a href=https://github.com/dankrad target=_blank>@dankrad</a>)、Diederik Loerakker ( <a href=https://github.com/protolambda target=_blank>@protolambda</a>)、George Kadianakis ( <a href=https://github.com/asn-d6 target=_blank>@asn-d6</a>)、Matt Garnett ( <a href=https://github.com/lightclient target=_blank>@lightclient</a>)、Mofi Taiwo ( <a href=https://github.com/Inphi target=_blank>@Inphi</a>)、Ansgar Dietrichs ( <a href=https://github.com/adietrichs target=_blank>@adietrichs</a>)，“EIP-4844：分片 Blob 交易 [草案]，”以太坊改进提案，第 1 期。 4844，2022 年 2 月。[在线连载]。可用：https://eips.ethereum.org/EIPS/eip-4844。</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/icorer_blog/posts/web3/soulbound-tokens-vs-self-sovereign-identity/ data-toggle=tooltip data-placement=top title="SBT vs SSI：Web3对数字身份解决方案的探索">Previous<br><span>SBT vs SSI：Web3对数字身份解决方案的探索</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/icorer_blog/tags/blockchain/>blockchain</a>
<a href=/icorer_blog/tags/clang/>CLang</a>
<a href=/icorer_blog/tags/cloudnative/>cloudnative</a>
<a href=/icorer_blog/tags/cmake/>Cmake</a>
<a href=/icorer_blog/tags/deca/>DeCA</a>
<a href=/icorer_blog/tags/dpki/>DPKI</a>
<a href=/icorer_blog/tags/drand/>drand</a>
<a href=/icorer_blog/tags/eip/>EIP</a>
<a href=/icorer_blog/tags/epoll/>epoll</a>
<a href=/icorer_blog/tags/ethereum/>Ethereum</a>
<a href=/icorer_blog/tags/fpga/>FPGA</a>
<a href=/icorer_blog/tags/gc/>GC</a>
<a href=/icorer_blog/tags/golang/>GoLang</a>
<a href=/icorer_blog/tags/hackathon/>Hackathon</a>
<a href=/icorer_blog/tags/http2/>HTTP2</a>
<a href=/icorer_blog/tags/http3/>HTTP3</a>
<a href=/icorer_blog/tags/icefiredb/>IceFireDB</a>
<a href=/icorer_blog/tags/k8s/>k8s</a>
<a href=/icorer_blog/tags/kafka/>kafka</a>
<a href=/icorer_blog/tags/layer2/>Layer2</a>
<a href=/icorer_blog/tags/linux/>linux</a>
<a href=/icorer_blog/tags/nginx/>Nginx</a>
<a href=/icorer_blog/tags/nosql/>NoSQL</a>
<a href=/icorer_blog/tags/php/>PHP</a>
<a href=/icorer_blog/tags/php-kernel/>php kernel</a>
<a href=/icorer_blog/tags/php%E5%86%85%E6%A0%B8/>PHP内核</a>
<a href=/icorer_blog/tags/quic/>QUIC</a>
<a href=/icorer_blog/tags/redis/>redis</a>
<a href=/icorer_blog/tags/sbt/>SBT</a>
<a href=/icorer_blog/tags/serverless/>serverless</a>
<a href=/icorer_blog/tags/ssi/>SSI</a>
<a href=/icorer_blog/tags/unikernel/>unikernel</a>
<a href=/icorer_blog/tags/wanxiang/>Wanxiang</a>
<a href=/icorer_blog/tags/web3/>web3</a>
<a href=/icorer_blog/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/icorer_blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/>云原生</a>
<a href=/icorer_blog/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/>以太坊</a>
<a href=/icorer_blog/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>信息安全</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/>内存数据库</a>
<a href=/icorer_blog/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/>内存泄漏</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81/>内核源码</a>
<a href=/icorer_blog/tags/%E5%86%85%E6%A0%B8%E7%A0%94%E7%A9%B6/>内核研究</a>
<a href=/icorer_blog/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/>区块链</a>
<a href=/icorer_blog/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>垃圾回收</a>
<a href=/icorer_blog/tags/%E5%AD%98%E5%82%A8/>存储</a>
<a href=/icorer_blog/tags/%E5%AE%B9%E5%99%A8/>容器</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E5%BC%80%E5%8F%91/>底层开发</a>
<a href=/icorer_blog/tags/%E5%BA%95%E5%B1%82%E7%A0%94%E7%A9%B6/>底层研究</a>
<a href=/icorer_blog/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/>开源项目</a>
<a href=/icorer_blog/tags/%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97/>异构计算</a>
<a href=/icorer_blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>微服务</a>
<a href=/icorer_blog/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/>性能测试</a>
<a href=/icorer_blog/tags/%E6%8A%80%E6%9C%AF%E7%A7%91%E6%99%AE/>技术科普</a>
<a href=/icorer_blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/>数据库技术</a>
<a href=/icorer_blog/tags/%E6%96%87%E7%AB%A0%E7%BF%BB%E8%AF%91/>文章翻译</a>
<a href=/icorer_blog/tags/%E6%96%B0%E6%9E%B6%E6%9E%84/>新架构</a>
<a href=/icorer_blog/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/>时序数据库</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/>服务治理</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/>服务网格</a>
<a href=/icorer_blog/tags/%E6%9C%8D%E5%8A%A1%E9%81%A5%E6%B5%8B/>服务遥测</a>
<a href=/icorer_blog/tags/%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A/>测试报告</a>
<a href=/icorer_blog/tags/%E7%A0%94%E7%A9%B6%E6%8A%A5%E5%91%8A/>研究报告</a>
<a href=/icorer_blog/tags/%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF/>缓存技术</a>
<a href=/icorer_blog/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a>
<a href=/icorer_blog/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/>虚拟机</a>
<a href=/icorer_blog/tags/%E8%A1%8C%E4%B8%9A%E6%8A%A5%E5%91%8A/>行业报告</a>
<a href=/icorer_blog/tags/%E8%AE%BA%E6%96%87/>论文</a>
<a href=/icorer_blog/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB/>零信任</a>
<a href=/icorer_blog/tags/%E9%AB%98%E6%80%A7%E8%83%BD/>高性能</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=/icorer_blog/index.xml><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/corerman1><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/gitsrc><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 笔迹-工匠之芯 2023</p></div></div></div></footer><script src=/icorer_blog/js/jquery.min.js></script>
<script src=/icorer_blog/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/icorer_blog/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/icorer_blog/js/simple-jekyll-search.min.js></script>
<script src=/icorer_blog/js/search.min.7d1445cf07369bca2715d9f63738c16c73a7a2273a95d6729bee561f7e84c6c8.js></script>
<script src=/icorer_blog/zoomjs/zoom.min.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB37D8LWFT"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VB37D8LWFT")</script></body></html>